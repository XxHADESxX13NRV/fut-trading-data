<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>FUT Trading Elite Pro | ULTIMATE</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700;900&display=swap');
        * { font-family: 'Inter', system-ui, -apple-system, sans-serif; scroll-behavior: smooth; }
        body { background: radial-gradient(ellipse 1400px 800px at 10% 20%, rgba(99,102,241,0.2), transparent 70%), radial-gradient(ellipse 1200px 700px at 90% 10%, rgba(236,72,153,0.2), transparent 70%), radial-gradient(ellipse 1000px 600px at 50% 90%, rgba(14,165,233,0.15), transparent 70%), linear-gradient(135deg, #0a0e27 0%, #111827 45%, #0b1220 100%); color: #e5e7eb; min-height: 100vh; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        .glass-card { background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.12); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); }
        .neon-border { position: relative; overflow: hidden; }
        .neon-border::before { content: ""; position: absolute; inset: -2px; border-radius: 16px; padding: 2px; background: linear-gradient(135deg, rgba(99,102,241,0.7), rgba(236,72,153,0.7), rgba(14,165,233,0.7)); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; opacity: 0.6; }
        .neon-border:hover::before { opacity: 1; animation: neonPulse 2s ease-in-out infinite; }
        @keyframes neonPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .gradient-text { background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 50%, #22d3ee 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .tab-button { padding: 0.8rem 1.2rem; border-radius: 12px; background: rgba(31, 41, 55, 0.9); color: #c7d2fe; font-weight: 700; border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.3s ease; }
        .tab-button.active { background: linear-gradient(135deg, #6366f1, #a855f7, #ec4899); color: #fff; box-shadow: 0 15px 35px -10px rgba(168, 85, 247, 0.5); }
        .stat-badge { display: inline-flex; align-items: center; padding: 0.3rem 0.7rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 800; border: 1px solid rgba(148, 163, 184, 0.4); background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2)); }
        .form-input { background: rgba(2, 6, 23, 0.7); border: 1px solid rgba(148, 163, 184, 0.3); color: #fff; padding: 0.75rem 1rem; border-radius: 12px; width: 100%; }
        .card-type-badge { display: inline-block; padding: 3px 10px; border-radius: 8px; font-size: 10px; font-weight: 900; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.3); }
        .ct-gold { background: linear-gradient(135deg, #ffd700, #ffb400); color: #000; }
        .ct-totw { background: #000000; color: #ffd700; border-color: #ffd700; }
        .ct-icon { background: linear-gradient(135deg, #fff, #ffe08a); color: #111; }
        .ct-hero { background: linear-gradient(135deg, #4c1d95, #7c3aed); color: #ffe08a; }
        .pack-badge { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 900; text-transform: uppercase; border: 1px solid; }
        .pack-in { background: linear-gradient(135deg, #10b981, #059669); color: #fff; border-color: #34d399; }
        .pack-out { background: linear-gradient(135deg, #f59e0b, #d97706); color: #000; border-color: #fbbf24; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(12px); display: flex; align-items: center; justify-content: center; z-index: 50; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .playstyle-tag { display: inline-block; padding: 3px 10px; margin: 3px; border-radius: 8px; border: 1px solid rgba(125, 211, 252, 0.4); background: rgba(14, 165, 233, 0.2); font-size: 12px; }
        .playstyle-plus { background: linear-gradient(135deg, #ffd700, #ffb400); color: #111; border-color: #f59e0b; font-weight: 800; }
        .row-hover:hover { background: rgba(99, 102, 241, 0.12); }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, rgba(99, 102, 241, 0.6), rgba(168, 85, 247, 0.6)); border-radius: 10px; }
        table { border-collapse: separate; border-spacing: 0; }
        table thead { background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95)); position: sticky; top: 0; z-index: 10; }
        table th { padding: 1rem; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; border-bottom: 2px solid rgba(99, 102, 241, 0.5); }
        table td { padding: 0.875rem 1rem; }
        .section-header { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2)); border-left: 4px solid #8b5cf6; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem; }
        .dynamic-header { background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(236, 72, 153, 0.15)); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; }
        .platform-switch button.active { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; }
        .premium-lock-overlay { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 4rem 2rem; text-align: center; border: 2px solid rgba(255, 215, 0, 0.3); }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .animate-slideIn {
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        const API_URL = '/.netlify/functions';
        
        /* ===== FULL WORLD DATA ===== */
        const LEAGUES_DATA = [ 'Premier League', 'LaLiga Santander', 'Serie A TIM', 'Bundesliga', 'Ligue 1 Uber Eats', 'Eredivisie', 'Liga Portugal', 'Pro League', 'Scottish Premiership', 'Super Lig', 'Championship', 'Serie B', 'La Liga 2', 'Bundesliga 2', 'Ligue 2', 'MLS', 'Liga MX', 'Copa Libertadores', 'Copa Sudamericana', 'Brasileir√£o', 'Argentina Primera Divisi√≥n', 'Saudi Pro League' ];
        const NATIONS_DATA = [ 'France', 'Brazil', 'England', 'Spain', 'Germany', 'Netherlands', 'Portugal', 'Argentina', 'Italy', 'Belgium', 'Croatia', 'Uruguay', 'Colombia', 'Morocco', 'Senegal', 'Nigeria', 'United States', 'Mexico', 'Canada', 'Norway', 'Sweden', 'Denmark', 'Poland', 'Austria', 'Switzerland' ];
        const CLUBS_DATA = [ 'Real Madrid', 'FC Barcelona', 'Atl√©tico de Madrid', 'Manchester United', 'Manchester City', 'Liverpool', 'Arsenal', 'Chelsea', 'Tottenham Hotspur', 'Paris Saint-Germain', 'Olympique de Marseille', 'AS Monaco', 'Olympique Lyonnais', 'FC Bayern M√ºnchen', 'Borussia Dortmund', 'RB Leipzig', 'Bayer 04 Leverkusen', 'Juventus', 'Inter', 'AC Milan', 'Napoli', 'AS Roma', 'SL Benfica', 'FC Porto', 'Sporting CP', 'Ajax', 'PSV', 'Feyenoord', 'Al-Nassr', 'Al-Hilal', 'Al-Ittihad', 'Inter Miami CF' ];

        /* ===== UTILS (VERSION COMPL√àTE ET CORRIG√âE) ===== */
        /* ===== KRONOS LEARNING SYSTEM - SYST√àME D'APPRENTISSAGE ===== */
const KronosMemory = {
    savePrediction: (user, platform, prediction) => {
        try {
            const key = `kronos_predictions_${user.email}_${platform}`;
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            
            const newPrediction = {
                id: Date.now(),
                timestamp: Date.now(),
                playerId: prediction.playerId,
                playerName: prediction.playerName,
                type: prediction.type,
                buyPrice: prediction.buyPrice,
                predictedSellPrice: prediction.predictedSellPrice,
                predictedProfit: prediction.predictedProfit,
                predictedROI: prediction.predictedROI,
                confidence: prediction.confidence,
                factors: prediction.factors,
                status: 'PENDING',
                actualSellPrice: null,
                actualProfit: null,
                actualROI: null,
                verifiedAt: null
            };
            
            existing.push(newPrediction);
            const cleaned = existing.slice(-500);
            localStorage.setItem(key, JSON.stringify(cleaned));
            
            return newPrediction.id;
        } catch (e) {
            console.error('Erreur sauvegarde pr√©diction:', e);
            return null;
        }
    },
    
    getPredictions: (user, platform) => {
        try {
            const key = `kronos_predictions_${user.email}_${platform}`;
            return JSON.parse(localStorage.getItem(key) || '[]');
        } catch (e) {
            return [];
        }
    },
    
    verifyPredictions: (user, platform, players) => {
        const predictions = KronosMemory.getPredictions(user, platform);
        let updated = false;
        
        const now = Date.now();
        const oneDayMs = 24 * 60 * 60 * 1000;
        const threeDaysMs = 3 * oneDayMs;
        
        predictions.forEach(pred => {
            if (pred.status !== 'PENDING') return;
            
            const player = players.find(p => p.id === pred.playerId);
            if (!player) return;
            
            const elapsedTime = now - pred.timestamp;
            const targetTime = pred.type === 'FLIP' ? 2 * oneDayMs : threeDaysMs;
            
            if (elapsedTime < targetTime) return;
            
            const currentPrice = dayAvg(dayData(player));
            if (!currentPrice) return;
            
            const actualProfit = Math.floor(currentPrice * 0.95 - pred.buyPrice);
            const actualROI = pred.buyPrice > 0 ? (actualProfit / pred.buyPrice) * 100 : 0;
            
            const targetROI = pred.type === 'FLIP' ? 7 : 10;
            const isSuccess = actualROI >= targetROI;
            
            pred.status = isSuccess ? 'SUCCESS' : 'FAIL';
            pred.actualSellPrice = currentPrice;
            pred.actualProfit = actualProfit;
            pred.actualROI = actualROI;
            pred.verifiedAt = now;
            
            updated = true;
        });
        
        if (updated) {
            const key = `kronos_predictions_${user.email}_${platform}`;
            localStorage.setItem(key, JSON.stringify(predictions));
        }
        
        return predictions;
    },
    
    getStats: (user, platform) => {
        const predictions = KronosMemory.getPredictions(user, platform);
        
        const verified = predictions.filter(p => p.status !== 'PENDING');
        const success = predictions.filter(p => p.status === 'SUCCESS');
        const fail = predictions.filter(p => p.status === 'FAIL');
        
        const flipPredictions = verified.filter(p => p.type === 'FLIP');
        const investPredictions = verified.filter(p => p.type === 'INVEST');
        
        const flipSuccess = flipPredictions.filter(p => p.status === 'SUCCESS');
        const investSuccess = investPredictions.filter(p => p.status === 'SUCCESS');
        
        return {
            total: predictions.length,
            verified: verified.length,
            pending: predictions.filter(p => p.status === 'PENDING').length,
            successRate: verified.length > 0 ? (success.length / verified.length * 100) : 0,
            flipSuccessRate: flipPredictions.length > 0 ? (flipSuccess.length / flipPredictions.length * 100) : 0,
            investSuccessRate: investPredictions.length > 0 ? (investSuccess.length / investPredictions.length * 100) : 0,
            avgProfitSuccess: success.length > 0 ? success.reduce((sum, p) => sum + p.actualProfit, 0) / success.length : 0,
            avgProfitFail: fail.length > 0 ? fail.reduce((sum, p) => sum + p.actualProfit, 0) / fail.length : 0,
        };
    },
    
    getAdaptiveParameters: (user, platform) => {
        const stats = KronosMemory.getStats(user, platform);
        
        let params = {
            flipMultiplier: 1.13,
            investMultiplier: 1.15,
            minConfidenceFlip: 60,
            minConfidenceInvest: 65,
            volatilityBonus: 0.02,
            metaBonus: 0.03,
            rareBonus: 0.05
        };
        
        if (stats.verified < 20) return params;
        
        if (stats.flipSuccessRate < 70) {
            params.flipMultiplier = 1.11;
            params.minConfidenceFlip = 70;
        }
        
        if (stats.flipSuccessRate > 85) {
            params.flipMultiplier = 1.15;
            params.minConfidenceFlip = 55;
        }
        
        if (stats.investSuccessRate < 65) {
            params.investMultiplier = 1.12;
            params.minConfidenceInvest = 70;
        }
        
        if (stats.investSuccessRate > 80) {
            params.investMultiplier = 1.18;
            params.minConfidenceInvest = 60;
        }
        
        const successPredictions = KronosMemory.getPredictions(user, platform).filter(p => p.status === 'SUCCESS');
        
        if (successPredictions.length >= 10) {
            const metaSuccess = successPredictions.filter(p => p.factors?.isMeta).length / successPredictions.length;
            const rareSuccess = successPredictions.filter(p => p.factors?.isRare).length / successPredictions.length;
            
            if (metaSuccess > 0.6) params.metaBonus = 0.05;
            if (metaSuccess < 0.3) params.metaBonus = 0.01;
            
            if (rareSuccess > 0.6) params.rareBonus = 0.07;
            if (rareSuccess < 0.3) params.rareBonus = 0.02;
        }
        
        return params;
    }
};
        const getCardTypeClass = (ct = '') => { const l = (ct || '').toLowerCase(); if (l.includes('icon')) return 'ct-icon'; if (l.includes('totw')) return 'ct-totw'; if (l.includes('hero')) return 'ct-hero'; return 'ct-gold'; };
        const safeNum = (v, d = 0) => (typeof v === 'number' && !isNaN(v)) ? v : d;
        const dayData = (p) => p?.prices?.today || null;
        const yestData = (p) => p?.prices?.yesterday || null;
        const beforeData = (p) => p?.prices?.day_before || null;

        const dayAvg = (d) => {
            if (!d) return null;
            const avg = safeNum(d.avg);
            if (avg > 0) return avg;
            const min = safeNum(d.min);
            const max = safeNum(d.max);
            return min > 0 && max > 0 ? (min + max) / 2 : null;
        };

        const volDay = (p) => {
            const t = dayData(p);
            if (!t?.min || !t?.max || t.min <= 0) return 0;
            return ((t.max - t.min) / t.min) * 100;
        };

        const compute3d = (p) => {
            const d = [dayData(p), yestData(p), beforeData(p)].filter(Boolean);
            if (d.length === 0) return null;
            const avgs = d.map(x => dayAvg(x)).filter(n => n > 0);
            return { avg3: avgs.length ? avgs.reduce((a, b) => a + b, 0) / avgs.length : 0 };
        };

        /* ===== CALCULATE TRADE PLANS - VERSION ADAPTATIVE KRONOS ===== */
const calculateTradePlans = (p, user = null, platform = null) => {
    const t = dayData(p);
    const y = yestData(p);
    const b = beforeData(p);
    
    if (!t || !t.min || !t.max) {
        return {
            flip: { buy: 0, sell: 0, profit: 0, roi: 0, confidence: 0 },
            invest: { buy: 0, sell: 0, profit: 0, roi: 0, confidence: 0 },
            avgToday: 0,
            avg3: 0,
            advice: "Donn√©es insuffisantes",
            priority: "WAIT"
        };
    }
    
    const avgToday = dayAvg(t);
    const avg3 = compute3d(p)?.avg3 || avgToday;
    const vol = volDay(p);
    const oppScore = calculateOpportunityScore(p);
    const packStatus = calculatePackStatus(p);
    
    // R√©cup√®re les param√®tres adaptatifs si user/platform fournis
    const params = (user && platform) ? KronosMemory.getAdaptiveParameters(user, platform) : {
        flipMultiplier: 1.13,
        investMultiplier: 1.15,
        minConfidenceFlip: 60,
        minConfidenceInvest: 65,
        volatilityBonus: 0.02,
        metaBonus: 0.03,
        rareBonus: 0.05
    };
    
    // ===== ANALYSE META =====
    const isMeta = (
        (p.info?.['Skill Moves'] >= 5) ||
        (p.info?.['Weak Foot'] >= 5) ||
        (p.mainStats?.PAC >= 90) ||
        (p.mainStats?.DRI >= 90)
    );
    
    const isRare = ['RARE', 'VINTAGE', 'RECENTLY_OUT'].includes(packStatus.status);
    
    const playstylePlusCount = p.playstyles ? 
        Object.values(p.playstyles).reduce((sum, cat) => sum + (cat.plus?.length || 0), 0) : 0;
    
    // ===== FLIP (24-48h) =====
    let buyFlip = 0;
    let sellFlip = 0;
    let confidence = 0;
    
    if (vol > 20) {
        buyFlip = Math.floor(t.min * 1.01);
        confidence += 20;
    } else if (vol > 10) {
        buyFlip = Math.floor(t.min * 1.02);
        confidence += 30;
    } else {
        buyFlip = Math.floor(avgToday * 0.96);
        confidence += 15;
    }
    
    let sellMultiplier = params.flipMultiplier;
    
    if (isMeta) sellMultiplier += params.metaBonus;
    if (isRare) sellMultiplier += params.rareBonus;
    if (playstylePlusCount >= 2) sellMultiplier += 0.02;
    if (oppScore > 75) sellMultiplier += params.volatilityBonus;
    
    const targetPrice = Math.floor(buyFlip * sellMultiplier);
    const maxSafePrice = Math.floor(t.max * 0.97);
    
    sellFlip = Math.min(targetPrice, maxSafePrice);
    
    if (sellFlip < buyFlip * 1.08) {
        sellFlip = Math.floor(buyFlip * 1.08);
    }
    
    const profitFlip = Math.floor(sellFlip * 0.95 - buyFlip);
    const roiFlip = buyFlip > 0 ? (profitFlip / buyFlip) * 100 : 0;
    
    if (roiFlip >= 10) confidence += 40;
    else if (roiFlip >= 7) confidence += 30;
    else if (roiFlip >= 5) confidence += 20;
    else confidence += 5;
    
    const marketStatus = getMarketStatus();
    if (marketStatus.opportunities && oppScore > 60) confidence += 20;
    
    confidence = Math.min(100, confidence);
    
    // ===== INVEST (3-7j) =====
    let buyInvest = 0;
    let sellInvest = 0;
    let confidenceInvest = 0;
    
    if (avg3 > 0) {
        const discountRate = marketStatus.opportunities ? 0.88 : 0.92;
        buyInvest = Math.floor(avg3 * discountRate);
        confidenceInvest += 30;
    } else {
        buyInvest = Math.floor(avgToday * 0.95);
        confidenceInvest += 15;
    }
    
    const max3d = Math.max(t?.max || 0, y?.max || 0, b?.max || 0);
    
    if (max3d > 0) {
        let investMultiplier = params.investMultiplier / 1.15;
        
        if (isRare) investMultiplier = 1.00;
        if (isMeta && isRare) investMultiplier = 1.05;
        
        sellInvest = Math.floor(max3d * investMultiplier);
        confidenceInvest += 40;
    } else {
        sellInvest = Math.floor(buyInvest * params.investMultiplier);
        confidenceInvest += 20;
    }
    
    const profitInvest = Math.floor(sellInvest * 0.95 - buyInvest);
    const roiInvest = buyInvest > 0 ? (profitInvest / buyInvest) * 100 : 0;
    
    if (roiInvest >= 15) confidenceInvest += 30;
    else if (roiInvest >= 10) confidenceInvest += 20;
    else if (roiInvest >= 7) confidenceInvest += 10;
    
    confidenceInvest = Math.min(100, confidenceInvest);
    
    // ===== CONSEIL KRONOS =====
    let advice = "";
    let priority = "";
    
    if (roiFlip >= 10 && confidence >= params.minConfidenceFlip) {
        advice = "üî• FLIP EXCELLENT - Ach√®te maintenant !";
        priority = "FLIP";
    } else if (roiInvest >= 12 && confidenceInvest >= params.minConfidenceInvest) {
        advice = "üíé INVEST PREMIUM - Stocke pour 3-7j !";
        priority = "INVEST";
    } else if (roiFlip >= 7) {
        advice = "‚úÖ FLIP CORRECT - Rentable mais pas urgent";
        priority = "FLIP";
    } else if (roiInvest >= 8) {
        advice = "üìà INVEST CORRECT - Bon timing moyen terme";
        priority = "INVEST";
    } else {
        advice = "‚è∏Ô∏è ATTENDRE - ROI trop faible actuellement";
        priority = "WAIT";
    }
    
    return {
        flip: {
            buy: buyFlip,
            sell: sellFlip,
            profit: profitFlip,
            roi: roiFlip,
            confidence: Math.round(confidence),
            multiplier: sellMultiplier.toFixed(2)
        },
        invest: {
            buy: buyInvest,
            sell: sellInvest,
            profit: profitInvest,
            roi: roiInvest,
            confidence: Math.round(confidenceInvest),
            daysToHold: isRare ? "5-7j" : "3-5j"
        },
        avgToday,
        avg3,
        advice,
        priority,
        factors: {
            isMeta,
            isRare,
            volatility: vol.toFixed(1),
            oppScore,
            playstylePlus: playstylePlusCount
        },
        learningParams: params
    };
};

        const calculatePackStatus = (player) => {
            const cardType = (player.cardType || '').trim().toLowerCase();
            if (['rare', 'rare gold', 'icon', 'ut heroes'].some(t => cardType.includes(t))) return { status: 'ALWAYS_IN_PACK' };
            if (player['Added on']) {
                try {
                    const addedDate = new Date(player['Added on']);
                    if (isNaN(addedDate.getTime())) return { status: 'IN_PACK' };
                    const launchDate = new Date('2025-11-02T23:32:00');
                    const systemNow = new Date() > launchDate ? new Date() : launchDate;
                    if (addedDate > systemNow) return { status: 'UPCOMING', days: Math.ceil((addedDate - systemNow) / 86400000) };
                    const diffDays = (systemNow - addedDate) / 86400000;
                    if (diffDays < 7) return { status: 'IN_PACK' };
                    const daysOut = Math.floor(diffDays);
                    if (daysOut < 30) return { status: 'RECENTLY_OUT', days: daysOut };
                    if (daysOut < 90) return { status: 'RARE', days: daysOut };
                    return { status: 'VINTAGE', days: daysOut };
                } catch (e) { return { status: 'IN_PACK' }; }
            }
            return { status: 'IN_PACK' };
        };

        const getPackStatusBadge = (player) => {
            const { status, days } = calculatePackStatus(player);
            switch (status) {
                case 'UPCOMING': return <span className="pack-badge" style={{background:'blue'}}>üóìÔ∏è J-{days}</span>;
                case 'IN_PACK': case 'ALWAYS_IN_PACK': return <span className="pack-badge" style={{background:'green'}}>üì¶ IN PACK</span>;
                case 'RECENTLY_OUT': return <span className="pack-badge" style={{background:'orange'}}>üîí OUT {days}J</span>;
                case 'RARE': return <span className="pack-badge" style={{background:'cyan', color:'black'}}>üíé RARE {days}J</span>;
                case 'VINTAGE': return <span className="pack-badge" style={{background:'purple'}}>üíÄ VINTAGE</span>;
                default: return null;
            }
        };

        const isSpecialCard = (cardType) => {
            const ct = (cardType || '').toLowerCase();
            return !['rare', 'rare gold', ''].includes(ct);
        };

        const calculateOpportunityScore = (player) => {
    const today = dayData(player);
    if (!today || !today.min || !today.max) return 0;
    
    const avg = dayAvg(today);
    const range = today.max - today.min;
    if (range === 0) return 50;
    
    // Proximit√© au plancher
    const floorProximity = (1 - (avg - today.min) / range) * 100;
    
    // Calcul ROI SANS appeler calculateTradePlans (pour √©viter la boucle)
    const buyPrice = today.min > 0 ? Math.floor(today.min * 1.02) : 0;
    const sellPrice = buyPrice > 0 ? Math.floor(buyPrice * 1.13) : 0;
    const profit = sellPrice > 0 ? Math.floor(sellPrice * 0.95 - buyPrice) : 0;
    const roi = buyPrice > 0 ? (profit / buyPrice) * 100 : 0;
    const roiNormalized = Math.min(100, roi / 15 * 100);
    
    // Volatilit√©
    const vol = volDay(player);
    const volNormalized = Math.min(100, vol / 15 * 100);
    
    // Tendance
    const yest = yestData(player) ? dayAvg(yestData(player)) : avg;
    const trendBonus = avg < yest ? 100 : 0;
    
    // Pack status
    const { status } = calculatePackStatus(player);
    let packBonus = 0;
    if (status === 'VINTAGE') packBonus = 100;
    else if (status === 'RARE') packBonus = 80;
    else if (status === 'RECENTLY_OUT') packBonus = 60;
    
    // Score final
    const score = (floorProximity * 0.35) + (roiNormalized * 0.25) + (volNormalized * 0.15) + (trendBonus * 0.10) + (packBonus * 0.15);
    
    return Math.min(100, Math.max(0, Math.round(score)));
};

        const calculateFlopScore = (player) => {
            const today = dayData(player);
            if (!today || !today.min || !today.max) return 0;
            
            const avg = dayAvg(today);
            const range = today.max - today.min;
            if (range === 0) return 0;
            
            const ceilingProximity = ((avg - today.min) / range) * 100;
            const yest = yestData(player) ? dayAvg(yestData(player)) : avg;
            const trend = avg > yest ? ((avg - yest) / yest * 100) : 0;
            const trendPenalty = trend > 10 ? 100 : trend > 5 ? 50 : 0;
            const { flip } = calculateTradePlans(player);
            const roiPenalty = flip.roi < 5 ? 100 : flip.roi < 8 ? 50 : 0;
            const vol = volDay(player);
            const volPenalty = vol < 5 ? 100 : vol < 10 ? 50 : 0;
            const overvaluedScore = player.rating && avg > 0 ? 
                Math.max(0, (avg / (player.rating * 1000)) - 1) * 100 : 0;
            
            const score = (ceilingProximity * 0.30) + 
                         (trendPenalty * 0.25) + 
                         (roiPenalty * 0.20) + 
                         (volPenalty * 0.15) + 
                         (overvaluedScore * 0.10);
            
            return Math.min(100, Math.max(0, Math.round(score)));
        };

        /* ===== META SCORE - D√âSIRABILIT√â ===== */
        const calculateMetaScore = (player) => {
            let score = 0;
            const popularNations = ['France', 'Brazil', 'England', 'Spain', 'Germany', 'Portugal', 'Argentina', 'Netherlands'];
            if (popularNations.includes(player.info?.Nation)) {
                score += 20;
            }
            const popularLeagues = ['Premier League', 'LaLiga Santander', 'Ligue 1 Uber Eats', 'Bundesliga', 'Serie A TIM'];
            if (popularLeagues.includes(player.info?.League)) {
                score += 20;
            }
            const pace = player.mainStats?.PAC || 0;
            if (pace >= 90) score += 15;
            else if (pace >= 85) score += 12;
            else if (pace >= 80) score += 8;
            const skills = player.info?.['Skill Moves'] || 0;
            if (skills >= 5) score += 15;
            else if (skills >= 4) score += 10;
            const weakFoot = player.info?.['Weak Foot'] || 0;
            if (weakFoot >= 5) score += 10;
            else if (weakFoot >= 4) score += 7;
            const bodyType = (player.info?.['Body Type'] || '').toLowerCase();
            if (bodyType.includes('lean') || bodyType.includes('unique')) {
                score += 10;
            }
            let playstylePlusCount = 0;
            if (player.playstyles) {
                Object.values(player.playstyles).forEach(cat => {
                    if (cat.plus) playstylePlusCount += cat.plus.length;
                });
            }
            if (playstylePlusCount >= 3) score += 10;
            else if (playstylePlusCount >= 2) score += 7;
            else if (playstylePlusCount >= 1) score += 4;
            
            return Math.min(100, Math.round(score));
        };
        
        const getMetaBadge = (metaScore) => {
            if (metaScore >= 80) return { label: 'üî• ULTRA M√âTA', color: 'bg-gradient-to-r from-red-600 to-orange-600' };
            if (metaScore >= 70) return { label: '‚≠ê TR√àS M√âTA', color: 'bg-gradient-to-r from-purple-600 to-pink-600' };
            if (metaScore >= 50) return { label: '‚úÖ M√âTA', color: 'bg-gradient-to-r from-blue-600 to-cyan-600' };
            if (metaScore >= 30) return { label: '‚ö™ NEUTRE', color: 'bg-gray-600' };
            return { label: '‚ùå PEU D√âSIRABLE', color: 'bg-gray-800' };
        };

        /* ===== MARKET CLOCK - HORLOGE DU MARCH√â ===== */
        const getMarketStatus = () => {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            
            if (day === 4 && hour >= 8 && hour <= 10) {
                return {
                    icon: "üö®",
                    status: "CRASH REWARDS",
                    action: "ACHETER MAINTENANT",
                    reason: "Rewards ouverts ‚Üí Panic sell massif",
                    color: "bg-green-600",
                    pulse: true,
                    intensity: "extreme",
                    opportunities: true,
                    funPhrase: "C'est No√´l avant l'heure ! Les cadeaux pleuvent !"
                };
            }
            
            if (hour >= 0 && hour < 6) {
                return {
                    icon: "üåô",
                    status: "HEURES CREUSES",
                    action: "ACHETER (PRIX BAS)",
                    reason: "March√© endormi ‚Üí Prix au plancher",
                    color: "bg-blue-600",
                    intensity: "low",
                    funPhrase: "Les vrais ne dorment jamais... et font des affaires !"
                };
            }
            
            if (hour >= 6 && hour < 12) {
                return {
                    icon: "‚òÄÔ∏è",
                    status: "R√âVEIL DU MARCH√â",
                    action: "DERNIERS ACHATS",
                    reason: "Prix remontent progressivement",
                    color: "bg-cyan-600",
                    intensity: "medium",
                    funPhrase: "Le caf√© est pr√™t, les prix aussi... pour monter !"
                };
            }
            
            if (hour >= 12 && hour < 14) {
                return {
                    icon: "üçï",
                    status: "PAUSE D√âJEUNER",
                    action: "SNIPER DES AFFAIRES",
                    reason: "Activit√© mod√©r√©e, opportunit√©s de snipe",
                    color: "bg-gray-600",
                    intensity: "low",
                    funPhrase: "Pizza ou snipe ? Pourquoi pas les deux !"
                };
            }
            
            if (day === 4 && hour >= 17 && hour < 19) {
                return {
                    icon: "‚ö†Ô∏è",
                    status: "VENDRE AVANT CRASH",
                    action: "LIQUIDER VOS STOCKS",
                    reason: "Crash promo dans quelques heures",
                    color: "bg-red-600",
                    pulse: true,
                    intensity: "high",
                    funPhrase: "Le Titanic coule dans 2h... Abandonnez le navire !"
                };
            }
            
            if (day === 5 && hour === 19) {
                return {
                    icon: "üö®",
                    status: "CRASH PROMO MASSIF",
                    action: "ACHETER TOUT CE QUI BOUGE",
                    reason: "Packs ouverts massivement ‚Üí Prix plancher",
                    color: "bg-green-600",
                    pulse: true,
                    intensity: "extreme",
                    opportunities: true,
                    funPhrase: "Black Friday du FUT ! Achetez comme des sauvages !"
                };
            }
            
            if (day === 5 && hour >= 18 && hour <= 22) {
                return {
                    icon: "üí∞",
                    status: "CRASH PROMO ACTIF",
                    action: "CONTINUER D'ACHETER",
                    reason: "Ouverture de packs continue",
                    color: "bg-green-600",
                    intensity: "high",
                    opportunities: true,
                    funPhrase: "Les packs s'ouvrent, les prix s'effondrent !"
                };
            }
            
            if (day === 6 && hour >= 10 && hour <= 20) {
                return {
                    icon: "üéÆ",
                    status: "WEEKEND LEAGUE",
                    action: "VENDRE VOS CARTES",
                    reason: "Forte demande ‚Üí Prix au top",
                    color: "bg-orange-600",
                    pulse: true,
                    intensity: "high",
                    funPhrase: "Les joueurs cherchent leurs √©quipes... Vendez cher !"
                };
            }
            
            if (day === 0 && hour >= 20 && hour <= 23) {
                return {
                    icon: "üèÜ",
                    status: "FIN FUT CHAMPS",
                    action: "ACHETER MASSIVEMENT",
                    reason: "Joueurs vendent √©quipes ‚Üí Crash total",
                    color: "bg-green-600",
                    pulse: true,
                    intensity: "extreme",
                    opportunities: true,
                    funPhrase: "Game over pour eux... Game ON pour vous !"
                };
            }
            
            if (hour >= 18 && hour <= 23) {
                return {
                    icon: "üåÜ",
                    status: "PRIME TIME",
                    action: "ACTIVIT√â MAXIMALE",
                    reason: "Beaucoup de monde en ligne",
                    color: "bg-yellow-600",
                    intensity: "medium",
                    funPhrase: "Rush hour du march√©, restez vigilants !"
                };
            }
            
            if (hour >= 14 && hour < 18) {
                return {
                    icon: "üìö",
                    status: "MARCH√â CALME",
                    action: "ANALYSER & PR√âPARER",
                    reason: "Activit√© standard",
                    color: "bg-gray-600",
                    intensity: "medium",
                    funPhrase: "Calme plat... Pr√©parez votre prochaine strat√©gie !"
                };
            }
            
            return {
                icon: "‚ö™",
                status: "MARCH√â STABLE",
                action: "OBSERVER",
                reason: "Pas de mouvement majeur",
                color: "bg-gray-600",
                intensity: "low",
                funPhrase: "Zen attitude, analysez tranquillement."
            };
        };
                /* ===== KRONOS AI v7 - CONSCIOUSNESS EDITION ===== */
           /* ===== KRONOS LEARNING STATS - STATISTIQUES D'APPRENTISSAGE ===== */
function KronosLearningStats({ user, platform, players }) {
    const [stats, setStats] = useState(null);
    const [params, setParams] = useState(null);
    
    useEffect(() => {
        if (user && platform && players.length > 0) {
            // V√©rifie les pr√©dictions
            KronosMemory.verifyPredictions(user, platform, players);
            
            // R√©cup√®re les stats
            const s = KronosMemory.getStats(user, platform);
            const p = KronosMemory.getAdaptiveParameters(user, platform);
            
            setStats(s);
            setParams(p);
        }
    }, [user, platform, players]);
    
    if (!stats || !params) return null;
    
    const hasLearned = params.flipMultiplier !== 1.13 || params.investMultiplier !== 1.15;
    
    return (
        <div className="glass-card neon-border p-6 mb-8">
            <div className="flex items-center justify-between mb-6">
                <h3 className="text-3xl font-black gradient-text">üß† Apprentissage de Kronos</h3>
                {hasLearned && (
                    <span className="px-4 py-2 bg-green-600 rounded-lg font-bold text-sm animate-pulse">
                        ‚ú® PARAM√àTRES AJUST√âS
                    </span>
                )}
            </div>
            
            <div className="grid md:grid-cols-5 gap-4 mb-6">
                <div className="glass-card p-4 text-center border border-purple-500/30">
                    <div className="text-4xl font-black text-purple-300">{stats.total}</div>
                    <div className="text-xs text-gray-400 mt-2">Pr√©dictions totales</div>
                </div>
                <div className="glass-card p-4 text-center border border-green-500/30">
                    <div className="text-4xl font-black text-green-300">{stats.successRate.toFixed(1)}%</div>
                    <div className="text-xs text-gray-400 mt-2">Taux de r√©ussite</div>
                </div>
                <div className="glass-card p-4 text-center border border-cyan-500/30">
                    <div className="text-4xl font-black text-cyan-300">{stats.flipSuccessRate.toFixed(1)}%</div>
                    <div className="text-xs text-gray-400 mt-2">R√©ussite FLIP</div>
                </div>
                <div className="glass-card p-4 text-center border border-blue-500/30">
                    <div className="text-4xl font-black text-blue-300">{stats.investSuccessRate.toFixed(1)}%</div>
                    <div className="text-xs text-gray-400 mt-2">R√©ussite INVEST</div>
                </div>
                <div className="glass-card p-4 text-center border border-yellow-500/30">
                    <div className="text-4xl font-black text-yellow-300">{stats.pending}</div>
                    <div className="text-xs text-gray-400 mt-2">En attente</div>
                </div>
            </div>
            
            <div className="grid md:grid-cols-2 gap-4">
                <div className="glass-card p-4 bg-purple-900/20">
                    <h4 className="font-bold text-purple-300 mb-3 text-lg">‚öôÔ∏è Param√®tres FLIP</h4>
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-gray-400">Multiplicateur:</span>
                            <span className="font-bold text-yellow-300">
                                √ó{params.flipMultiplier}
                                {params.flipMultiplier !== 1.13 && <span className="ml-2 text-green-300">‚ú®</span>}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Confiance min:</span>
                            <span className="font-bold text-cyan-300">{params.minConfidenceFlip}%</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Bonus META:</span>
                            <span className="font-bold text-green-300">+{(params.metaBonus * 100).toFixed(0)}%</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Bonus RARE:</span>
                            <span className="font-bold text-orange-300">+{(params.rareBonus * 100).toFixed(0)}%</span>
                        </div>
                    </div>
                </div>
                
                <div className="glass-card p-4 bg-blue-900/20">
                    <h4 className="font-bold text-blue-300 mb-3 text-lg">‚öôÔ∏è Param√®tres INVEST</h4>
                    <div className="space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-gray-400">Multiplicateur:</span>
                            <span className="font-bold text-yellow-300">
                                √ó{params.investMultiplier}
                                {params.investMultiplier !== 1.15 && <span className="ml-2 text-green-300">‚ú®</span>}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Confiance min:</span>
                            <span className="font-bold text-cyan-300">{params.minConfidenceInvest}%</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Profit moyen (‚úÖ):</span>
                            <span className="font-bold text-green-300">
                                +{stats.avgProfitSuccess > 0 ? Math.floor(stats.avgProfitSuccess).toLocaleString() : '0'}
                            </span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-400">Perte moyenne (‚ùå):</span>
                            <span className="font-bold text-red-300">
                                {stats.avgProfitFail < 0 ? Math.floor(stats.avgProfitFail).toLocaleString() : '0'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            {stats.verified < 20 && (
                <div className="mt-4 p-4 bg-yellow-900/20 border border-yellow-500/30 rounded-lg text-center">
                    <p className="text-yellow-300 font-bold">
                        ‚è≥ Kronos apprend encore... {20 - stats.verified} v√©rifications n√©cessaires avant l'optimisation compl√®te
                    </p>
                </div>
            )}
        </div>
    );
}     
        function KronosConsciousnessDashboard({ players, onPlayerClick, user, platform }) {
            const [userProfile, setUserProfile] = useState(() => {
                try { const saved = localStorage.getItem('kronosUserProfile'); return saved ? JSON.parse(saved) : { level: 1, exp: 0, style: 'BALANCED', clicks: {} }; } catch { return { level: 1, exp: 0, style: 'BALANCED', clicks: {} }; }
            });
            const [memory, setMemory] = useState(() => {
                try { const saved = localStorage.getItem('kronosMemory'); return saved ? JSON.parse(saved) : { journal: [], weights: { dna: 0.3, trend: 0.4, pulse: 0.3 }, successes: 0, failures: 0 }; } catch { return { journal: [], weights: { dna: 0.3, trend: 0.4, pulse: 0.3 }, successes: 0, failures: 0 }; }
            });
            const [analysis, setAnalysis] = useState(null);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const allPlayers = Array.isArray(players) ? players : (players ? [players] : []);
                if (allPlayers.length === 0 || !allPlayers[0]) { setIsLoading(false); setAnalysis(null); return; }
                setIsLoading(true);
                setTimeout(() => {
                    const { updatedJournal, newSuccesses, newFailures } = evaluateJournal(memory.journal, allPlayers);
                    const { newWeights, adjusted } = adjustWeights(memory.weights, newSuccesses, newFailures);
                    if (journalHasChanges(memory.journal, updatedJournal) || adjusted) {
                        const newMemory = { journal: updatedJournal, weights: newWeights, successes: newSuccesses, failures: newFailures };
                        setMemory(newMemory); localStorage.setItem('kronosMemory', JSON.stringify(newMemory));
                    }
                    const analyzedPlayers = allPlayers.map(p => ({ player: p, score: calculateKronosScore(p, newWeights) })).filter(item => item.score > 0 && item.player.prices?.today?.avg).sort((a, b) => b.score - a.score);
                    const { budgetPicks, cardTypePicks } = generateBriefings(analyzedPlayers);
                    const marketPhase = analyzeMarketPhase(analyzedPlayers);
                    setAnalysis({ budgetPicks, cardTypePicks, marketPhase }); setIsLoading(false);
                }, 1000);
            }, [players]);
            
            const journalHasChanges = (oldJournal, newJournal) => {
                if (oldJournal.length !== newJournal.length) return true;
                return oldJournal.some((oldItem, index) => oldItem.status !== newJournal[index].status);
            };
            const evaluateJournal = (journal, currentPlayers) => {
                let successes = 0, failures = 0; const today = new Date();
                const updatedJournal = journal.map(prediction => {
                    if (prediction.status === 'SUCCESS') successes++; else if (prediction.status === 'FAILURE') failures++;
                    else if (prediction.status === 'PENDING' && (today - new Date(prediction.date)) / 86400000 > 3) {
                        const playerState = currentPlayers.find(p => p.info['Item ID'] === prediction.playerId);
                        if (playerState && playerState.prices) {
                            const maxPriceInPeriod = Math.max(...Object.values(playerState.prices).map(p => p.max).filter(Boolean));
                            if (maxPriceInPeriod >= prediction.predictedTarget) { prediction.status = 'SUCCESS'; successes++; } else { prediction.status = 'FAILURE'; failures++; }
                        }
                    }
                    return prediction;
                }).filter(p => (today - new Date(p.date)) / 86400000 < 30);
                return { updatedJournal, newSuccesses: successes, newFailures: failures };
            };
            const adjustWeights = (currentWeights, successes, failures) => {
    const total = successes + failures; if (total < 10) return { newWeights: currentWeights, adjusted: false };
    const successRate = successes / total; const newWeights = { ...currentWeights }; let adjusted = false;
    if (successRate < 0.6) { newWeights.trend = Math.min(0.6, newWeights.trend + 0.02); newWeights.pulse = Math.max(0.1, newWeights.pulse - 0.01); adjusted = true; } 
    else if (successRate > 0.8) { newWeights.pulse = Math.min(0.5, newWeights.pulse + 0.01); adjusted = true; }
    const sum = Math.max(0.1, newWeights.dna) + Math.max(0.1, newWeights.trend) + Math.max(0.1, newWeights.pulse);
    newWeights.dna = Math.max(0.1, newWeights.dna) / sum; newWeights.trend = Math.max(0.1, newWeights.trend) / sum; newWeights.pulse = Math.max(0.1, newWeights.pulse) / sum;
    return { newWeights, adjusted };
};

const handleCardClick = (player, targetPrice) => {
    // ... reste du code
    // Met √† jour le profil utilisateur
    const newClicks = { ...userProfile.clicks, [player.cardType]: (userProfile.clicks[player.cardType] || 0) + 1 };
    const newExp = userProfile.exp + 10;
    const newLevel = Math.floor((newExp / 1000) + 1);
    const updatedProfile = { ...userProfile, clicks: newClicks, exp: newExp, level: newLevel };
    setUserProfile(updatedProfile);
    localStorage.setItem('kronosUserProfile', JSON.stringify(updatedProfile));
    
    // ‚ú® NOUVEAU : Enregistre la pr√©diction avec le syst√®me Kronos
    if (user && platform) {
        const { flip } = calculateTradePlans(player, user, platform);
        
        KronosMemory.savePrediction(user, platform, {
            playerId: player.id || player.info?.['Item ID'],
            playerName: player.name,
            type: 'FLIP',
            buyPrice: flip.buy,
            predictedSellPrice: flip.sell,
            predictedProfit: flip.profit,
            predictedROI: flip.roi,
            confidence: flip.confidence || 50,
            factors: {
                isMeta: (player.info?.['Skill Moves'] >= 5) || (player.mainStats?.PAC >= 90),
                isRare: ['RARE', 'VINTAGE'].includes(calculatePackStatus(player).status)
            }
        });
    }
    
    // Ancienne logique de journal
    const prediction = {
        playerId: player.info?.['Item ID'] || player.id,
        date: new Date().toISOString(),
        predictedTarget: targetPrice,
        initialPrice: player.prices?.today?.avg || 0,
        status: 'PENDING'
    };
    
    const updatedJournal = [...memory.journal, prediction];
    setMemory(prev => ({...prev, journal: updatedJournal}));
    localStorage.setItem('kronosMemory', JSON.stringify({...memory, journal: updatedJournal}));
    
    // Appelle le callback parent
    if (onPlayerClick) {
        onPlayerClick(player);
    }
};
            const calculateKronosScore = (player, weights) => {
                if (!player || !player.info || !player.prices || !player.domPriceData) return 0;
                const skillMoves = parseInt(player.info['Skill Moves']) || 0; const weakFoot = parseInt(player.info['Weak Foot']) || 0;
                const playstylePlusCount = (player.playstyles?.ballControl?.plus?.length || 0) + (player.playstyles?.scoring?.plus?.length || 0);
                const dnaScore = (player.rating || 80) + (skillMoves * 5) + (weakFoot * 5) + (playstylePlusCount * 15);
                const trendScore = calculate7DayTrend(player.prices);
                const pulseScore = player.domPriceData?.recentSales?.length > 10 ? calculateMomentum(player.domPriceData.recentSales) : 50;
                return (dnaScore * weights.dna) + (trendScore * weights.trend) + (pulseScore * weights.pulse);
            };
            const calculate7DayTrend = (prices) => {
                if (!prices) return 50; const dayAvgs = Object.values(prices).map(p => p.avg).filter(Boolean); if (dayAvgs.length < 3) return 50;
                const firstDayAvg = dayAvgs[dayAvgs.length - 1]; const lastDayAvg = dayAvgs[0]; if (!firstDayAvg || !lastDayAvg || firstDayAvg === 0) return 50;
                return 50 + (((lastDayAvg - firstDayAvg) / firstDayAvg) * 100);
            };
            const calculateMomentum = (sales) => {
                if (!sales || sales.length < 10) return 50; const recentAvg = sales.slice(0, 5).reduce((sum, s) => sum + s.price, 0) / 5;
                const olderAvg = sales.slice(5, 10).reduce((sum, s) => sum + s.price, 0) / 5; if (olderAvg === 0) return 50;
                return Math.max(0, Math.min(100, 50 + (((recentAvg - olderAvg) / olderAvg) * 100) * 5));
            };
            const generateBriefings = (analyzedPlayers) => {
                const budgetBrackets = [ { name: "üíé Moins de 50k", min: 0, max: 50000 }, { name: "üí∞ 50k - 150k", min: 50000, max: 150000 }, { name: "üèÜ 150k - 500k", min: 150000, max: 500000 }, { name: "üëë 500k+", min: 500000, max: Infinity } ];
                const cardTypeCategories = [ { name: "‚ö° Cartes Sp√©ciales", isSpecial: true }, { name: "‚≠ê Ic√¥nes & H√©ros", isIconOrHero: true }, { name: "ü•á Or", isGold: true } ];
                const budgetPicks = budgetBrackets.map(b => ({ ...b, picks: analyzedPlayers.filter(i => i.player.prices.today.avg >= b.min && i.player.prices.today.avg < b.max).slice(0, 4)}));
                const cardTypePicks = cardTypeCategories.map(c => ({...c, picks: analyzedPlayers.filter(i => {
                    const cardType = i.player.cardType?.toLowerCase() || '';
                    if (c.isSpecial) return !cardType.includes('gold') && !cardType.includes('icon') && !cardType.includes('hero');
                    if (c.isIconOrHero) return cardType.includes('icon') || cardType.includes('hero');
                    if (c.isGold) return cardType.includes('gold'); return false;
                }).slice(0, 4)}));
                return { budgetPicks, cardTypePicks };
            };
            const analyzeMarketPhase = (analyzedPlayers) => {
                if (analyzedPlayers.length < 10) return "CALME";
                const top50 = analyzedPlayers.slice(0, 50);
                const avgTrend = top50.reduce((sum, item) => sum + calculate7DayTrend(item.player.prices), 0) / top50.length;
                const avgPulse = top50.reduce((sum, item) => sum + calculateMomentum(item.player.domPriceData?.recentSales), 0) / top50.length;
                if (avgTrend < 45 && avgPulse < 45) return "PHASE DE PEUR - OPPORTUNIT√âS D'ACHAT";
                if (avgTrend > 55 && avgPulse > 55) return "PHASE D'EUPHORIE - RISQUE DE BULLE";
                if (avgTrend > 55 && avgPulse < 50) return "HAUSSE SAINE ET STABLE";
                return "CONSOLIDATION - LE MARCH√â H√âSITE";
            };
            const BriefingCard = ({ item }) => {
                const { player, score } = item; const { prices } = player;
                const resistance = Object.values(prices).map(p => p.max).filter(Boolean).reduce((max, p) => Math.max(max, p), 0);
                const targetPrice = resistance * 0.95;
                const roi = prices.today.avg > 0 ? (((targetPrice * 0.95) - prices.today.avg) / prices.today.avg) * 100 : 0;
                const verdict = roi > 7 ? 'ACHAT' : 'SURVEILLER';
                return (<div className="glass-card border border-purple-500/20 p-5 flex flex-col justify-between h-full transform transition-all hover:scale-105 hover:border-purple-400/50"><div><div className="flex justify-between items-start mb-3"><div><p className="font-bold text-lg">{player.name}</p><div className="flex items-center gap-2 text-xs"><span className="stat-badge">{player.rating}</span><span className={`card-type-badge ${getCardTypeClass(player.cardType)}`}>{player.cardType}</span></div></div><div className="text-right"><div className="text-3xl font-black gradient-text">{score.toFixed(0)}</div><div className="text-xs text-gray-400">KRONOS SCORE</div></div></div><div className="space-y-2 text-sm mb-4"><div className="flex justify-between"><span className="text-gray-400">Prix Actuel:</span><span className="font-bold text-yellow-300">{prices.today.avg.toLocaleString()}</span></div><div className="flex justify-between"><span className="text-gray-400">Cible Vente:</span><span className="font-bold text-green-300">{Math.floor(targetPrice).toLocaleString()}</span></div><div className="flex justify-between"><span className="text-gray-400">ROI Potentiel:</span><span className={`font-bold ${roi > 0 ? 'text-green-400' : 'text-red-400'}`}>{roi.toFixed(1)}%</span></div></div></div><button onClick={() => handleCardClick(player, targetPrice)} className={`w-full py-3 rounded-lg font-bold transition-all ${verdict === 'ACHAT' ? 'bg-gradient-to-r from-green-600 to-emerald-600' : 'bg-gradient-to-r from-yellow-600 to-amber-600'}`}>{verdict === 'ACHAT' ? 'üü¢ SUIVRE & ANALYSER' : 'üü° ANALYSER'}</button></div>);
            };
            if (isLoading) { return <div className="text-center py-20 text-2xl animate-pulse text-purple-300">ü§ñ Kronos se synchronise avec la conscience du march√©...</div>; }
            if (!analysis) { return <div className="text-center py-20 text-red-400">‚ùå Anomalie d√©tect√©e. Aucune donn√©e valide pour Kronos.</div>; }
            const accuracy = memory.successes + memory.failures > 0 ? (memory.successes / (memory.successes + memory.failures) * 100).toFixed(1) : 'N/A';
            return (
    <div className="space-y-12">
        <KronosLearningStats user={user} platform={platform} players={players} />
                    <div><h1 className="text-5xl font-black gradient-text mb-2">KRONOS AI - CONSCIOUSNESS</h1><div className="flex justify-between items-center flex-wrap gap-4"><p className="text-gray-400">Votre symbiote de trading. Il apprend et s'adapte √† vous.</p><div className="flex gap-6"><div className="text-center"><div className="font-bold text-purple-300">NIVEAU {userProfile.level}</div><div className="w-24 h-1 bg-gray-700 rounded-full"><div className="h-1 bg-purple-500 rounded-full" style={{width: `${(userProfile.exp % 1000) / 10}%`}}></div></div></div><div className="text-center"><div className="font-bold text-cyan-300">PR√âCISION DE KRONOS</div><div className="text-xl font-black">{accuracy}%</div></div></div></div></div>
                    <div className="glass-card p-4 text-center"><p className="text-sm text-gray-400">√âTAT ACTUEL DU MARCH√â</p><p className="text-xl font-bold text-yellow-300">{analysis.marketPhase}</p></div>
                    <div><h2 className="text-3xl font-bold mb-6 flex items-center gap-3"><span className="text-4xl">üí∞</span> Briefing par Budget</h2><div className="space-y-8">{analysis.budgetPicks.map((bracket) => (<div key={bracket.name}><h3 className="text-xl font-semibold text-purple-300 mb-4">{bracket.name}</h3>{bracket.picks.length > 0 ? (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">{bracket.picks.map(item => <BriefingCard key={item.player.info['Item ID']} item={item} />)}</div>) : (<p className="text-gray-500 italic">Aucune opportunit√© de premier plan d√©tect√©e par Kronos.</p>)}</div>))}</div></div>
                    <div><h2 className="text-3xl font-bold mb-6 flex items-center gap-3"><span className="text-4xl">‚≠ê</span> Briefing par Type de Carte</h2><div className="space-y-8">{analysis.cardTypePicks.map((category) => (<div key={category.name}><h3 className="text-xl font-semibold text-purple-300 mb-4">{category.name}</h3>{category.picks.length > 0 ? (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">{category.picks.map(item => <BriefingCard key={item.player.info['Item ID']} item={item} />)}</div>) : (<p className="text-gray-500 italic">Aucune opportunit√© de premier plan d√©tect√©e par Kronos.</p>)}</div>))}</div></div>
                </div>
            );
        }

       
/* ===== TRADING DESK - VERSION COMPL√àTE AVEC FILTRES INTELLIGENTS ===== */
const TradingDesk = ({ players, onRowClick, user, platform }) => {
    const [filters, setFilters] = useState({
        name: '',
        ratingMin: '',
        ratingMax: '',
        priceMin: '',
        priceMax: '',
        roiMin: '',
        positions: [],
        league: '',
        nation: '',
        club: '',
        cardType: '',
        playstyle: '',
        playstylePlus: false,
        packStatus: 'all',
        budgetRange: 'all'
    });
    const [sort, setSort] = useState({ key: 'roi', dir: 'desc' });

    // Extraire toutes les valeurs uniques pour les filtres
    const uniqueValues = useMemo(() => {
        const leagues = new Set();
        const nations = new Set();
        const clubs = new Set();
        const cardTypes = new Set();
        const positions = new Set();
        const playstyles = new Set();
        
        const clubsByLeague = {};
        const clubsByNation = {};

        players.forEach(p => {
            if (p.info?.League) {
                leagues.add(p.info.League);
                if (!clubsByLeague[p.info.League]) clubsByLeague[p.info.League] = new Set();
                if (p.info?.Club) clubsByLeague[p.info.League].add(p.info.Club);
            }
            if (p.info?.Nation) {
                nations.add(p.info.Nation);
                if (!clubsByNation[p.info.Nation]) clubsByNation[p.info.Nation] = new Set();
                if (p.info?.Club) clubsByNation[p.info.Nation].add(p.info.Club);
            }
            if (p.info?.Club) clubs.add(p.info.Club);
            if (p.cardType) cardTypes.add(p.cardType);
            if (p.positions?.main) positions.add(p.positions.main);
            if (p.positions?.alternatives) p.positions.alternatives.forEach(pos => positions.add(pos));
            
            if (p.playstyles) {
                Object.values(p.playstyles).forEach(cat => {
                    if (cat.normal) cat.normal.forEach(ps => playstyles.add(ps));
                    if (cat.plus) cat.plus.forEach(ps => playstyles.add(ps));
                });
            }
        });

        Object.keys(clubsByLeague).forEach(league => {
            clubsByLeague[league] = Array.from(clubsByLeague[league]).sort();
        });
        Object.keys(clubsByNation).forEach(nation => {
            clubsByNation[nation] = Array.from(clubsByNation[nation]).sort();
        });

        return {
            leagues: Array.from(leagues).sort(),
            nations: Array.from(nations).sort(),
            clubs: Array.from(clubs).sort(),
            cardTypes: Array.from(cardTypes).sort(),
            positions: Array.from(positions).sort(),
            playstyles: Array.from(playstyles).sort(),
            clubsByLeague,
            clubsByNation
        };
    }, [players]);

    const filteredClubs = useMemo(() => {
        if (filters.league && uniqueValues.clubsByLeague[filters.league]) {
            return uniqueValues.clubsByLeague[filters.league];
        }
        if (filters.nation && uniqueValues.clubsByNation[filters.nation]) {
            return uniqueValues.clubsByNation[filters.nation];
        }
        return uniqueValues.clubs;
    }, [filters.league, filters.nation, uniqueValues]);

    const handleLeagueChange = (league) => {
        setFilters(f => ({ ...f, league, club: '', nation: '' }));
    };

    const handleNationChange = (nation) => {
        setFilters(f => ({ ...f, nation, club: '', league: '' }));
    };

    const filteredPlayers = useMemo(() => {
        let result = players.filter(p => {
            if (!p || !p.prices || !p.prices.today) return false;
            const price = dayAvg(dayData(p));
            if (!price || price < 1000) return false;
            
            if (filters.name && !p.name?.toLowerCase().includes(filters.name.toLowerCase())) return false;
            if (filters.ratingMin && (p.rating || 0) < Number(filters.ratingMin)) return false;
            if (filters.ratingMax && (p.rating || 0) > Number(filters.ratingMax)) return false;
            if (filters.priceMin && price < Number(filters.priceMin)) return false;
            if (filters.priceMax && price > Number(filters.priceMax)) return false;
            
            if (filters.budgetRange !== 'all') {
                const ranges = {
                    '0-50k': [0, 50000],
                    '50k-150k': [50000, 150000],
                    '150k-500k': [150000, 500000],
                    '500k-1M': [500000, 1000000],
                    '1M+': [1000000, Infinity]
                };
                const [min, max] = ranges[filters.budgetRange] || [0, Infinity];
                if (price < min || price > max) return false;
            }
            
            if (filters.league && p.info?.League !== filters.league) return false;
            if (filters.nation && p.info?.Nation !== filters.nation) return false;
            if (filters.club && p.info?.Club !== filters.club) return false;
            if (filters.cardType && p.cardType !== filters.cardType) return false;
            
            if (filters.positions.length > 0) {
                const playerPositions = [p.positions?.main, ...(p.positions?.alternatives || [])];
                if (!filters.positions.some(pos => playerPositions.includes(pos))) return false;
            }

            if (filters.playstyle) {
                let hasPlaystyle = false;
                if (p.playstyles) {
                    Object.values(p.playstyles).forEach(cat => {
                        if (filters.playstylePlus) {
                            if (cat.plus?.includes(filters.playstyle)) hasPlaystyle = true;
                        } else {
                            if (cat.normal?.includes(filters.playstyle) || cat.plus?.includes(filters.playstyle)) hasPlaystyle = true;
                        }
                    });
                }
                if (!hasPlaystyle) return false;
            }
            
            if (filters.packStatus !== 'all') {
                const status = calculatePackStatus(p).status;
                if (filters.packStatus === 'in' && !['IN_PACK', 'ALWAYS_IN_PACK'].includes(status)) return false;
                if (filters.packStatus === 'out' && ['IN_PACK', 'ALWAYS_IN_PACK'].includes(status)) return false;
            }
            
            const tradePlans = calculateTradePlans(p, user, platform);
            if (filters.roiMin && tradePlans.flip.roi < Number(filters.roiMin)) return false;
            
            return true;
        });

        result = result.map(p => ({
            ...p,
            price: dayAvg(dayData(p)),
            ...calculateTradePlans(p, user, platform),
            oppScore: calculateOpportunityScore(p),
            vol: volDay(p)
        }));

        result.sort((a, b) => {
            let valA, valB;
            
            if (sort.key === 'buyFlip' || sort.key === 'sellFlip' || sort.key === 'profitFlip' || sort.key === 'roi') {
                valA = a.flip?.[sort.key === 'buyFlip' ? 'buy' : sort.key === 'sellFlip' ? 'sell' : sort.key === 'profitFlip' ? 'profit' : 'roi'] ?? 0;
                valB = b.flip?.[sort.key === 'buyFlip' ? 'buy' : sort.key === 'sellFlip' ? 'sell' : sort.key === 'profitFlip' ? 'profit' : 'roi'] ?? 0;
            } else if (sort.key === 'buyInvest' || sort.key === 'sellInvest' || sort.key === 'profitInvest' || sort.key === 'roiInvest') {
                valA = a.invest?.[sort.key === 'buyInvest' ? 'buy' : sort.key === 'sellInvest' ? 'sell' : sort.key === 'profitInvest' ? 'profit' : 'roi'] ?? 0;
                valB = b.invest?.[sort.key === 'buyInvest' ? 'buy' : sort.key === 'sellInvest' ? 'sell' : sort.key === 'profitInvest' ? 'profit' : 'roi'] ?? 0;
            } else if (sort.key === 'league') {
                valA = a.info?.League || '';
                valB = b.info?.League || '';
            } else if (sort.key === 'club') {
                valA = a.info?.Club || '';
                valB = b.info?.Club || '';
            } else if (sort.key === 'nation') {
                valA = a.info?.Nation || '';
                valB = b.info?.Nation || '';
            } else {
                valA = a[sort.key] ?? 0;
                valB = b[sort.key] ?? 0;
            }
            
            if (typeof valA === 'string') {
                return sort.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            }
            
            return sort.dir === 'asc' ? valA - valB : valB - valA;
        });

        return result;
    }, [players, filters, sort, user, platform]);

    const togglePosition = (pos) => {
        setFilters(f => ({
            ...f,
            positions: f.positions.includes(pos) 
                ? f.positions.filter(p => p !== pos)
                : [...f.positions, pos]
        }));
    };

    const Th = ({ k, l }) => (
        <th className="p-4 cursor-pointer hover:bg-purple-900/20 transition-colors" onClick={() => setSort(s => s.key === k ? { ...s, dir: s.dir === 'asc' ? 'desc' : 'asc' } : { key: k, dir: 'desc' })}>
            <div className="flex items-center justify-center gap-1">
                <span className="font-bold">{l}</span>
                <span className="text-xs opacity-70">{sort.key === k ? (sort.dir === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï'}</span>
            </div>
        </th>
    );

    return (
        <div className="glass-card p-6">
            <div className="section-header mb-6">
                <h2 className="text-3xl font-black gradient-text">üí∞ Trading Desk - Vue Compl√®te</h2>
                <p className="text-gray-400 mt-2">Filtres intelligents ‚Ä¢ {players.length} joueurs total</p>
            </div>

            {/* FILTRES LIGNE 1 */}
            <div className="grid md:grid-cols-4 gap-4 mb-4">
                <input 
                    className="form-input" 
                    placeholder="üîç Nom du joueur..." 
                    value={filters.name} 
                    onChange={e => setFilters(f => ({ ...f, name: e.target.value }))} 
                />
                <input 
                    type="number" 
                    className="form-input" 
                    placeholder="‚≠ê Note min" 
                    value={filters.ratingMin} 
                    onChange={e => setFilters(f => ({ ...f, ratingMin: e.target.value }))} 
                />
                <input 
                    type="number" 
                    className="form-input" 
                    placeholder="‚≠ê Note max" 
                    value={filters.ratingMax} 
                    onChange={e => setFilters(f => ({ ...f, ratingMax: e.target.value }))} 
                />
                <input 
                    type="number" 
                    className="form-input" 
                    placeholder="üìä ROI min %" 
                    value={filters.roiMin} 
                    onChange={e => setFilters(f => ({ ...f, roiMin: e.target.value }))} 
                />
            </div>

            {/* FILTRES LIGNE 2 */}
            <div className="grid md:grid-cols-3 gap-4 mb-4">
                <select 
                    className="form-input font-bold" 
                    value={filters.budgetRange} 
                    onChange={e => setFilters(f => ({ ...f, budgetRange: e.target.value }))}
                >
                    <option value="all">üí∞ Tous les budgets</option>
                    <option value="0-50k">üíé 0 - 50k</option>
                    <option value="50k-150k">üí∞ 50k - 150k</option>
                    <option value="150k-500k">üèÜ 150k - 500k</option>
                    <option value="500k-1M">üëë 500k - 1M</option>
                    <option value="1M+">üí∏ 1M+</option>
                </select>

                <select 
                    className="form-input" 
                    value={filters.cardType} 
                    onChange={e => setFilters(f => ({ ...f, cardType: e.target.value }))}
                >
                    <option value="">üé¥ Tous les types de carte</option>
                    {uniqueValues.cardTypes.map(ct => (
                        <option key={ct} value={ct}>{ct}</option>
                    ))}
                </select>

                <select 
                    className="form-input" 
                    value={filters.playstyle} 
                    onChange={e => setFilters(f => ({ ...f, playstyle: e.target.value }))}
                >
                    <option value="">‚ö° Tous les PlayStyles</option>
                    {uniqueValues.playstyles.map(ps => (
                        <option key={ps} value={ps}>{ps}</option>
                    ))}
                </select>
            </div>

            {/* FILTRES LIGNE 3 - INTELLIGENTS */}
            <div className="grid md:grid-cols-3 gap-4 mb-4">
                <select 
                    className="form-input font-bold" 
                    value={filters.league} 
                    onChange={e => handleLeagueChange(e.target.value)}
                >
                    <option value="">üèÜ Toutes les ligues</option>
                    {uniqueValues.leagues.map(league => (
                        <option key={league} value={league}>
                            {league} ({uniqueValues.clubsByLeague[league]?.length || 0} clubs)
                        </option>
                    ))}
                </select>

                <select 
                    className="form-input font-bold" 
                    value={filters.nation} 
                    onChange={e => handleNationChange(e.target.value)}
                >
                    <option value="">üåç Toutes les nations</option>
                    {uniqueValues.nations.map(nation => (
                        <option key={nation} value={nation}>
                            {nation}
                        </option>
                    ))}
                </select>

                <select 
                    className="form-input font-bold" 
                    value={filters.club} 
                    onChange={e => setFilters(f => ({ ...f, club: e.target.value }))}
                    disabled={!filters.league && !filters.nation}
                >
                    <option value="">
                        {filters.league || filters.nation 
                            ? `‚öΩ Tous les clubs (${filteredClubs.length})` 
                            : '‚öΩ S√©lectionne une ligue/nation d\'abord'}
                    </option>
                    {filteredClubs.map(club => (
                        <option key={club} value={club}>{club}</option>
                    ))}
                </select>
            </div>

            {/* INDICATEUR FILTRES ACTIFS */}
            {(filters.league || filters.nation || filters.club) && (
                <div className="mb-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg flex items-center justify-between">
                    <div className="flex items-center gap-2 flex-wrap">
                        {filters.league && <span className="px-3 py-1 bg-green-600 rounded text-sm font-bold">üèÜ {filters.league}</span>}
                        {filters.nation && <span className="px-3 py-1 bg-yellow-600 rounded text-sm font-bold">üåç {filters.nation}</span>}
                        {filters.club && <span className="px-3 py-1 bg-purple-600 rounded text-sm font-bold">‚öΩ {filters.club}</span>}
                    </div>
                    <button 
                        onClick={() => setFilters(f => ({ ...f, league: '', nation: '', club: '' }))}
                        className="px-3 py-1 bg-red-600 rounded text-sm font-bold hover:bg-red-500"
                    >
                        ‚úï Effacer
                    </button>
                </div>
            )}

            {/* FILTRES POSTES */}
            <div className="glass-card p-4 mb-6">
                <h3 className="text-sm font-bold text-purple-300 mb-3">üìç Filtrer par Poste</h3>
                <div className="flex flex-wrap gap-2">
                    {uniqueValues.positions.map(pos => (
                        <button
                            key={pos}
                            onClick={() => togglePosition(pos)}
                            className={`px-4 py-2 rounded-lg font-bold text-sm transition-all ${
                                filters.positions.includes(pos)
                                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                                    : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                            }`}
                        >
                            {pos}
                        </button>
                    ))}
                    {filters.positions.length > 0 && (
                        <button
                            onClick={() => setFilters(f => ({ ...f, positions: [] }))}
                            className="px-4 py-2 rounded-lg font-bold text-sm bg-red-600 text-white hover:bg-red-500"
                        >
                            ‚úï Effacer ({filters.positions.length})
                        </button>
                    )}
                </div>
            </div>

            {/* STATISTIQUES */}
            <div className="mb-6 text-center bg-gradient-to-r from-purple-900/30 to-blue-900/30 p-4 rounded-lg border border-purple-500/30">
                <span className="text-3xl font-black text-yellow-300">{filteredPlayers.length}</span>
                <span className="text-lg text-gray-300 ml-2">joueurs trouv√©s sur {players.length} total</span>
            </div>

            {/* TABLEAU */}
            <div className="overflow-x-auto max-h-[800px] overflow-y-auto">
                <table className="w-full text-sm">
                    <thead className="sticky top-0 z-10">
                        <tr>
                            <Th k="name" l="Joueur" />
                            <Th k="rating" l="Note" />
                            <th className="p-4">Type</th>
                            <th className="p-4">Poste</th>
                            <Th k="price" l="Prix Actuel" />
                            <Th k="buyFlip" l="üí∞ Achat FLIP" />
                            <Th k="sellFlip" l="üí∏ Vente FLIP" />
                            <Th k="profitFlip" l="‚úÖ Profit FLIP" />
                            <Th k="roi" l="üìä ROI FLIP" />
                            <Th k="buyInvest" l="üíé Achat 3J" />
                            <Th k="sellInvest" l="üéØ Vente 3J" />
                            <Th k="profitInvest" l="üí∞ Profit 3J" />
                            <Th k="roiInvest" l="üìà ROI 3J" />
                            <Th k="oppScore" l="‚≠ê Opp" />
                            <th className="p-4">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {filteredPlayers.map(p => (
                            <tr key={p.id} className="border-b border-white/10 row-hover cursor-pointer" onClick={() => onRowClick(p)}>
                                <td className="p-4 font-bold whitespace-nowrap">{p.name}</td>
                                <td className="p-4 text-center">
                                    <span className="stat-badge">{p.rating}</span>
                                </td>
                                <td className="p-4 text-center">
                                    <span className={`card-type-badge ${getCardTypeClass(p.cardType)}`}>
                                        {p.cardType}
                                    </span>
                                </td>
                                <td className="p-4 text-center">
                                    <span className="text-xs bg-purple-600 px-2 py-1 rounded font-bold">
                                        {p.positions?.main || '‚Äî'}
                                    </span>
                                </td>
                                <td className="p-4 text-center font-semibold text-yellow-300 whitespace-nowrap">
                                    {p.price.toLocaleString()}
                                </td>
                                <td className="p-4 text-center font-semibold text-red-300 whitespace-nowrap">
                                    {p.flip.buy > 0 ? p.flip.buy.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-semibold text-green-300 whitespace-nowrap">
                                    {p.flip.sell > 0 ? p.flip.sell.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-bold text-cyan-300 whitespace-nowrap">
                                    {p.flip.profit > 0 ? `+${p.flip.profit.toLocaleString()}` : 
                                     p.flip.profit < 0 ? p.flip.profit.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-bold text-purple-300 whitespace-nowrap">
                                    {p.flip.roi > 0 ? `${p.flip.roi.toFixed(1)}%` : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-semibold text-orange-300 whitespace-nowrap">
                                    {p.invest.buy > 0 ? p.invest.buy.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-semibold text-green-400 whitespace-nowrap">
                                    {p.invest.sell > 0 ? p.invest.sell.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-bold text-yellow-400 whitespace-nowrap">
                                    {p.invest.profit > 0 ? `+${p.invest.profit.toLocaleString()}` : 
                                     p.invest.profit < 0 ? p.invest.profit.toLocaleString() : '‚Äî'}
                                </td>
                                <td className="p-4 text-center font-bold text-cyan-400 whitespace-nowrap">
                                    {p.invest.roi > 0 ? `${p.invest.roi.toFixed(1)}%` : '‚Äî'}
                                </td>
                                <td className="p-4 text-center">
                                    <span className="text-xl font-black text-purple-300">{p.oppScore}</span>
                                </td>
                                <td className="p-4 text-center">
                                    <button className="text-xs px-3 py-1 bg-purple-600 rounded hover:bg-purple-500">
                                        Voir
                                    </button>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {filteredPlayers.length === 0 && (
                <div className="text-center py-20">
                    <p className="text-2xl text-gray-400">Aucun joueur ne correspond aux filtres</p>
                </div>
            )}
        </div>
    );
};

       /* ===== SNIPER PRO - ULTIMATE EDITION (AVEC MODAL CORRIG√â) ===== */
function SniperPro({ players, onRowClick, user, platform }) {
    const [sniperMode, setSniperMode] = useState('opportunities');
    const [autoRefresh, setAutoRefresh] = useState(false);
    const [refreshInterval, setRefreshInterval] = useState(30);
    const [soundAlerts, setSoundAlerts] = useState(true);
    const [minProfit, setMinProfit] = useState(5000);
    const [maxPrice, setMaxPrice] = useState(500000);
    const [snipeHistory, setSnipeHistory] = useState([]);
    const [countdown, setCountdown] = useState(refreshInterval);
    const [selectedOpportunity, setSelectedOpportunity] = useState(null); // Cet √©tat contr√¥le le modal

    useEffect(() => {
        if (user && platform) {
            const key = `sniper_history_${user.email}_${platform}`;
            const saved = localStorage.getItem(key);
            if (saved) try { setSnipeHistory(JSON.parse(saved)); } catch(e) {}
        }
    }, [user, platform]);

    useEffect(() => {
        if (user && platform && snipeHistory.length > 0) {
            const key = `sniper_history_${user.email}_${platform}`;
            localStorage.setItem(key, JSON.stringify(snipeHistory.slice(-100)));
        }
    }, [snipeHistory, user, platform]);

    useEffect(() => {
        if (autoRefresh && countdown > 0) {
            const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
            return () => clearTimeout(timer);
        } else if (autoRefresh && countdown === 0) {
            setCountdown(refreshInterval);
            if (soundAlerts) playAlert('refresh');
        }
    }, [autoRefresh, countdown, refreshInterval, soundAlerts]);

    // Calcul des opportunit√©s de snipe - VERSION RENTABILIT√â MAX
const snipeOpportunities = useMemo(() => {
    return players
        .filter(p => {
            const price = dayAvg(dayData(p));
            if (!price || price > maxPrice) return false;
            
            const today = dayData(p);
            if (!today || !today.min || !today.max) return false;
            
            // On ne garde que les joueurs avec une volatilit√© d'au moins 5%
            const volatility = today.min > 0 ? ((today.max - today.min) / today.min) * 100 : 0;
            return volatility >= 5;
        })
        .map(p => {
            const today = dayData(p);
            const min = today.min;
            const max = today.max;
            const avg = dayAvg(today);
            
            // ===============================================
            // üî• NOUVELLE LOGIQUE DE CALCUL üî•
            // ===============================================

            // 1. PRIX DE REVENTE RAPIDE = Le prix MIN du jour (on vendra juste en dessous de la concurrence)
            const quickSellPrice = Math.floor(min * 0.99);

            // 2. PRIX DE SNIPE INTELLIGENT = On calcule le prix d'achat N√âCESSAIRE pour faire 10% de ROI net
            // Formule invers√©e : Achat = (Vente * 0.95) / (1 + ROI_d√©sir√©)
            const desiredROI = 0.10; // 10% net
            const snipePrice = Math.floor((quickSellPrice * 0.95) / (1 + desiredROI));

            // Si le snipePrice est illogique (trop bas), on l'ignore
            if (snipePrice < min * 0.5) { // Si c'est plus de 50% sous le MIN, c'est irr√©aliste
                return null;
            }

            // 3. PROFIT INSTANTAN√â (garanti d'√™tre bon car bas√© sur 10% de ROI)
            const instantProfit = Math.floor(quickSellPrice * 0.95 - snipePrice);
            const instantROI = snipePrice > 0 ? (instantProfit / snipePrice) * 100 : 0;

            // 4. PROFIT OPTIMAL (si on attend que le prix remonte vers la moyenne)
            const optimalSellPrice = Math.floor(avg);
            const optimalProfit = Math.floor(optimalSellPrice * 0.95 - snipePrice);
            const optimalROI = snipePrice > 0 ? (optimalProfit / snipePrice) * 100 : 0;

            // Volatilit√©
            const volatility = min > 0 ? ((max - min) / min) * 100 : 0;
            
            // Score de snipe bas√© sur le PROFIT et non plus le ROI (plus pertinent pour les cartes ch√®res)
            const profitScore = Math.min(100, (instantProfit / 50000) * 100); // 50k de profit = 100 points
            const volatilityScore = Math.min(100, volatility * 3);
            const snipeScore = (profitScore * 0.6) + (volatilityScore * 0.4);
            
            // ===============================================
            
            const estimatedAppearanceTime = volatility > 25 ? 'Fr√©quent (1-5min)' : 
                                           volatility > 15 ? 'Moyen (5-15min)' : 
                                           'Rare (15-30min+)';
            
            const difficulty = instantROI > 15 ? 'EXTREME' : 
                              instantROI > 10 ? 'DIFFICILE' : 
                              'MOYEN'; // On supprime "FACILE" pour ne garder que ce qui est rentable
            
            const competitorEstimate = instantROI > 15 ? '√âNORME (Bots)' : 
                                      instantROI > 10 ? 'HAUTE (20+)' : 
                                      'MOYENNE (5-15)';
            
            return {
                ...p,
                snipePrice,
                quickSellPrice,
                optimalSellPrice,
                instantProfit,
                optimalProfit,
                instantROI,
                optimalROI,
                volatility,
                snipeScore,
                estimatedAppearanceTime,
                difficulty,
                competitorEstimate,
                currentPrice: avg
            };
        })
        .filter(p => p && p.instantProfit >= minProfit) // Filtre aussi les 'null'
        .sort((a, b) => b.snipeScore - a.snipeScore)
        .slice(0, 50);
}, [players, maxPrice, minProfit]);

    const playAlert = (type) => {
        if (!soundAlerts) return;
        try {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj==');
            audio.play().catch(() => {});
        } catch (e) {}
    };

    const recordSnipe = (opportunity, success) => {
        const record = { id: Date.now(), playerName: opportunity.name, snipePrice: opportunity.snipePrice, sellPrice: success ? opportunity.quickSellPrice : null, profit: success ? opportunity.instantProfit : 0, success, timestamp: new Date().toISOString() };
        setSnipeHistory(prev => [record, ...prev]);
    };

    const SnipeCard = ({ opp, index }) => {
        const difficultyColors = { 'EXTREME': 'from-red-600 to-orange-600', 'DIFFICILE': 'from-orange-600 to-yellow-600', 'MOYEN': 'from-yellow-600 to-green-600', 'FACILE': 'from-green-600 to-blue-600' };

        return (
            <div className="glass-card neon-border p-6 hover:scale-105 transition-all cursor-pointer" onClick={() => onRowClick(opp)}>
                <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center gap-3">
                        <div className={`text-4xl font-black bg-gradient-to-r ${difficultyColors[opp.difficulty]} bg-clip-text text-transparent`}>#{index + 1}</div>
                        <div>
                            <h3 className="text-xl font-bold text-white">{opp.name}</h3>
                            <div className="flex items-center gap-2 mt-1"><span className="stat-badge">{opp.rating}</span><span className={`card-type-badge ${getCardTypeClass(opp.cardType)}`}>{opp.cardType}</span></div>
                        </div>
                    </div>
                    <div className="text-right">
                        <div className="text-3xl font-black text-purple-400">{opp.snipeScore.toFixed(0)}</div>
                        <div className="text-xs text-gray-400">SNIPE SCORE</div>
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <div className="bg-gradient-to-br from-red-900/30 to-red-700/30 p-4 rounded-lg border border-red-500/30"><div className="text-xs text-red-300 mb-1">üéØ PRIX DE SNIPE</div><div className="text-2xl font-black text-red-400">{opp.snipePrice.toLocaleString()}</div><div className="text-xs text-gray-400 mt-1">Acheter √† ce prix max</div></div>
                    <div className="bg-gradient-to-br from-green-900/30 to-green-700/30 p-4 rounded-lg border border-green-500/30"><div className="text-xs text-green-300 mb-1">üí∞ REVENTE RAPIDE</div><div className="text-2xl font-black text-green-400">{opp.quickSellPrice.toLocaleString()}</div><div className="text-xs text-gray-400 mt-1">Vendre imm√©diatement</div></div>
                </div>
                <div className="bg-gradient-to-r from-yellow-900/20 to-orange-900/20 p-4 rounded-lg border border-yellow-500/30 mb-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div><div className="text-xs text-yellow-300">‚ö° PROFIT INSTANTAN√â</div><div className="text-xl font-black text-yellow-400">+{opp.instantProfit.toLocaleString()}</div><div className="text-sm text-gray-300">{opp.instantROI.toFixed(1)}% ROI</div></div>
                        <div><div className="text-xs text-orange-300">üéØ PROFIT OPTIMAL</div><div className="text-xl font-black text-orange-400">+{opp.optimalProfit.toLocaleString()}</div><div className="text-sm text-gray-300">{opp.optimalROI.toFixed(1)}% ROI</div></div>
                    </div>
                </div>
                <div className="grid grid-cols-3 gap-2 text-xs mb-4">
                    <div className={`p-2 rounded bg-gradient-to-r ${difficultyColors[opp.difficulty]} text-center`}><div className="font-black">{opp.difficulty}</div><div className="opacity-80">Difficult√©</div></div>
                    <div className="p-2 rounded bg-blue-900/30 border border-blue-500/30 text-center"><div className="font-bold text-blue-300">{opp.competitorEstimate}</div><div className="text-gray-400">Concurrents</div></div>
                    <div className="p-2 rounded bg-purple-900/30 border border-purple-500/30 text-center"><div className="font-bold text-purple-300">{opp.volatility.toFixed(0)}%</div><div className="text-gray-400">Volatilit√©</div></div>
                </div>
                <div className="mb-4 p-3 bg-cyan-900/20 border border-cyan-500/30 rounded text-center"><div className="text-xs text-cyan-300">‚è±Ô∏è FR√âQUENCE D'APPARITION</div><div className="text-sm font-bold text-white mt-1">{opp.estimatedAppearanceTime}</div></div>
                <div className="grid grid-cols-4 gap-2">
                    <button onClick={(e) => { e.stopPropagation(); setSelectedOpportunity(opp); }} className="px-2 py-2 bg-blue-600 rounded-lg font-bold hover:bg-blue-500 transition-all text-xs">üìã GUIDE</button>
                    <button onClick={(e) => { e.stopPropagation(); recordSnipe(opp, true); }} className="px-2 py-2 bg-green-600 rounded-lg font-bold hover:bg-green-500 transition-all text-xs">‚úÖ SNIP√â</button>
                    <button onClick={(e) => { e.stopPropagation(); recordSnipe(opp, false); }} className="px-2 py-2 bg-red-600 rounded-lg font-bold hover:bg-red-500 transition-all text-xs">‚ùå RAT√â</button>
                    <button onClick={(e) => { e.stopPropagation(); onRowClick(opp); }} className="px-2 py-2 bg-purple-600 rounded-lg font-bold hover:bg-purple-500 transition-all text-xs">üëÅÔ∏è INFO</button>
                </div>
            </div>
        );
    };

    const HistoryStats = () => {
        const successCount = snipeHistory.filter(s => s.success).length;
        const totalAttempts = snipeHistory.length;
        const successRate = totalAttempts > 0 ? (successCount / totalAttempts) * 100 : 0;
        const totalProfit = snipeHistory.filter(s => s.success).reduce((sum, s) => sum + s.profit, 0);
        const avgProfitPerSnipe = successCount > 0 ? totalProfit / successCount : 0;

        return (
            <div className="grid md:grid-cols-5 gap-4 mb-6">
                <div className="glass-card p-4 text-center border border-green-500/30"><div className="text-3xl font-black text-green-400">{successCount}</div><div className="text-sm text-gray-400">Snipes r√©ussis</div></div>
                <div className="glass-card p-4 text-center border border-red-500/30"><div className="text-3xl font-black text-red-400">{totalAttempts - successCount}</div><div className="text-sm text-gray-400">Snipes rat√©s</div></div>
                <div className="glass-card p-4 text-center border border-cyan-500/30"><div className="text-3xl font-black text-cyan-400">{successRate.toFixed(1)}%</div><div className="text-sm text-gray-400">Taux de r√©ussite</div></div>
                <div className="glass-card p-4 text-center border border-yellow-500/30"><div className="text-3xl font-black text-yellow-400">+{totalProfit.toLocaleString()}</div><div className="text-sm text-gray-400">Profit total</div></div>
                <div className="glass-card p-4 text-center border border-purple-500/30"><div className="text-3xl font-black text-purple-400">+{Math.floor(avgProfitPerSnipe).toLocaleString()}</div><div className="text-sm text-gray-400">Profit / snipe</div></div>
            </div>
        );
    };

    return (
        <div className="glass-card neon-border p-6">
            <div className="section-header mb-6"><h2 className="text-4xl font-black gradient-text">üéØ SNIPER PRO - ULTIMATE EDITION</h2><p className="text-gray-400 mt-2">Mode de chasse ultime avec analyse en temps r√©el</p></div>
            <div className="glass-card p-6 mb-6 bg-gradient-to-r from-purple-900/30 to-blue-900/30">
                <div className="grid md:grid-cols-4 gap-4">
                    <div><label className="text-sm text-gray-300 mb-2 block">üí∞ Profit Minimum</label><input type="number" className="form-input" value={minProfit} onChange={e => setMinProfit(Number(e.target.value))} step="1000"/></div>
                    <div><label className="text-sm text-gray-300 mb-2 block">üíé Prix Maximum</label><input type="number" className="form-input" value={maxPrice} onChange={e => setMaxPrice(Number(e.target.value))} step="10000"/></div>
                    <div><label className="text-sm text-gray-300 mb-2 block">üîÑ Intervalle (sec)</label><input type="number" className="form-input" value={refreshInterval} onChange={e => setRefreshInterval(Number(e.target.value))} min="10" max="300"/></div>
                    <div className="flex items-end gap-2"><button onClick={() => setAutoRefresh(!autoRefresh)} className={`flex-1 py-3 rounded-lg font-bold ${autoRefresh ? 'bg-green-600' : 'bg-gray-700'}`}>{autoRefresh ? `‚è±Ô∏è ${countdown}s` : '‚ñ∂Ô∏è START'}</button><button onClick={() => setSoundAlerts(!soundAlerts)} className={`px-4 py-3 rounded-lg ${soundAlerts ? 'bg-blue-600' : 'bg-gray-700'}`}>{soundAlerts ? 'üîä' : 'üîá'}</button></div>
                </div>
            </div>
            <div className="flex gap-3 mb-6">
                <button onClick={() => setSniperMode('opportunities')} className={`tab-button ${sniperMode === 'opportunities' ? 'active' : ''}`}>üéØ Opportunit√©s ({snipeOpportunities.length})</button>
                <button onClick={() => setSniperMode('history')} className={`tab-button ${sniperMode === 'history' ? 'active' : ''}`}>üìä Historique ({snipeHistory.length})</button>
            </div>
            {sniperMode === 'opportunities' && (snipeOpportunities.length > 0 ? <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-6">{snipeOpportunities.map((opp, idx) => <SnipeCard key={opp.id} opp={opp} index={idx} />)}</div> : <div className="text-center py-20"><div className="text-6xl mb-4">üòî</div><p className="text-2xl text-gray-400">Aucune opportunit√© de snipe trouv√©e</p><p className="text-gray-500 mt-2">Essayez de r√©duire le profit minimum ou d'augmenter le prix max</p></div>)}
            {sniperMode === 'history' && (<><HistoryStats /><div className="space-y-3 max-h-[600px] overflow-y-auto">{snipeHistory.length > 0 ? (snipeHistory.slice(0, 50).map(record => (<div key={record.id} className={`p-4 rounded-lg border ${record.success ? 'bg-green-900/20 border-green-500/30' : 'bg-red-900/20 border-red-500/30'}`}><div className="flex justify-between items-center"><div><span className="font-bold text-lg">{record.playerName}</span><span className="ml-3 text-sm text-gray-400">{new Date(record.timestamp).toLocaleString('fr-FR')}</span></div><div className="text-right"><div className={`text-xl font-bold ${record.success ? 'text-green-400' : 'text-red-400'}`}>{record.success ? `+${record.profit.toLocaleString()}` : 'RAT√â'}</div><div className="text-sm text-gray-400">Snipe: {record.snipePrice.toLocaleString()}</div></div></div></div>))) : <div className="text-center py-20"><div className="text-6xl mb-4">üìä</div><p className="text-2xl text-gray-400">Aucun historique de snipe</p><p className="text-gray-500 mt-2">Commencez √† enregistrer vos snipes !</p></div>}</div></>)}
            
            {/* üî• MODAL DU GUIDE - C'est cette partie qui affiche le guide */}
            {selectedOpportunity && (
                <div className="modal-overlay" onClick={() => setSelectedOpportunity(null)}>
                    <div className="glass-card p-8 max-w-4xl w-full" onClick={e => e.stopPropagation()}>
                        <h3 className="text-3xl font-black gradient-text mb-6">üéØ Guide de Snipe - {selectedOpportunity.name}</h3>
                        <div className="space-y-6">
                            <div className="glass-card p-6 bg-blue-900/20 border border-blue-500/30">
                                <h4 className="text-xl font-bold text-blue-300 mb-4">üìã √âTAPES DU SNIPE</h4>
                                <ol className="space-y-3">
                                    <li className="flex items-start gap-3"><span className="text-2xl font-black text-blue-400">1</span><div><div className="font-bold">Pr√©pare ton filtre</div><div className="text-sm text-gray-300">Joueur : {selectedOpportunity.name}, Prix MAX : {selectedOpportunity.snipePrice.toLocaleString()}</div></div></li>
                                    <li className="flex items-start gap-3"><span className="text-2xl font-black text-blue-400">2</span><div><div className="font-bold">Rafra√Æchis rapidement</div><div className="text-sm text-gray-300">Utilise les boutons L1/R1 (ou Y sur clavier) pour rafra√Æchir sans lag</div></div></li>
                                    <li className="flex items-start gap-3"><span className="text-2xl font-black text-blue-400">3</span><div><div className="font-bold">Ach√®te instantan√©ment</div><div className="text-sm text-gray-300">D√®s que tu vois une carte √† {selectedOpportunity.snipePrice.toLocaleString()} ou moins ‚Üí BUY NOW</div></div></li>
                                    <li className="flex items-start gap-3"><span className="text-2xl font-black text-blue-400">4</span><div><div className="font-bold">Revends imm√©diatement</div><div className="text-sm text-gray-300">Liste √† {selectedOpportunity.quickSellPrice.toLocaleString()} pour profit rapide</div></div></li>
                                </ol>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="glass-card p-4 bg-yellow-900/20 border border-yellow-500/30"><div className="text-sm text-yellow-300 mb-2">‚ö° VITESSE REQUISE</div><div className="text-2xl font-black text-yellow-400">{selectedOpportunity.difficulty === 'EXTREME' ? '< 0.5 sec' : selectedOpportunity.difficulty === 'DIFFICILE' ? '< 1 sec' : selectedOpportunity.difficulty === 'MOYEN' ? '< 2 sec' : '< 3 sec'}</div></div>
                                <div className="glass-card p-4 bg-purple-900/20 border border-purple-500/30"><div className="text-sm text-purple-300 mb-2">üéØ CHANCES DE SUCC√àS</div><div className="text-2xl font-black text-purple-400">{selectedOpportunity.difficulty === 'EXTREME' ? '5-10%' : selectedOpportunity.difficulty === 'DIFFICILE' ? '15-25%' : selectedOpportunity.difficulty === 'MOYEN' ? '40-60%' : '70-90%'}</div></div>
                            </div>
                            <button onClick={() => setSelectedOpportunity(null)} className="w-full py-3 bg-purple-600 rounded-lg font-bold hover:bg-purple-500">‚úÖ Compris, je suis pr√™t !</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

        
                /* ===== PLAYER MODAL - ULTIMATE DYNAMIC VERSION ===== */
        function PlayerModal({ player, onClose }) {
            const [tab, setTab] = useState('avisIA');

            const InfoRow = ({ label, value, color = "text-white" }) => {
                if (value === null || value === undefined || value === '') return null;
                return (
                    <div className="flex justify-between py-2 border-b border-white/10">
                        <span className="text-gray-400">{label}:</span>
                        <span className={`font-semibold text-right ${color}`}>{value.toString()}</span>
                    </div>
                );
            };

            const getDetailedVerdict = () => {
                const oppScore = calculateOpportunityScore(player);
                const { flip, invest } = calculateTradePlans(player);
                const vol = volDay(player);
                const packStatus = calculatePackStatus(player);
                const today = dayData(player);
                const yesterday = yestData(player);
                const trend = today && yesterday && dayAvg(yesterday) > 0 ? ((dayAvg(today) - dayAvg(yesterday)) / dayAvg(yesterday) * 100) : 0;
                
                let verdict = { title: "", color: "", mainAdvice: "", reasons: [], strategy: "", risk: "", timing: "" };

                if (oppScore > 75) {
                    verdict = {
                        title: "üü¢ ACHAT IMM√âDIAT RECOMMAND√â", color: "text-green-400",
                        mainAdvice: "Excellente opportunit√© ! Ce joueur pr√©sente un potentiel de profit √©lev√© avec un risque minimal.",
                        reasons: [ `Score d'opportunit√© exceptionnel : ${oppScore}/100`, `ROI Flip attendu : ${flip.roi.toFixed(1)}%`, `Volatilit√© favorable : ${vol.toFixed(1)}%`, trend < 0 ? `Tendance baissi√®re attractive` : `Momentum positif` ],
                        strategy: `Acheter √† ~${flip.buy.toLocaleString()} et revendre √† ~${flip.sell.toLocaleString()}.`, risk: "Risque FAIBLE - Prix proche du plancher.", timing: "Acheter MAINTENANT, revendre dans 24-48h."
                    };
                } else if (oppScore > 50) {
                    verdict = {
                        title: "üü° √Ä SURVEILLER DE PR√àS", color: "text-yellow-400",
                        mainAdvice: "Potentiel int√©ressant. Attendez le bon point d'entr√©e.",
                        reasons: [ `Score d'opportunit√© correct : ${oppScore}/100`, `ROI potentiel : ${flip.roi.toFixed(1)}%`, `Prix actuel dans la moyenne.` ],
                        strategy: `Placer des ordres d'achat 5-10% sous le prix actuel.`, risk: "Risque MOD√âR√â.", timing: "Patience recommand√©e."
                    };
                } else {
                    verdict = {
                        title: "üî¥ √Ä √âVITER POUR L'INSTANT", color: "text-red-400",
                        mainAdvice: "Ce joueur est sur√©valu√© ou en d√©clin. Mieux vaut chercher ailleurs.",
                        reasons: [ `Score d'opportunit√© faible : ${oppScore}/100`, `ROI insuffisant : ${flip.roi.toFixed(1)}%`],
                        strategy: "Ne pas acheter. Vendre si en stock.", risk: "Risque √âLEV√â de baisse.", timing: "Aucune action d'achat."
                    };
                }

                if (packStatus.status === 'VINTAGE' || packStatus.status === 'RARE') {
                    verdict.reasons.push(`üíé Carte RARE/VINTAGE : Offre limit√©e.`);
                }
                return verdict;
            };

            const renderPriceRow = (label, data, previousData) => {
                if (!data || data.count === 0) return (
                     <tr className="border-b border-white/10 opacity-50"><td className="p-4 font-semibold">{label}</td><td colSpan="5" className="p-4 text-center text-gray-500">Pas de donn√©es</td></tr>
                );
                const avg = data.avg || 0;
                const vol = data.min > 0 ? ((data.max - data.min) / data.min) * 100 : 0;
                const variation = previousData?.avg > 0 ? ((avg - previousData.avg) / previousData.avg * 100) : null;
                return (
                    <tr className="border-b border-white/10"><td className="p-4 font-semibold">{label}</td><td className="p-4 text-red-300 font-semibold">{safeNum(data.min).toLocaleString()}</td><td className="p-4 text-green-300 font-semibold">{safeNum(data.max).toLocaleString()}</td><td className="p-4 text-yellow-300 font-bold">{Math.floor(avg).toLocaleString()}</td><td className="p-4"><span className={`font-semibold ${vol > 20 ? 'text-red-400' : vol > 10 ? 'text-yellow-400' : 'text-green-400'}`}>{vol.toFixed(1)}%</span></td><td className="p-4">{variation !== null ? <span className={`font-bold ${variation >= 0 ? 'text-green-400' : 'text-red-400'}`}>{variation >= 0 ? '+' : ''}{variation.toFixed(1)}%</span> : '‚Äî'}</td></tr>
                );
            };
            
            const verdict = getDetailedVerdict();
            const tradePlans = calculateTradePlans(player);
            const allDetailedStats = player.detailedStats || {};
            const statsCategories = {
                pace: ['Acceleration', 'Sprint Speed'], shooting: ['Positioning', 'Finishing', 'Shot Power', 'Long Shots', 'Volleys', 'Penalties'],
                passing: ['Vision', 'Crossing', 'FK. Accuracy', 'Short Passing', 'Long Passing', 'Curve'], dribbling: ['Agility', 'Balance', 'Reactions', 'Ball Control', 'Dribbling', 'Composure'],
                defending: ['Interceptions', 'Heading Accuracy', 'Def. Awareness', 'Standing Tackle', 'Sliding Tackle'], physical: ['Jumping', 'Stamina', 'Strength', 'Aggression']
            };
            const priceHistoryData = player.prices || {};
            const priceHistoryKeys = Object.keys(priceHistoryData);
            const getDayLabel = (key) => (key === 'today' ? "Aujourd'hui" : key === 'yesterday' ? "Hier" : `Il y a ${parseInt(key.split('_')[2]) || '?'} jours`);
            const sortedPriceKeys = priceHistoryKeys.sort((a, b) => ((a === 'today' ? 0 : a === 'yesterday' ? 1 : parseInt(a.split('_')[2]) || 99)) - ((b === 'today' ? 0 : b === 'yesterday' ? 1 : parseInt(b.split('_')[2]) || 99)));
            
            const last3DaysKeys = sortedPriceKeys.slice(0, 3);
            const allPrices3d = last3DaysKeys.flatMap(key => priceHistoryData[key] ? [priceHistoryData[key].min, priceHistoryData[key].max] : []).filter(Boolean);
            const min3d = allPrices3d.length > 0 ? Math.min(...allPrices3d) : 'N/A';
            const max3d = allPrices3d.length > 0 ? Math.max(...allPrices3d) : 'N/A';
            const avg3d = last3DaysKeys.length > 0 ? last3DaysKeys.reduce((sum, key) => sum + (priceHistoryData[key]?.avg || 0), 0) / last3DaysKeys.filter(k => priceHistoryData[k]?.avg).length : 'N/A';

            const allPrices7d = sortedPriceKeys.flatMap(key => priceHistoryData[key] ? [priceHistoryData[key].min, priceHistoryData[key].max] : []).filter(Boolean);
            const min7d = allPrices7d.length > 0 ? Math.min(...allPrices7d) : 'N/A';
            const max7d = allPrices7d.length > 0 ? Math.max(...allPrices7d) : 'N/A';
            const avg7d = sortedPriceKeys.length > 0 ? sortedPriceKeys.reduce((sum, key) => sum + (priceHistoryData[key]?.avg || 0), 0) / sortedPriceKeys.filter(k => priceHistoryData[k]?.avg).length : 'N/A';

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="glass-card neon-border p-8 max-w-7xl w-[95%] max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex items-start justify-between mb-6"><div><h2 className="text-4xl font-black gradient-text mb-3">{player.name}</h2><div className="flex flex-wrap items-center gap-3"><span className="stat-badge text-lg px-4 py-2">{player.rating}</span><span className={`card-type-badge text-sm ${getCardTypeClass(player.cardType)}`}>{player.cardType}</span>{getPackStatusBadge(player)}</div></div><button className="text-5xl text-gray-400 hover:text-white transition-colors" onClick={onClose}>√ó</button></div>
                        <div className="flex flex-wrap gap-3 border-b-2 border-purple-500/50 mb-6"><button onClick={() => setTab('avisIA')} className={`py-3 px-6 font-bold text-lg ${tab === 'avisIA' ? 'border-b-4 border-purple-400 text-purple-300' : 'text-gray-400 hover:text-white'}`}>ü§ñ Avis IA Pro</button><button onClick={() => setTab('prices')} className={`py-3 px-6 font-bold text-lg ${tab === 'prices' ? 'border-b-4 border-purple-400 text-purple-300' : 'text-gray-400 hover:text-white'}`}>üí∞ Prix</button><button onClick={() => setTab('infoComplete')} className={`py-3 px-6 font-bold text-lg ${tab === 'infoComplete' ? 'border-b-4 border-purple-400 text-purple-300' : 'text-gray-400 hover:text-white'}`}>üìã Infos Compl√®tes</button><button onClick={() => setTab('stats')} className={`py-3 px-6 font-bold text-lg ${tab === 'stats' ? 'border-b-4 border-purple-400 text-purple-300' : 'text-gray-400 hover:text-white'}`}>üìä Stats D√©taill√©es</button><button onClick={() => setTab('playstyles')} className={`py-3 px-6 font-bold text-lg ${tab === 'playstyles' ? 'border-b-4 border-purple-400 text-purple-300' : 'text-gray-400 hover:text-white'}`}>‚ö° PlayStyles</button></div>
                        {tab === 'avisIA' && (<div className="space-y-6"><div className={`p-6 rounded-lg border-2 ${verdict.color.replace('text-', 'border-')} bg-black/30`}><h3 className={`text-3xl font-black ${verdict.color} mb-4`}>{verdict.title}</h3><p className="text-lg mb-4">{verdict.mainAdvice}</p><div className="mb-6"><h4 className="text-xl font-bold text-purple-300 mb-3">üìä Analyse :</h4><ul className="space-y-2 list-disc list-inside">{verdict.reasons.map((reason, idx) => <li key={idx}>{reason}</li>)}</ul></div><div className="grid md:grid-cols-3 gap-4"><div className="bg-purple-900/20 p-4 rounded-lg"><h5 className="font-bold text-purple-300 mb-2">üìà Strat√©gie</h5><p className="text-sm">{verdict.strategy}</p></div><div className="bg-orange-900/20 p-4 rounded-lg"><h5 className="font-bold text-orange-300 mb-2">‚ö†Ô∏è Risque</h5><p className="text-sm">{verdict.risk}</p></div><div className="bg-blue-900/20 p-4 rounded-lg"><h5 className="font-bold text-blue-300 mb-2">‚è∞ Timing</h5><p className="text-sm">{verdict.timing}</p></div></div></div><div className="grid md:grid-cols-2 gap-6"><div className="glass-card p-6"><h4 className="text-xl font-bold text-orange-300 mb-4">üî• FLIP (24-48h)</h4><div className="space-y-3"><InfoRow label="Achat cible" value={`~${tradePlans.flip.buy.toLocaleString()}`} color="text-red-300"/><InfoRow label="Vente cible" value={`~${tradePlans.flip.sell.toLocaleString()}`} color="text-green-300"/><InfoRow label="Profit net" value={`+${tradePlans.flip.profit.toLocaleString()}`} color="text-yellow-300"/><InfoRow label="ROI" value={`${tradePlans.flip.roi.toFixed(1)}%`} color="text-cyan-300"/></div></div><div className="glass-card p-6"><h4 className="text-xl font-bold text-purple-300 mb-4">üí∞ INVEST (3-7j)</h4><div className="space-y-3"><InfoRow label="Achat cible" value={`~${tradePlans.invest.buy.toLocaleString()}`} color="text-red-300"/><InfoRow label="Vente cible" value={`~${tradePlans.invest.sell.toLocaleString()}`} color="text-green-300"/><InfoRow label="Profit net" value={`+${tradePlans.invest.profit.toLocaleString()}`} color="text-yellow-300"/><InfoRow label="ROI" value={`${tradePlans.invest.roi.toFixed(1)}%`} color="text-cyan-300"/></div></div></div></div>)}
                        {tab === 'prices' && (<div className="space-y-8"><h3 className="text-2xl font-bold text-purple-300">üìä Historique des Prix</h3><div className="overflow-x-auto glass-card"><table className="w-full text-sm"><thead><tr className="border-b-2 border-purple-500/50"><th className="p-4 text-left">Jour</th><th className="p-4 text-left">Prix Min</th><th className="p-4 text-left">Prix Max</th><th className="p-4 text-left">Prix Moyen</th><th className="p-4 text-left">Volatilit√©</th><th className="p-4 text-left">Variation / Jour Pr√©c.</th></tr></thead><tbody>{sortedPriceKeys.map((key, index) => renderPriceRow(getDayLabel(key), priceHistoryData[key], priceHistoryData[sortedPriceKeys[index + 1]]))}</tbody></table></div><div className="grid md:grid-cols-3 gap-6"><div className="glass-card p-4 text-center"><h4 className="font-bold text-lg text-purple-300 mb-2">üìà Tendance 3J</h4><div className={`text-3xl font-black ${tradePlans.avgToday > avg3d ? 'text-green-400' : 'text-red-400'}`}>{tradePlans.avgToday > avg3d ? '‚ÜóÔ∏è HAUSSE' : '‚ÜòÔ∏è BAISSE'}</div></div><div className="glass-card p-4 text-center"><h4 className="font-bold text-lg text-yellow-300 mb-2">üí∞ Prix Actuel</h4><div className="text-3xl font-black text-yellow-300">{Math.floor(tradePlans.avgToday).toLocaleString()}</div></div><div className="glass-card p-4 text-center"><h4 className="font-bold text-lg text-cyan-300 mb-2">üéØ Amplitude Aujourd'hui</h4><div className="text-3xl font-black text-cyan-300">{volDay(player).toFixed(1)}%</div></div></div><div className="grid md:grid-cols-2 gap-6"><div className="glass-card p-6 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border-2 border-yellow-500/30"><h4 className="text-xl font-bold text-yellow-300 mb-4 text-center">‚≠ê R√©capitulatif 3 Jours</h4><div className="grid grid-cols-3 gap-4 text-center"><div><p className="text-sm text-gray-400">Prix MIN</p><p className="text-2xl font-black text-red-400">{typeof min3d === 'number' ? min3d.toLocaleString() : min3d}</p></div><div><p className="text-sm text-gray-400">Prix MAX</p><p className="text-2xl font-black text-green-400">{typeof max3d === 'number' ? max3d.toLocaleString() : max3d}</p></div><div><p className="text-sm text-gray-400">Moyenne</p><p className="text-2xl font-black text-yellow-400">{typeof avg3d === 'number' ? Math.floor(avg3d).toLocaleString() : avg3d}</p></div></div></div><div className="glass-card p-6 bg-gradient-to-r from-indigo-900/30 to-pink-900/30 border-2 border-cyan-500/30"><h4 className="text-xl font-bold text-cyan-300 mb-4 text-center">‚≠ê R√©capitulatif 7 Jours</h4><div className="grid grid-cols-3 gap-4 text-center"><div><p className="text-sm text-gray-400">Prix MIN</p><p className="text-2xl font-black text-red-400">{typeof min7d === 'number' ? min7d.toLocaleString() : min7d}</p></div><div><p className="text-sm text-gray-400">Prix MAX</p><p className="text-2xl font-black text-green-400">{typeof max7d === 'number' ? max7d.toLocaleString() : max7d}</p></div><div><p className="text-sm text-gray-400">Moyenne</p><p className="text-2xl font-black text-yellow-400">{typeof avg7d === 'number' ? Math.floor(avg7d).toLocaleString() : avg7d}</p></div></div></div></div></div>)}
                        {tab === 'infoComplete' && (<div className="space-y-6"><h3 className="text-2xl font-bold text-purple-300 mb-4">üìã Informations Compl√®tes</h3><div className="grid md:grid-cols-2 gap-6"><div className="glass-card p-6"><h4 className="text-xl font-bold text-blue-300 mb-4">üèÜ Club & Comp√©tition</h4><InfoRow label="Club" value={player.info?.Club}/><InfoRow label="Ligue" value={player.info?.League}/><InfoRow label="Nation" value={player.info?.Nation}/><InfoRow label="Position principale" value={player.positions?.main}/><InfoRow label="Positions alt." value={player.positions?.alternatives?.join(', ')}/></div><div className="glass-card p-6"><h4 className="text-xl font-bold text-green-300 mb-4">üë§ Caract√©ristiques</h4><InfoRow label="Taille" value={player.info?.Height}/><InfoRow label="Pied fort" value={player.info?.Foot}/><InfoRow label="Mauvais pied" value={player.info?.['Weak Foot']}/><InfoRow label="Gestes techniques" value={player.info?.['Skill Moves']}/><InfoRow label="Type de corps" value={player.info?.['Body Type']}/></div></div></div>)}
                        {tab === 'stats' && (<div className="space-y-6"><h3 className="text-2xl font-bold text-purple-300 mb-4">üìä Statistiques D√©taill√©es</h3>{Object.entries(statsCategories).map(([category, stats]) => (<div key={category} className="glass-card p-6"><h4 className="text-xl font-bold text-yellow-300 mb-4 capitalize">{category.toUpperCase()}</h4><div className="grid md:grid-cols-2 gap-4">{stats.map(stat => { const value = allDetailedStats[category]?.[stat] || 0; return (<div key={stat} className="flex justify-between items-center p-3 bg-black/30 rounded"><span className="text-gray-300">{stat}:</span><div className="flex items-center gap-3"><div className="w-32 bg-gray-700 rounded-full h-2"><div className={`h-full rounded-full ${value >= 90 ? 'bg-green-500' : value >= 80 ? 'bg-yellow-500' : 'bg-red-500'}`} style={{ width: `${value}%` }}/></div><span className={`font-bold text-lg ${value >= 90 ? 'text-green-400' : value >= 80 ? 'text-yellow-400' : 'text-red-400'}`}>{value}</span></div></div>); })}</div></div>))}</div>)}
                        {tab === 'playstyles' && (<div className="space-y-6"><h3 className="text-2xl font-bold text-purple-300 mb-4">‚ö° PlayStyles</h3>{player.playstyles ? Object.entries(player.playstyles).map(([category, styles]) => styles.plus?.length > 0 || styles.normal?.length > 0 ? (<div key={category} className="glass-card p-6"><h4 className="text-xl font-bold text-cyan-300 mb-4 capitalize">{category}</h4><div className="space-y-4">{styles.plus?.length > 0 && <div><h5 className="text-lg font-semibold text-yellow-300 mb-2">PlayStyles+ ‚≠ê</h5><div className="flex flex-wrap gap-2">{styles.plus.map((style, idx) => <span key={idx} className="playstyle-plus">{style}</span>)}</div></div>}{styles.normal?.length > 0 && <div><h5 className="text-lg font-semibold text-blue-300 mb-2">PlayStyles Normaux</h5><div className="flex flex-wrap gap-2">{styles.normal.map((style, idx) => <span key={idx} className="playstyle-tag">{style}</span>)}</div></div>}</div></div>) : null) : <p>Aucun PlayStyle</p>}</div>)}
                    </div>
                </div>
            );
        }

        /* ===== COMPARATOR ===== */
        function Comparator({ players, onPlayerClick }) {
            const [player1, setPlayer1] = useState(null);
            const [player2, setPlayer2] = useState(null);
            const [searchTerm1, setSearchTerm1] = useState('');
            const [searchTerm2, setSearchTerm2] = useState('');
            const [searchResults1, setSearchResults1] = useState([]);
            const [searchResults2, setSearchResults2] = useState([]);

            useEffect(() => {
                if (searchTerm1.length < 2) {
                    setSearchResults1([]);
                    return;
                }
                const results = players
                    .filter(p => p && p.name && p.name.toLowerCase().includes(searchTerm1.toLowerCase()))
                    .slice(0, 10);
                setSearchResults1(results);
            }, [searchTerm1, players]);

            useEffect(() => {
                if (searchTerm2.length < 2) {
                    setSearchResults2([]);
                    return;
                }
                const results = players
                    .filter(p => p && p.name && p.name.toLowerCase().includes(searchTerm2.toLowerCase()))
                    .slice(0, 10);
                setSearchResults2(results);
            }, [searchTerm2, players]);

            const mainStats = ['PAC', 'SHO', 'PAS', 'DRI', 'DEF', 'PHY'];

            const CompareTable = ({ player, side }) => {
                if (!player) return null;

                const { flip } = calculateTradePlans(player);
                const avgToday = dayAvg(dayData(player));
                const oppScore = calculateOpportunityScore(player);

                return (
                    <div className="glass-card border border-purple-500/30 p-6 rounded-lg">
                        <h3 className={`text-2xl font-bold mb-4 ${side === 'left' ? 'text-blue-300' : 'text-green-300'}`}>
                            {player.name}
                        </h3>

                        <div className="mb-6 space-y-2">
                            <div className="flex justify-between">
                                <span className="text-gray-400">Note:</span>
                                <span className="font-bold text-xl text-yellow-300">{player.rating}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Type:</span>
                                <span className={`card-type-badge ${getCardTypeClass(player.cardType)}`}>
                                    {player.cardType}
                                </span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-400">Poste:</span>
                                <span className="font-semibold">
                                    {player.positions?.main || '‚Äî'}
                                </span>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h4 className="text-lg font-bold text-purple-300 mb-3">Statistiques</h4>
                            {mainStats.map(stat => {
                                const value = player.mainStats?.[stat] || 0;
                                const otherPlayer = side === 'left' ? player2 : player1;
                                const otherValue = otherPlayer?.mainStats?.[stat] || 0;
                                const isBetter = otherPlayer && value > otherValue;
                                return (
                                    <div key={stat} className="flex justify-between py-2 border-b border-white/10">
                                        <span className="text-gray-300">{stat}:</span>
                                        <span className={`font-bold text-lg ${
                                            isBetter ? 'text-green-400' : 'text-white'
                                        }`}>
                                            {value || '‚Äî'} {isBetter && 'üëë'}
                                        </span>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="mb-6">
                            <h4 className="text-lg font-bold text-purple-300 mb-3">Trading</h4>
                            <div className="space-y-2">
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Prix actuel:</span>
                                    <span className="font-bold text-yellow-300">
                                        {avgToday ? Math.floor(avgToday).toLocaleString() : '‚Äî'}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">ROI (Flip):</span>
                                    <span className="font-bold text-cyan-300">
                                        {flip.roi.toFixed(1)}%
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Profit (Flip):</span>
                                    <span className="font-bold text-green-300">
                                        +{flip.profit.toLocaleString()}
                                    </span>
                                </div>
                                <div className="flex justify-between">
                                    <span className="text-gray-400">Score Opp:</span>
                                    <span className="font-bold text-purple-300">
                                        {oppScore}/100
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-gray-400">Pack Status:</span>
                                    {getPackStatusBadge(player)}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="glass-card neon-border p-6">
                    <div className="section-header mb-6">
                        <h2 className="text-3xl font-black gradient-text">‚öñÔ∏è Comparateur de Joueurs</h2>
                        <p className="text-gray-400 mt-2">Comparaison d√©taill√©e c√¥te √† c√¥te</p>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label className="text-sm text-gray-400 mb-2 block">Joueur 1 (Bleu)</label>
                            {!player1 ? (
                                <>
                                    <input className="form-input" placeholder="üîç Rechercher..." value={searchTerm1} onChange={e => setSearchTerm1(e.target.value)}/>
                                    {searchResults1.length > 0 && <div className="mt-2 space-y-2 max-h-60 overflow-y-auto">{searchResults1.map(p => <div key={p.id} className="p-3 bg-gray-800 rounded cursor-pointer hover:bg-gray-700" onClick={() => {setPlayer1(p); setSearchTerm1(''); setSearchResults1([]);}}><span className="font-bold">{p.name}</span><span className="text-gray-400 ml-2">({p.rating})</span></div>)}</div>}
                                </>
                            ) : (
                                <div className="p-4 bg-blue-900/20 border border-blue-500/30 rounded flex justify-between items-center">
                                    <span className="font-bold text-lg text-blue-300">{player1.name}</span>
                                    <button onClick={() => setPlayer1(null)} className="text-red-400 hover:text-red-300 text-xl">‚úï</button>
                                </div>
                            )}
                        </div>
                        <div>
                            <label className="text-sm text-gray-400 mb-2 block">Joueur 2 (Vert)</label>
                            {!player2 ? (
                                <>
                                    <input className="form-input" placeholder="üîç Rechercher..." value={searchTerm2} onChange={e => setSearchTerm2(e.target.value)}/>
                                    {searchResults2.length > 0 && <div className="mt-2 space-y-2 max-h-60 overflow-y-auto">{searchResults2.map(p => <div key={p.id} className="p-3 bg-gray-800 rounded cursor-pointer hover:bg-gray-700" onClick={() => {setPlayer2(p); setSearchTerm2(''); setSearchResults2([]);}}><span className="font-bold">{p.name}</span><span className="text-gray-400 ml-2">({p.rating})</span></div>)}</div>}
                                </>
                            ) : (
                                <div className="p-4 bg-green-900/20 border border-green-500/30 rounded flex justify-between items-center">
                                    <span className="font-bold text-lg text-green-300">{player2.name}</span>
                                    <button onClick={() => setPlayer2(null)} className="text-red-400 hover:text-red-300 text-xl">‚úï</button>
                                </div>
                            )}
                        </div>
                    </div>

                    {(player1 || player2) && (
                        <div className="grid md:grid-cols-2 gap-6">
                            <CompareTable player={player1} side="left" />
                            <CompareTable player={player2} side="right" />
                        </div>
                    )}
                    {!player1 && !player2 && (
                        <div className="text-center py-16">
                            <div className="text-6xl mb-4">‚öñÔ∏è</div>
                            <p className="text-xl text-gray-400">S√©lectionnez deux joueurs pour commencer la comparaison</p>
                        </div>
                    )}
                </div>
            );
        }

        /* ===== EVOLUTION ANALYZER (PARTIE 1) ===== */
        function EvolutionAnalyzer({ players, onPlayerClick }) {
            const [filters, setFilters] = useState({ ratingMin: '', ratingMax: '', positionsAllowed: [], positionsForbidden: [], PACmin: '', PACmax: '', SHOmin: '', SHOmax: '', PASmin: '', PASmax: '', DRImin: '', DRImax: '', DEFmin: '', DEFmax: '', PHYmin: '', PHYmax: '', playstylesNormalMin: '', playstylesNormalMax: '', playstylesPlusMin: '', playstylesPlusMax: '', excludeNormalPS: [], excludePlusPS: [] });
            const [sort, setSort] = useState({ key: 'evoScore', dir: 'desc' });
            const [shoppingList, setShoppingList] = useState([]);
            const shoppingListIds = useMemo(() => new Set(shoppingList.map(p => p.id)), [shoppingList]);

            useEffect(() => { try { const saved = localStorage.getItem('evoShoppingList'); if (saved) setShoppingList(JSON.parse(saved)); } catch (e) {} }, []);
            useEffect(() => { localStorage.setItem('evoShoppingList', JSON.stringify(shoppingList)); }, [shoppingList]);
            
            const addToShoppingList = useCallback((player) => {
                setShoppingList(prev => {
                    if (prev.some(p => p.id === player.id)) return prev;
                    const price = dayAvg(dayData(player)) || 0;
                    const buyTarget = Math.floor(price * 0.95);
                    return [...prev, { id: player.id, name: player.name, rating: player.rating, evoScore: player.evoScore, price, buyTarget, iaCommentary: player.iaCommentary }];
                });
            }, []);
            const removeFromShoppingList = (playerId) => setShoppingList(prev => prev.filter(p => p.id !== playerId));
            const clearShoppingList = () => { if(confirm('Vider la shopping list ?')) setShoppingList([]); };

            const allPositions = useMemo(() => { const s = new Set(); players.forEach(p => { if (p.positions?.main) s.add(p.positions.main); if (p.positions?.alternatives) p.positions.alternatives.forEach(pos => s.add(pos)); }); return Array.from(s).sort(); }, [players]);
            const allPlaystyles = useMemo(() => { const s = new Set(); players.forEach(p => { if (p.playstyles) { Object.values(p.playstyles).forEach(cat => { if (cat.normal) cat.normal.forEach(ps => s.add(ps)); }); } }); return Array.from(s).sort(); }, [players]);
            const allPlusPlaystyles = useMemo(() => { const s = new Set(); players.forEach(p => { if (p.playstyles) { Object.values(p.playstyles).forEach(cat => { if (cat.plus) cat.plus.forEach(ps => s.add(ps)); }); } }); return Array.from(s).sort(); }, [players]);
            
            const updateFilter = (key, value) => setFilters(prev => ({ ...prev, [key]: value }));
            const togglePosition = (pos, type) => setFilters(prev => { const key = type === 'allowed' ? 'positionsAllowed' : 'positionsForbidden'; const list = prev[key].includes(pos) ? prev[key].filter(p => p !== pos) : [...prev[key], pos]; return {...prev, [key]: list}; });
            const toggleExcludePS = (ps, isPlus) => { const key = isPlus ? 'excludePlusPS' : 'excludeNormalPS'; setFilters(prev => { const list = prev[key].includes(ps) ? prev[key].filter(p => p !== ps) : [...prev[key], ps]; return {...prev, [key]: list}; }); };
            
            const checkStatRange = (value, min, max) => { const val = safeNum(value, 0); if (min !== '' && val < Number(min)) return false; if (max !== '' && val > Number(max)) return false; return true; };
            const getPlayerPositions = (p) => [p.positions?.main, ...(p.positions?.alternatives || [])].filter(Boolean);
            const countPlaystyles = (p) => { const ps = p.playstyles || {}; let nC = 0, pC = 0, nS = new Set(), pS = new Set(); Object.values(ps).forEach(cat => { if (cat.normal) { nC += cat.normal.length; cat.normal.forEach(s => nS.add(s)); } if (cat.plus) { pC += cat.plus.length; cat.plus.forEach(s => pS.add(s)); } }); return { normalCount: nC, plusCount: pC, normalSet: nS, plusSet: pS }; };
                        const calculateEvoScore = (p) => {
                let score = 0; const price = dayAvg(dayData(p)) || 5000; const { normalCount, plusCount } = countPlaystyles(p); let metaScore = 0;
                const pN = ['France','Brazil','England','Spain','Germany']; const pL = ['Premier League','LaLiga Santander']; const pC = ['Real Madrid','FC Barcelona','Man Utd','Man City'];
                if(pN.includes(p.info?.Nation)) metaScore+=15; if(pL.includes(p.info?.League)) metaScore+=10; if(pC.includes(p.info?.Club)) metaScore+=5;
                metaScore += ((p.info?.['Skill Moves']||0)>=4?(p.info['Skill Moves']-3)*5:0); metaScore += ((p.info?.['Weak Foot']||0)>=4?(p.info['Weak Foot']-3)*5:0);
                if (p.info?.['Body Type']?.toLowerCase().includes('lean')) metaScore+=10;
                score += (metaScore/50) * 40;
                const totalStats = Object.values(p.mainStats||{}).reduce((a,b)=>a+b,0);
                score += Math.min(30, (totalStats > 0 ? (totalStats * 1000) / price : 0) / 10);
                score += Math.min(20, ((normalCount * 2) + (plusCount * 10)) / 2);
                return Math.min(100, Math.round(score));
            };
            const getRelevantStats = (p) => {const s=[]; if(p.mainStats?.PAC>90)s.push(`${p.mainStats.PAC} PAC`); if(p.info?.['Skill Moves']>=5)s.push(`5‚òÖ GT`); if(p.info?.['Weak Foot']>=5)s.push(`5‚òÖ MP`); if(s.length===0){const sortS=Object.entries(p.mainStats||{}).sort((a,b)=>b[1]-a[1]); if(sortS[0])s.push(`${sortS[0][1]} ${sortS[0][0]}`);} return s.join(' | ');};
            const getIACommentary = (p, score) => {if(score>90)return"ü§ñ P√âPITE ABSOLUE! Potentiel m√©ta monstrueux.";if(score>80)return"ü§ñ EXCELLENT CHOIX. Liens faciles et stats cl√©s.";if(score>70)return"ü§ñ BON PARI. Rapport Q/P tr√®s intelligent.";return"ü§ñ Option viable, mais il y a mieux.";};
            
            const matches = useMemo(() => {
                return players.filter(p => {
                    if(!p) return false;
                    const {normalSet,plusSet,normalCount,plusCount}=countPlaystyles(p);
                    if(!checkStatRange(p.rating,filters.ratingMin,filters.ratingMax))return false;
                    const pPos=getPlayerPositions(p);
                    if(filters.positionsAllowed.length>0 && !pPos.some(pos=>filters.positionsAllowed.includes(pos)))return false;
                    if(filters.positionsForbidden.length>0 && pPos.some(pos=>filters.positionsForbidden.includes(pos)))return false;
                    const ms=p.mainStats||{};
                    if(!checkStatRange(ms.PAC,filters.PACmin,filters.PACmax)||!checkStatRange(ms.SHO,filters.SHOmin,filters.SHOmax)||!checkStatRange(ms.PAS,filters.PASmin,filters.PASmax)||!checkStatRange(ms.DRI,filters.DRImin,filters.DRImax)||!checkStatRange(ms.DEF,filters.DEFmin,filters.DEFmax)||!checkStatRange(ms.PHY,filters.PHYmin,filters.PHYmax))return false;
                    if(!checkStatRange(normalCount,filters.playstylesNormalMin,filters.playstylesNormalMax)||!checkStatRange(plusCount,filters.playstylesPlusMin,filters.playstylesPlusMax))return false;
                    if(filters.excludeNormalPS.length>0&&filters.excludeNormalPS.some(ps=>normalSet.has(ps)))return false;
                    if(filters.excludePlusPS.length>0&&filters.excludePlusPS.some(ps=>plusSet.has(ps)))return false;
                    return true;
                }).map(p => ({...p, price:dayAvg(dayData(p))||0, evoScore:calculateEvoScore(p), relevantStats:getRelevantStats(p), iaCommentary:getIACommentary(p,calculateEvoScore(p))})
                ).sort((a,b)=>{const vA=a[sort.key]??0; const vB=b[sort.key]??0; if(typeof vA==='string')return sort.dir==='asc'?vA.localeCompare(vB):vB.localeCompare(vA); return sort.dir==='asc'?vA-vB:vB-vA;});
            }, [players, filters, sort]);

            const StatRangeInput = ({l,mK,xK}) => (<div className="glass-card p-4"><div className="font-semibold text-purple-300 mb-3 text-center text-lg">{l}</div><div className="grid grid-cols-2 gap-3"><input className="form-input text-center" type="number" placeholder="Min" value={filters[mK]} onChange={e=>updateFilter(mK,e.target.value)} /><input className="form-input text-center" type="number" placeholder="Max" value={filters[xK]} onChange={e=>updateFilter(xK,e.target.value)}/></div></div>);
            const Th=({k,l})=>(<th className="p-4 cursor-pointer" onClick={()=>setSort(s=>s.key===k?{...s,dir:s.dir==='asc'?'desc':'asc'}:{key:k,dir:'desc'})}><div className="flex items-center gap-1">{l}<span className="text-xs opacity-70">{sort.key===k?(sort.dir==='asc'?'‚Üë':'‚Üì'):'‚Üï'}</span></div></th>);
            
            return (<div className="glass-card p-6"><div className="section-header mb-6"><h2 className="text-3xl font-black gradient-text">üß¨ Analyseur d'√âvolutions</h2></div><div className="grid lg:grid-cols-4 md:grid-cols-3 gap-4 mb-6"><StatRangeInput l="NOTE" mK="ratingMin" xK="ratingMax"/><StatRangeInput l="PAC" mK="PACmin" xK="PACmax"/><StatRangeInput l="SHO" mK="SHOmin" xK="SHOmax"/><StatRangeInput l="PAS" mK="PASmin" xK="PASmax"/><StatRangeInput l="DRI" mK="DRImin" xK="DRImax"/><StatRangeInput l="DEF" mK="DEFmin" xK="DEFmax"/><StatRangeInput l="PHY" mK="PHYmin" xK="PHYmax"/></div><div className="grid md:grid-cols-2 gap-6 mb-6"><div className="glass-card p-5"><h3 className="text-lg font-bold text-green-300 mb-3">‚úÖ Postes AUTORIS√âS</h3><div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{allPositions.map(p=><button key={p} onClick={()=>togglePosition(p,'allowed')} className={`px-3 py-2 rounded-lg text-sm font-bold ${filters.positionsAllowed.includes(p)?'bg-green-600':'bg-gray-700'}`}>{p}</button>)}</div></div><div className="glass-card p-5"><h3 className="text-lg font-bold text-red-300 mb-3">‚ùå Postes INTERDITS</h3><div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{allPositions.map(p=><button key={p} onClick={()=>togglePosition(p,'forbidden')} className={`px-3 py-2 rounded-lg text-sm font-bold ${filters.positionsForbidden.includes(p)?'bg-red-600':'bg-gray-700'}`}>{p}</button>)}</div></div></div><div className="grid md:grid-cols-2 gap-6 mb-6"><div className="glass-card p-4"><label className="text-lg font-semibold text-yellow-300 mb-2 block">Playstyles Normaux (Min/Max)</label><StatRangeInput label="" mK="playstylesNormalMin" xK="playstylesNormalMax"/></div><div className="glass-card p-4"><label className="text-lg font-semibold text-orange-300 mb-2 block">Playstyles+ (Min/Max)</label><StatRangeInput label="" mK="playstylesPlusMin" xK="playstylesPlusMax"/></div></div><div className="grid md:grid-cols-2 gap-6 mb-6"><div className="glass-card p-5"><h3 className="text-lg font-bold text-cyan-300 mb-3">üö´ Exclure si poss√®de (Normal)</h3><div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{allPlaystyles.map(p=><button key={p} onClick={()=>toggleExcludePS(p,false)} className={`px-3 py-2 rounded-lg text-sm font-bold ${filters.excludeNormalPS.includes(p)?'bg-cyan-600':'bg-gray-700'}`}>{p}</button>)}</div></div><div className="glass-card p-5"><h3 className="text-lg font-bold text-cyan-300 mb-3">üö´ Exclure si poss√®de (Playstyle+)</h3><div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto">{allPlusPlaystyles.map(p=><button key={p} onClick={()=>toggleExcludePS(p,true)} className={`px-3 py-2 rounded-lg text-sm font-bold ${filters.excludePlusPS.includes(p)?'bg-cyan-600':'bg-gray-700'}`}>{p}</button>)}</div></div></div><div className="mb-6 text-center"><span className="text-2xl font-bold text-yellow-300">{matches.length} joueur{matches.length>1?'s':''} √©ligible{matches.length>1?'s':''}</span></div><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr><Th k="name" label="Joueur"/><Th k="rating" label="Note"/><Th k="cardType" label="Type"/><th className="p-4">Postes</th><Th k="price" label="Prix"/><Th k="evoScore" label="Evo Score"/><th className="p-4">Stats Cl√©s</th><th className="p-4">ü§ñ Avis IA</th><th className="p-4">Action</th></tr></thead><tbody>{matches.slice(0,100).map(p=><tr key={p.id} className="border-b border-white/10 row-hover"><td className="p-4 font-bold whitespace-nowrap cursor-pointer" onClick={()=>onPlayerClick(p)}>{p.name}</td><td className="p-4 text-center"><span className="stat-badge">{p.rating}</span></td><td className="p-4 text-center"><span className={`card-type-badge ${getCardTypeClass(p.cardType)}`}>{p.cardType}</span></td><td className="p-4"><div className="flex flex-wrap gap-1">{getPlayerPositions(p).map((pos,idx)=><span key={idx} className="text-xs bg-purple-600 px-2 py-1 rounded">{pos}</span>)}</div></td><td className="p-4 text-center font-semibold text-yellow-300">{p.price>0?p.price.toLocaleString():'N/A'}</td><td className="p-4 text-center"><span className={`font-black text-xl ${p.evoScore>85?'text-green-400':p.evoScore>70?'text-yellow-400':'text-gray-400'}`}>{p.evoScore}</span></td><td className="p-4 text-xs font-semibold text-cyan-300 whitespace-nowrap">{p.relevantStats}</td><td className="p-4 text-xs max-w-xs">{p.iaCommentary}</td><td className="p-4 text-center"><button onClick={()=>addToShoppingList(p)} className={`text-xs px-3 py-1 rounded ${shoppingListIds.has(p.id)?'bg-gray-600':'bg-green-600'}`} disabled={shoppingListIds.has(p.id)}>{shoppingListIds.has(p.id)?'‚úÖ':'+'}</button></td></tr>)}</tbody></table></div>{shoppingList.length>0&&<div className="mt-12 glass-card p-6"><div className="flex justify-between items-center mb-4"><h3 className="text-2xl font-bold text-green-300">üõí Shopping List ({shoppingList.length})</h3><button onClick={clearShoppingList} className="text-xs px-3 py-1 bg-red-600 rounded">Vider</button></div><div className="space-y-4 max-h-96 overflow-y-auto pr-2">{shoppingList.map(i=><div key={i.id} className="bg-slate-800/60 p-4 rounded-lg"><div className="flex justify-between items-start"><div><p className="font-bold text-lg cursor-pointer" onClick={()=>onPlayerClick(players.find(p=>p.id===i.id))}>{i.name} <span className="text-gray-400">({i.rating})</span></p><span className="text-xs text-yellow-300">Prix: {i.price.toLocaleString()} | Evo Score: {i.evoScore}</span></div><button onClick={()=>removeFromShoppingList(i.id)} className="text-red-400 text-xl">‚úï</button></div><div className="mt-3 pt-3 border-t border-white/10 text-sm"><p className="text-blue-300 font-semibold">üéØ Achat Cible: {i.buyTarget.toLocaleString()}</p><p className="text-gray-400 text-xs mt-1">ü§ñ <span className="italic">"{i.iaCommentary}"</span></p></div></div>)}</div></div>}</div>);
        }

        /* ===== LEAK ANALYZER V28 ===== */
        function LeakAnalyzer({ players }) {
            const [form, setForm] = useState({ name: '', rating: '', cardType: '', positions: [], league: '', club: '', nation: '', PAC: '', SHO: '', PAS: '', DRI: '', DEF: '', PHY: '', playstyles: [], playstylesPlus: [] });
            const [results, setResults] = useState(null);
            const [modalPlayer, setModalPlayer] = useState(null);
            const [maxBudget, setMaxBudget] = useState(5000000);

            const handleChange = (key, value) => setForm(prev => ({ ...prev, [key]: value }));
            const togglePosition = (pos) => setForm(prev => ({ ...prev, positions: prev.positions.includes(pos) ? prev.positions.filter(p => p !== pos) : [...prev.positions, pos] }));
            const togglePlaystyle = (ps, isPlus) => { const key = isPlus ? 'playstylesPlus' : 'playstyles'; setForm(prev => ({ ...prev, [key]: prev[key].includes(ps) ? prev[key].filter(p => p !== ps) : [...prev[key], ps] })); };

            const allPositions = ['ST', 'CF', 'LW', 'RW', 'CAM', 'CM', 'CDM', 'LM', 'RM', 'LWB', 'RWB', 'LB', 'RB', 'CB', 'GK'];
            const allCardTypes = useMemo(() => { const s = new Set(['']); players.forEach(p => { if (p.cardType) s.add(p.cardType); }); return Array.from(s).sort(); }, [players]);
            const allPlaystyles = useMemo(() => { const s = new Set(); players.forEach(p => { if (p.playstyles) { Object.values(p.playstyles).forEach(cat => { if (cat.normal) cat.normal.forEach(ps => s.add(ps)); if(cat.plus) cat.plus.forEach(ps => s.add(ps)); }); } }); return Array.from(s).sort(); }, [players]);

            const analyze = (e) => {
                e.preventDefault();
                setResults(null); 
                setTimeout(() => {
                    const getCompetitionScore = (p) => {
                        let score = 0;
                        if (form.rating && p.rating && Math.abs(form.rating - p.rating) <= 1) { score += 30; } else if (form.rating && p.rating) { return 0; }
                        const pPos = [p.positions?.main, ...(p.positions?.alternatives || [])].filter(Boolean);
                        if (form.positions.length > 0 && form.positions.some(pos => pPos.includes(pos))) { score += 40; } else { return 0; }
                        
                        const pStats = p.mainStats || {}; const formStats = { PAC: form.PAC, SHO: form.SHO, PAS: form.PAS, DRI: form.DRI, DEF: form.DEF, PHY: form.PHY };
                        let statSimilarity = 0, statCount = 0;
                        for (const key in formStats) { if (formStats[key] && pStats[key]) { statSimilarity += Math.max(0, 100 - (Math.abs(formStats[key] - pStats[key]) * 6)); statCount++; } }
                        if (statCount > 2) score += (statSimilarity / statCount) / 100 * 30;
                        
                        return Math.min(100, Math.round(score));
                    };

                    const getLinkScore = (p) => {
                        let score = 0;
                        const popularNations = ['France', 'Brazil', 'England', 'Spain', 'Germany', 'Netherlands', 'Portugal', 'Argentina'];
                        const popularLeagues = ['Premier League', 'LaLiga Santander', 'Serie A TIM', 'Bundesliga', 'Ligue 1 Uber Eats'];
                        if (form.club && p.info?.Club === form.club) score += 50;
                        if (form.nation && p.info?.Nation === form.nation) score += popularNations.includes(form.nation) ? 35 : 20;
                        if (form.league && p.info?.League === form.league) score += popularLeagues.includes(form.league) ? 25 : 15;
                        return Math.min(100, score);
                    };

                    const getEst = (p,s,u) => {const pr=dayAvg(dayData(p)); if(!pr)return{r:'N/A',p:0}; let pct=(s/100)*(u?30:-25); const t=pr*(1+pct/100); return{r:`~${(Math.round(t/1000)*1000).toLocaleString()}`,p:pct};};
                    const getCom = (s,l) => {if(l){if(s>80)return{t:"LIEN PARFAIT",m:"Achat prioritaire, la hype va √™tre maximale.",c:"green"};if(s>60)return{t:"LIEN FORT",m:"Tr√®s bon potentiel de hausse.",c:"green"};return{t:"LIEN MOD√âR√â",m:"A surveiller si le prix est bas.",c:"yellow"};}else{if(s>80)return{t:"CONCURRENT DIRECT",m:"Vente imm√©diate recommand√©e.",c:"red"};if(s>60)return{t:"GROS CONCURRENT",m:"Risque de baisse √©lev√©.",c:"red"};return{t:"CONCURRENCE FAIBLE",m:"Impact limit√©.",c:"yellow"};}};
                    
                    const baseFilter = p => (dayAvg(dayData(p)) || 0) >= 2500;
                    const budgetFilter = p => (dayAvg(dayData(p)) || 0) <= maxBudget;
                    const competitors = players.filter(baseFilter).map(p=>({p,s:getCompetitionScore(p)})).filter(i=>i.s>50).map(i=>({...i,e:getEst(i.p,i.s,false),c:getCom(i.s,false)})).sort((a,b)=>b.s-a.s);
                    const links = players.filter(baseFilter).filter(budgetFilter).map(p=>({p,s:getLinkScore(p)})).filter(i=>i.s>30).map(i=>({...i,e:getEst(i.p,i.s,true),c:getCom(i.s,true)})).sort((a,b)=>b.s-a.s);
                    setResults({competitors, links});
                }, 50);
            };
            
            const ResultCard = ({ item, isLink }) => {
                const { p, s, e, c } = item;
                const price = dayAvg(dayData(p));
                return (<div className={`p-4 mb-4 rounded-lg bg-slate-800/50 border border-${c.c}-900 cursor-pointer`} onClick={()=>setModalPlayer(p)}><div className="flex justify-between items-center"><p className="text-xl font-bold">{p.name} <span className="text-gray-400">({p.rating})</span></p><span className={`font-black text-2xl text-${c.c}-400`}>{s}/100</span></div><div className="text-xs text-gray-400 mb-3">{p.cardType} ‚Ä¢ Prix: <span className="text-yellow-300 font-bold">{price?.toLocaleString()||'N/A'}</span></div><div className={`p-3 rounded-lg bg-${c.c}-900/30 border-l-4 border-${c.c}-500`}><h4 className={`font-bold text-lg text-${c.c}-400`}>ü§ñ {c.t}</h4><p className="text-sm italic">"{c.m}"</p></div><div className="mt-2 text-center text-sm">Prix estim√©: <span className={`font-bold text-${c.c}-300`}>{e.r} ({e.p>0?'+':''}{e.p.toFixed(0)}%)</span></div></div>);
            };

            return (
                <>
                    <div className="glass-card neon-border p-8">
                        <div className="section-header mb-6"><h2 className="text-3xl font-black gradient-text">üîç Analyseur de Leaks</h2></div>
                        <div className="glass-card p-6 rounded-lg mb-6"><label className="text-lg font-semibold text-yellow-300 block mb-2">üí∞ Budget Max d'Achat : {maxBudget.toLocaleString()} cr√©dits</label><input type="range" min="10000" max="5000000" step="10000" value={maxBudget} onChange={e => setMaxBudget(Number(e.target.value))} className="w-full"/></div>
                        <form onSubmit={analyze} className="space-y-6 mb-8">
                            <div className="glass-card p-6 rounded-lg"><h3 className="font-bold text-xl text-purple-300 mb-4">üìã Infos Carte Leak√©e</h3><div className="grid md:grid-cols-3 gap-4"><input className="form-input" placeholder="Note" type="number" value={form.rating} onChange={e=>handleChange('rating',e.target.value)} required/><select className="form-input" value={form.cardType} onChange={e=>handleChange('cardType',e.target.value)}><option value="">Type de carte...</option>{allCardTypes.map(ct=><option key={ct} value={ct}>{ct}</option>)}</select><select className="form-input" value={form.league} onChange={e=>handleChange('league',e.target.value)}><option value="">Ligue...</option>{LEAGUES_DATA.map(lg=><option key={lg} value={lg}>{lg}</option>)}</select><select className="form-input" value={form.club} onChange={e=>handleChange('club',e.target.value)}><option value="">Club...</option>{CLUBS_DATA.map(cl=><option key={cl} value={cl}>{cl}</option>)}</select><select className="form-input" value={form.nation} onChange={e=>handleChange('nation',e.target.value)}><option value="">Nation...</option>{NATIONS_DATA.map(nat=><option key={nat} value={nat}>{nat}</option>)}</select></div></div>
                            <div className="glass-card p-6 rounded-lg"><h3 className="font-bold text-xl text-cyan-300 mb-4">üìç Poste(s)</h3><div className="flex flex-wrap gap-2">{allPositions.map(pos=><button type="button" key={pos} onClick={()=>togglePosition(pos)} className={`px-4 py-2 rounded-lg font-bold ${form.positions.includes(pos)?'bg-cyan-600':'bg-gray-700'}`}>{pos}</button>)}</div></div>
                            <div className="glass-card p-6 rounded-lg"><h3 className="font-bold text-xl text-yellow-300 mb-4">üìä Stats (Optionnel)</h3><div className="grid grid-cols-2 md:grid-cols-6 gap-4">{['PAC','SHO','PAS','DRI','DEF','PHY'].map(s=><div key={s}><label className="text-sm text-gray-400 block mb-1">{s}</label><input type="number" className="form-input text-center" value={form[s]} onChange={e=>handleChange(s,e.target.value)}/></div>)}</div></div>
                            <button type="submit" className="tab-button active w-full text-lg">üöÄ Analyser</button>
                        </form>
                        {results && <div className="grid md:grid-cols-2 gap-8 mt-12">
                            <div><h3 className="font-bold text-2xl text-red-400 mb-4">üìâ Joueurs √† VENDRE</h3>{results.competitors.length>0 ? results.competitors.map(item=><ResultCard key={item.p.id} item={item} isLink={false}/>):<div className="p-8 text-center text-gray-500">Aucun concurrent majeur.</div>}</div>
                            <div><h3 className="font-bold text-2xl text-green-400 mb-4">üìà Joueurs √† ACHETER</h3>{results.links.length>0 ? results.links.map(item=><ResultCard key={item.p.id} item={item} isLink={true}/>):<div className="p-8 text-center text-gray-500">Aucun lien clair.</div>}</div>
                        </div>}
                    </div>
                    {modalPlayer && <PlayerModal player={modalPlayer} onClose={() => setModalPlayer(null)} />}
                </>
            );
        }

        /* ===== TRADING LAB ===== */
        function TradingLab({ players, user, platform }) {
            const [activeCategory, setActiveCategory] = useState('flip');
            const [showAddModal, setShowAddModal] = useState(false);
            const [trades, setTrades] = useState({ flip: [], invest: [], specul: [], sbc: [] });

            const CloudSync = {
                save: (user, platform, key, data) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error('CloudSync save error:', e);
                        return false;
                    }
                },
                load: (user, platform, key) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        const data = localStorage.getItem(storageKey);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('CloudSync load error:', e);
                        return null;
                    }
                }
            };

            useEffect(() => {
                const loadTrades = async () => {
                    if (user && platform) {
                        const data = await CloudSync.load(user, platform, 'tradinglab');
                        if (data && data.flip) {
                            setTrades(data);
                        }
                    }
                };
                loadTrades();
            }, [user, platform]);

            useEffect(() => {
                if (user && platform && (trades.flip.length > 0 || trades.invest.length > 0 || trades.specul.length > 0 || trades.sbc.length > 0)) {
                    CloudSync.save(user, platform, 'tradinglab', trades);
                }
            }, [trades, user, platform]);

            useEffect(() => {
                if (players.length === 0) return;
                const updatedTrades = JSON.parse(JSON.stringify(trades));
                let hasChanges = false;

                Object.keys(updatedTrades).forEach(category => {
                    updatedTrades[category] = updatedTrades[category].map(trade => {
                        if (trade.status === 'sold') return trade;
                        const player = players.find(p => p.id === trade.playerId);
                        if (player) {
                            const currentPrice = dayAvg(dayData(player));
                            if (currentPrice && currentPrice !== trade.currentPrice) {
                                hasChanges = true;
                                const diff = currentPrice - trade.buyPrice;
                                const diffPercent = trade.buyPrice > 0 ? (diff / trade.buyPrice) * 100 : 0;
                                return { ...trade, currentPrice: Math.floor(currentPrice), targetReached: currentPrice >= trade.sellTarget, currentLoss: diffPercent < 0 ? Math.abs(diffPercent) : 0, daysHeld: Math.floor((Date.now() - trade.addedAt) / 86400000) };
                            }
                        }
                        return trade;
                    });
                });
                if (hasChanges) setTrades(updatedTrades);
            }, [players]);
            
            const addTrade = (tradeData) => { const newTrade = { id: Date.now(), ...tradeData, addedAt: Date.now(), status: 'stock', currentPrice: tradeData.buyPrice, targetReached: false, currentLoss: 0, daysHeld: 0 }; setTrades(p => ({ ...p, [tradeData.category]: [...(p[tradeData.category] || []), newTrade] })); setShowAddModal(false); };
            const markAsSold = (cat, id, price) => { setTrades(p => ({ ...p, [cat]: p[cat].map(t => t.id === id ? { ...t, status: 'sold', soldPrice: price, soldAt: Date.now() } : t) })); };
            const deleteTrade = (cat, id) => { if (confirm('Supprimer ?')) setTrades(p => ({ ...p, [cat]: p[cat].filter(t => t.id !== id) })); };
            const editTrade = (cat, id, updates) => { setTrades(p => ({ ...p, [cat]: p[cat].map(t => t.id === id ? { ...t, ...updates } : t) })); };
            
            const getCategoryStats = (category) => {
                const categoryTrades = trades[category] || [];
                const stock = categoryTrades.filter(t => t.status === 'stock');
                const sold = categoryTrades.filter(t => t.status === 'sold');
                const invested = stock.reduce((sum, t) => sum + t.buyPrice, 0);
                const stockValue = stock.reduce((sum, t) => sum + (t.currentPrice || t.buyPrice), 0);
                const profits = sold.map(t => (t.soldPrice * 0.95) - t.buyPrice);
                const totalProfit = profits.reduce((sum, p) => sum + p, 0);
                const avgROI = sold.length > 0 ? profits.reduce((sum,p,i)=>sum+(p/sold[i].buyPrice*100),0)/sold.length : 0;
                return { invested, stockValue, stockCount: stock.length, soldCount: sold.length, totalProfit, avgROI };
            };
            const getAllStats = () => { const cats=['flip','invest','specul','sbc']; const t={invested:0,stockValue:0,totalProfit:0,stockCount:0,soldCount:0}; cats.forEach(c=>{const s=getCategoryStats(c); t.invested+=s.invested;t.stockValue+=s.stockValue;t.totalProfit+=s.totalProfit;t.stockCount+=s.stockCount;t.soldCount+=s.soldCount;}); return t; };

            function TradingCategory({ category, trades, onAdd, onMarkSold, onDelete, onEdit, stats }) {
                const labels={flip:'üî• FLIP',invest:'üí∞ INVEST',specul:'üéØ SP√âCUL',sbc:'üì¶ SBC'};
                return (
                    <div>
                        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 text-center">
                            <div className="glass-card p-4"><div className="text-2xl font-black text-purple-300">{stats.invested.toLocaleString()}</div><div className="text-xs text-gray-400">Investi</div></div>
                            <div className="glass-card p-4"><div className="text-2xl font-black text-blue-300">{stats.stockCount}</div><div className="text-xs text-gray-400">En Stock</div></div>
                            <div className="glass-card p-4"><div className="text-2xl font-black text-green-300">{stats.soldCount}</div><div className="text-xs text-gray-400">Vendus</div></div>
                            <div className="glass-card p-4"><div className="text-2xl font-black text-yellow-300">+{stats.totalProfit.toLocaleString()}</div><div className="text-xs text-gray-400">Profit</div></div>
                            <div className="glass-card p-4"><div className="text-2xl font-black text-cyan-300">{stats.avgROI.toFixed(1)}%</div><div className="text-xs text-gray-400">ROI Moyen</div></div>
                        </div>
                        <button className="tab-button active mb-6" onClick={onAdd}>‚ûï Ajouter un {category.toUpperCase()}</button>
                        <h3 className="text-2xl font-bold mb-4 text-purple-300">{labels[category]}</h3>
                        <div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr><th>Date</th><th>Joueur</th><th>Achat</th><th>Cible</th><th>Actuel</th><th>√âvo.</th><th>ROI</th><th>Statut</th><th>Profit</th><th>Actions</th></tr></thead><tbody>
                        {(trades||[]).map(t=>{const diff=(t.currentPrice||t.buyPrice)-t.buyPrice;const dP=t.buyPrice>0?(diff/t.buyPrice)*100:0;const eP=Math.floor(t.sellTarget*0.95-t.buyPrice);const aP=t.soldPrice?Math.floor(t.soldPrice*0.95-t.buyPrice):eP;const roi=t.buyPrice>0?(t.soldPrice?(aP/t.buyPrice*100):(eP/t.buyPrice*100)):0;const tD=t.daysHeld>0?`${t.daysHeld}j`:`${Math.floor((Date.now()-t.addedAt)/3600000)}h`;return(<tr key={t.id} className="border-b border-white/10"><td><div className="text-xs">{new Date(t.addedAt).toLocaleDateString('fr-FR')}</div><div className="text-xs text-gray-500">{tD}</div></td><td><div className="font-bold">{t.playerName}</div><div className="text-xs">{t.playerRating} - {t.cardType}</div>{t.note&&<div className="text-xs text-blue-300 italic">"{t.note}"</div>}</td><td className="text-center font-semibold text-red-300">{t.buyPrice.toLocaleString()}</td><td className="text-center font-semibold text-yellow-300">{t.sellTarget.toLocaleString()}</td><td className="text-center font-semibold text-cyan-300">{t.status==='sold'?t.soldPrice.toLocaleString():(t.currentPrice||t.buyPrice).toLocaleString()}</td><td className="text-center"><span className={`font-bold ${dP>=0?'text-green-400':'text-red-400'}`}>{t.status==='stock'&&(dP>=0?'+':'')+dP.toFixed(1)+'%'}</span>{t.targetReached&&t.status==='stock'&&<div className="text-xs text-green-400">üéØ!</div>}</td><td className="text-center"><span className="stat-badge">{roi.toFixed(1)}%</span></td><td className="text-center">{t.status==='stock'?<span className="pack-badge pack-in">üì¶</span>:<span className="pack-badge pack-out">‚úÖ</span>}</td><td className="text-center"><span className={`font-bold text-lg ${aP>=0?'text-green-400':'text-red-400'}`}>{aP>=0?'+':''}{aP.toLocaleString()}</span></td><td><div className="flex gap-2 justify-center">{t.status==='stock'&&<button className="text-xs px-2 py-1 bg-green-600 rounded" onClick={()=>{const p=prompt('Prix de vente:',t.sellTarget);if(p)onMarkSold(category,t.id,Number(p));}}>‚úÖ</button>}<button className="text-xs px-2 py-1 bg-blue-600 rounded" onClick={()=>{const n=prompt('Note:',t.note||'');if(n!==null)onEdit(category,t.id,{note:n});}}>‚úèÔ∏è</button><button className="text-xs px-2 py-1 bg-red-600 rounded" onClick={()=>onDelete(category,t.id)}>üóëÔ∏è</button></div></td></tr>);})}</tbody></table></div>
                    </div>
                );
            }

            function AddTradeModal({ category, players, onClose, onAdd }) {
                const [searchTerm, setSearchTerm] = useState(''); const [selectedPlayer, setSelectedPlayer] = useState(null); const [buyPrice, setBuyPrice] = useState(''); const [strategy, setStrategy] = useState('1.13'); const [customTarget, setCustomTarget] = useState(''); const [useCustom, setUseCustom] = useState(false); const [note, setNote] = useState('');
                const searchResults = useMemo(() => { if(searchTerm.length<2)return[]; return players.filter(p=>p&&p.name.toLowerCase().includes(searchTerm.toLowerCase())).slice(0,10);}, [searchTerm,players]);
                const target = useCustom?Number(customTarget)||0:Math.floor((Number(buyPrice)||0)*Number(strategy));
                const profit = target>0&&buyPrice>0?Math.floor(target*0.95-Number(buyPrice)):0;
                const roi = buyPrice>0?(profit/Number(buyPrice)*100):0;
                const handleSubmit=(e)=>{e.preventDefault();if(!selectedPlayer||!buyPrice||!target)return; onAdd({category,playerId:selectedPlayer.id,playerName:selectedPlayer.name,playerRating:selectedPlayer.rating,cardType:selectedPlayer.cardType,buyPrice:Number(buyPrice),sellTarget:target,note:note.trim()});};
                return (<div className="modal-overlay" onClick={onClose}><div className="glass-card p-8 max-w-2xl w-[95%]" onClick={e=>e.stopPropagation()}><h3 className="text-3xl font-black gradient-text mb-6">‚ûï Ajouter un {category.toUpperCase()}</h3><form onSubmit={handleSubmit} className="space-y-6">{!selectedPlayer?(<><div><label className="text-sm block mb-2">üîç Joueur</label><input className="form-input" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} required/></div>{searchResults.length>0&&<div className="space-y-2 max-h-60 overflow-y-auto">{searchResults.map(p=><div key={p.id} className="p-3 bg-gray-800 rounded cursor-pointer" onClick={()=>{setSelectedPlayer(p);const price=dayAvg(dayData(p));if(price)setBuyPrice(Math.floor(price).toString());}}><span className="font-bold">{p.name}</span>({p.rating})</div>)}</div>}</>):(<div className="p-4 bg-gray-800 rounded flex justify-between"><span>{selectedPlayer.name}</span><button type="button" className="text-red-400" onClick={()=>setSelectedPlayer(null)}>‚úï</button></div>)}<div><label className="text-sm block mb-2">üí∞ Prix d'achat</label><input type="number" className="form-input" value={buyPrice} onChange={e=>setBuyPrice(e.target.value)} required/></div><div><label className="text-sm block mb-2">üìà Strat√©gie</label><div className="flex gap-3 mb-3">{['1.13','1.16','1.20'].map(s=><button type="button" key={s} className={`flex-1 py-2 rounded ${!useCustom&&strategy===s?'bg-purple-600':'bg-gray-700'}`} onClick={()=>{setUseCustom(false);setStrategy(s);}}>√ó{s}</button>)}<button type="button" className={`flex-1 py-2 rounded ${useCustom?'bg-purple-600':'bg-gray-700'}`} onClick={()=>setUseCustom(true)}>Manuel</button></div>{useCustom&&<input type="number" className="form-input" placeholder="Cible manuelle..." value={customTarget} onChange={e=>setCustomTarget(e.target.value)}/>}</div>{buyPrice&&target>0&&<div className="glass-card p-4"><div className="space-y-2 text-sm"><div className="flex justify-between"><span>Cible:</span><span className="font-bold">{target.toLocaleString()}</span></div><div className="flex justify-between"><span>Profit net:</span><span className="font-bold text-green-400">+{profit.toLocaleString()}</span></div><div className="flex justify-between"><span>ROI:</span><span className="font-bold text-cyan-400">{roi.toFixed(1)}%</span></div></div></div>}<div><label className="text-sm block mb-2">üìù Note</label><input className="form-input" value={note} onChange={e=>setNote(e.target.value)}/></div><div className="flex gap-3"><button type="submit" className="tab-button active flex-1">‚úÖ Ajouter</button><button type="button" className="tab-button flex-1" onClick={onClose}>‚ùå Annuler</button></div></form></div></div>);
            }

            function StatsView({ getAllStats, getCategoryStats }) {
                const globalStats = getAllStats();
                const categoryComparison = ['flip', 'invest', 'specul', 'sbc'].map(cat => ({ name: cat, label: { flip: 'üî• FLIP', invest: 'üí∞ INVEST', specul: 'üéØ SP√âCUL', sbc: 'üì¶ SBC' }[cat], ...getCategoryStats(cat) }));
                return (
                    <div className="space-y-8">
                        <div className="glass-card p-6"><h3 className="text-2xl font-bold text-purple-300 mb-4">üíº CAPITAL TOTAL</h3><div className="grid md:grid-cols-5 gap-4 text-center"><div className="text-3xl font-black text-red-300">{globalStats.invested.toLocaleString()}</div><div className="text-3xl font-black text-blue-300">{globalStats.stockValue.toLocaleString()}</div><div className="text-3xl font-black text-green-300">+{globalStats.totalProfit.toLocaleString()}</div><div className="text-3xl font-black text-yellow-300">{globalStats.stockCount}</div><div className="text-3xl font-black text-cyan-300">{globalStats.soldCount}</div></div></div>
                        <div className="glass-card p-6"><h3 className="text-2xl font-bold text-cyan-300 mb-4">üìä PERFORMANCE PAR CAT√âGORIE</h3><div className="overflow-x-auto"><table className="w-full"><thead><tr className="border-b-2 border-purple-500/50"><th className="p-4 text-left">Cat√©gorie</th><th>ROI Moyen</th><th>Profit</th><th>Stock</th><th>Vendus</th></tr></thead><tbody>{categoryComparison.sort((a,b)=>b.avgROI-a.avgROI).map(cat=><tr key={cat.name} className="border-b border-white/10"><td className="p-4 font-bold text-lg">{cat.label}</td><td className="p-4 text-center"><span className="text-xl font-bold text-cyan-300">{cat.avgROI.toFixed(1)}%</span></td><td className="p-4 text-center font-bold text-green-300">+{cat.totalProfit.toLocaleString()}</td><td className="p-4 text-center text-blue-300">{cat.stockCount}</td><td className="p-4 text-center text-yellow-300">{cat.soldCount}</td></tr>)}</tbody></table></div></div>
                    </div>
                );
            }

            return (
                <div className="glass-card p-6">
                    <div className="section-header mb-6"><h2 className="text-4xl font-black gradient-text">üî¨ Trading Lab</h2></div>
                    <div className="flex flex-wrap gap-3 mb-8 justify-center">
                        {[{id:'flip',l:'üî• FLIP'},{id:'invest',l:'üí∞ INVEST'},{id:'specul',l:'üéØ SP√âCUL'},{id:'sbc',l:'üì¶ SBC'},{id:'stats',l:'üìä STATS'}].map(c=>(<button key={c.id} className={`px-6 py-3 rounded-lg font-bold text-lg ${activeCategory===c.id?'bg-purple-600 shadow-lg':'bg-gray-800'}`} onClick={()=>setActiveCategory(c.id)}>{c.l} {c.id!=='stats'&&`(${(trades[c.id]||[]).length})`}</button>))}
                    </div>
                    {activeCategory !== 'stats' ? <TradingCategory category={activeCategory} trades={trades[activeCategory]} onAdd={() => setShowAddModal(true)} onMarkSold={markAsSold} onDelete={deleteTrade} onEdit={editTrade} stats={getCategoryStats(activeCategory)}/> : <StatsView getAllStats={getAllStats} getCategoryStats={getCategoryStats} />}
                    {showAddModal && <AddTradeModal category={activeCategory} players={players} onClose={() => setShowAddModal(false)} onAdd={addTrade}/>}
                </div>
            );
        }
                /* ===== TRADE PLANS ===== */
        function TradePlans({ players, user, platform }) {
            const [plans, setPlans] = useState([]);
            const [newPlanText, setNewPlanText] = useState('');
            const [showSearch, setShowSearch] = useState(false);
            const [searchFilters, setSearchFilters] = useState({ name: '', ratingMin: '', ratingMax: '', position: '', league: '', club: '', nation: '', cardType: '', playstyle: '', playstylePlus: false });
            const [searchResults, setSearchResults] = useState([]);
            const [selectedPlayer, setSelectedPlayer] = useState(null);

            const CloudSync = {
                save: (user, platform, key, data) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error('CloudSync save error:', e);
                        return false;
                    }
                },
                load: (user, platform, key) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        const data = localStorage.getItem(storageKey);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('CloudSync load error:', e);
                        return null;
                    }
                }
            };

            useEffect(() => {
                const loadPlans = async () => {
                    if (user && platform) {
                        const data = await CloudSync.load(user, platform, 'tradeplans');
                        if (Array.isArray(data)) setPlans(data);
                    }
                };
                loadPlans();
            }, [user, platform]);

            useEffect(() => {
                if (user && platform && plans.length > 0) {
                    CloudSync.save(user, platform, 'tradeplans', plans);
                }
            }, [plans, user, platform]);
            
            const uniqueValues = useMemo(() => {
                const data = { pos: new Set(), ct: new Set(), ps: new Set() };
                players.forEach(p => {
                    if (p.positions?.main) data.pos.add(p.positions.main);
                    if (p.positions?.alternatives) p.positions.alternatives.forEach(pos => data.pos.add(pos));
                    if (p.cardType) data.ct.add(p.cardType);
                    if (p.playstyles) { Object.values(p.playstyles).forEach(cat => { if (cat.normal) cat.normal.forEach(s => data.ps.add(s)); if (cat.plus) cat.plus.forEach(s => data.ps.add(s)); }); }
                });
                return { positions: Array.from(data.pos).sort(), cardTypes: Array.from(data.ct).sort(), playstyles: Array.from(data.ps).sort() };
            }, [players]);

            const handleSearch = useCallback(() => {
                let res = players;
                if(searchFilters.name.length>=2) res=res.filter(p=>p.name&&p.name.toLowerCase().includes(searchFilters.name.toLowerCase()));
                if(searchFilters.ratingMin) res=res.filter(p=>(p.rating||0)>=Number(searchFilters.ratingMin));
                if(searchFilters.ratingMax) res=res.filter(p=>(p.rating||0)<=Number(searchFilters.ratingMax));
                if(searchFilters.position) res=res.filter(p=>[p.positions?.main,...(p.positions?.alternatives||[])].includes(searchFilters.position));
                if(searchFilters.league) res=res.filter(p=>p.info?.League===searchFilters.league);
                if(searchFilters.club) res=res.filter(p=>p.info?.Club===searchFilters.club);
                if(searchFilters.nation) res=res.filter(p=>p.info?.Nation===searchFilters.nation);
                if(searchFilters.cardType) res=res.filter(p=>p.cardType===searchFilters.cardType);
                if(searchFilters.playstyle) { res = res.filter(p=>{if(!p.playstyles)return false; const allPS=new Set(); Object.values(p.playstyles).forEach(c=>{if(!searchFilters.playstylePlus&&c.normal)c.normal.forEach(s=>allPS.add(s)); if(c.plus)c.plus.forEach(s=>allPS.add(s));}); return allPS.has(searchFilters.playstyle); }); }
                setSearchResults(res.slice(0, 50));
            }, [players, searchFilters]);

            useEffect(() => { if (showSearch) { const timer = setTimeout(() => handleSearch(), 300); return () => clearTimeout(timer); } }, [searchFilters, showSearch, handleSearch]);

            const addPlan = () => {
                if (!newPlanText.trim() && !selectedPlayer) return;
                const planText = selectedPlayer ? `${selectedPlayer.name} (${selectedPlayer.rating}) - ${newPlanText}` : newPlanText;
                setPlans(prev => [...prev, { id: Date.now(), text: planText.trim(), done: false, addedAt: Date.now() }]);
                setNewPlanText(''); setSelectedPlayer(null);
            };

            const togglePlan = (id) => setPlans(prev => prev.map(p => p.id === id ? { ...p, done: !p.done } : p));
            const deletePlan = (id) => setPlans(prev => prev.filter(p => p.id !== id));
            
            return (
                <div className="glass-card p-6">
                    <div className="section-header mb-6"><h2 className="text-4xl font-black gradient-text">üìã Trade Plans</h2></div>
                    <div className="mb-6"><button className="tab-button active" onClick={() => setShowSearch(!showSearch)}>{showSearch ? '‚ùå Fermer la recherche' : 'üîç Ouvrir la recherche'}</button></div>
                    {showSearch && <div className="glass-card p-6 mb-8"><h3 className="text-2xl font-bold text-purple-300 mb-4">üîç Recherche Avanc√©e</h3><div className="grid md:grid-cols-4 gap-4 mb-6"><input className="form-input" placeholder="Nom..." value={searchFilters.name} onChange={e=>setSearchFilters(p=>({...p,name:e.target.value}))}/> <input type="number" className="form-input" placeholder="Note Min" value={searchFilters.ratingMin} onChange={e=>setSearchFilters(p=>({...p,ratingMin:e.target.value}))}/> <input type="number" className="form-input" placeholder="Note Max" value={searchFilters.ratingMax} onChange={e=>setSearchFilters(p=>({...p,ratingMax:e.target.value}))}/> <select className="form-input" value={searchFilters.position} onChange={e=>setSearchFilters(p=>({...p,position:e.target.value}))}><option value="">Poste...</option>{uniqueValues.positions.map(pos=><option key={pos} value={pos}>{pos}</option>)}</select></div>{searchResults.length>0&&<div><h4 className="text-lg font-bold text-cyan-300 mb-3">R√©sultats ({searchResults.length})</h4><div className="space-y-2 max-h-96 overflow-y-auto">{searchResults.map(p=><div key={p.id} className={`p-3 rounded cursor-pointer ${selectedPlayer?.id===p.id?'bg-purple-900/30':'bg-gray-800'}`} onClick={()=>setSelectedPlayer(p)}><div className="flex justify-between"><span>{p.name} ({p.rating})</span><span>{dayAvg(dayData(p))?.toLocaleString()}</span></div></div>)}</div></div>}</div>}
                    {selectedPlayer && <div className="glass-card p-4 mb-6"><div className="flex justify-between items-center"><span className="font-bold text-xl text-purple-300">Joueur: {selectedPlayer.name}</span><button className="text-red-400" onClick={()=>setSelectedPlayer(null)}>‚úï</button></div></div>}
                    <div className="glass-card p-6 mb-8"><h3 className="text-xl font-bold text-green-300 mb-4">‚ûï Nouveau Plan</h3><div className="flex gap-3"><input className="form-input flex-1" placeholder={selectedPlayer?`Note sur ${selectedPlayer.name}...`:"Ex: Stocker Fodder 85+"} value={newPlanText} onChange={e=>setNewPlanText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addPlan()}/><button className="tab-button active" onClick={addPlan}>Ajouter</button></div></div>
                    <div className="space-y-3">{plans.sort((a,b)=>a.done-b.done||b.addedAt-a.addedAt).map(plan=><div key={plan.id} className={`glass-card p-5 ${plan.done?'opacity-50':''}`}><div className="flex items-start gap-4"><input type="checkbox" checked={plan.done} onChange={()=>togglePlan(plan.id)} className="w-6 h-6 mt-1"/><div className="flex-1"><p className={`text-lg ${plan.done?'line-through':''}`}>{plan.text}</p><p className="text-xs text-gray-500 mt-2">Ajout√© le {new Date(plan.addedAt).toLocaleDateString('fr-FR')}</p></div><button className="text-xs px-3 py-1 bg-red-600 rounded" onClick={()=>deletePlan(plan.id)}>üóëÔ∏è</button></div></div>)}</div>
                </div>
            );
        }

        /* ===== WATCHLIST ===== */
        function Watchlist({ players, onPlayerClick, user, platform }) {
            const [watchlist, setWatchlist] = useState([]);
            const [ideas, setIdeas] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [newIdea, setNewIdea] = useState('');

            const CloudSync = {
                save: (user, platform, key, data) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        localStorage.setItem(storageKey, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error('CloudSync save error:', e);
                        return false;
                    }
                },
                load: (user, platform, key) => {
                    try {
                        const storageKey = `fut_${user.email}_${platform}_${key}`;
                        const data = localStorage.getItem(storageKey);
                        return data ? JSON.parse(data) : null;
                    } catch (e) {
                        console.error('CloudSync load error:', e);
                        return null;
                    }
                }
            };

            useEffect(() => {
                const loadData = async () => {
                    if (user && platform) {
                        const data = await CloudSync.load(user, platform, 'watchlist');
                        if (data) {
                            setWatchlist(data.watchlist || []);
                            setIdeas(data.ideas || []);
                        }
                    }
                };
                loadData();
            }, [user, platform]);

            useEffect(() => {
                if (user && platform) {
                    CloudSync.save(user, platform, 'watchlist', { watchlist, ideas, lastUpdate: Date.now() });
                }
            }, [watchlist, ideas, user, platform]);

            useEffect(() => {
                if (players.length === 0 || watchlist.length === 0) return;
                const today = new Date().toISOString().split('T')[0];
                const updated = watchlist.map(item => {
                    const p = players.find(pl => pl.id === item.playerId);
                    if (!p) return { ...item, notFound: true };
                    const price = dayAvg(dayData(p));
                    if (!price) return { ...item, notFound: true };
                    const hasToday = item.priceHistory?.some(ph => ph.date === today);
                    const newHistory = hasToday ? item.priceHistory : [...(item.priceHistory || []), { date: today, price: Math.floor(price) }];
                    return { ...item, priceHistory: newHistory, currentPrice: Math.floor(price), notFound: false, lastUpdate: Date.now() };
                });
                setWatchlist(updated);
            }, [players]);

            const handleSearch = () => {
                if (searchTerm.length < 2) { setSearchResults([]); return; }
                setSearchResults(players.filter(p => p.name?.toLowerCase().includes(searchTerm.toLowerCase()) && !watchlist.some(w => w.playerId === p.id)).slice(0, 10));
            };
            useEffect(() => { handleSearch(); }, [searchTerm]);

            const addPlayer = (player, note = '') => {
                if (watchlist.length >= 100) { alert('Maximum 100 joueurs'); return; }
                const price = dayAvg(dayData(player));
                const newItem = { playerId: player.id, playerName: player.name, playerRating: player.rating, cardType: player.cardType, note, addedAt: Date.now(), currentPrice: price ? Math.floor(price) : null, priceHistory: price ? [{ date: new Date().toISOString().split('T')[0], price: Math.floor(price) }] : [] };
                setWatchlist(prev => [...prev, newItem]);
                setSearchTerm(''); setSearchResults([]);
            };

            const removePlayer = (id) => { if (confirm('Supprimer ?')) setWatchlist(prev => prev.filter(p => p.playerId !== id)); };
            const updateNote = (id, newNote) => { setWatchlist(prev => prev.map(w => w.playerId === id ? { ...w, note: newNote } : w)); };
            const getVariation = (item) => { if (!item.priceHistory || item.priceHistory.length < 2) return { amount: 0, percent: 0 }; const first = item.priceHistory[0].price; const last = item.priceHistory[item.priceHistory.length - 1].price; const amount = last - first; const percent = first > 0 ? (amount / first) * 100 : 0; return { amount, percent }; };
            
            const addIdea = () => { if(ideas.length>=20 || !newIdea.trim()) return; setIdeas(p=>[...p,{id:Date.now(),text:newIdea.trim(),done:false}]); setNewIdea(''); };
            const toggleIdea = (id) => setIdeas(p=>p.map(i=>i.id===id?{...i,done:!i.done}:i));
            const removeIdea = (id) => setIdeas(p=>p.filter(i=>i.id!==id));

            return (
                <div className="glass-card p-6">
                    <div className="section-header mb-6"><h2 className="text-3xl font-black gradient-text">‚≠ê Ma Watchlist</h2></div>
                    <div className="glass-card p-6 rounded-lg mb-6">
                        <h3 className="text-xl font-bold text-purple-300 mb-4">üîç Rechercher un joueur</h3>
                        <input className="form-input" placeholder="Nom du joueur..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        {searchResults.length > 0 && <div className="mt-4 space-y-2">{searchResults.map(p => <div key={p.id} className="bg-slate-800 p-4 rounded-lg flex justify-between items-center"><p>{p.name} ({p.rating})</p><button className="tab-button active" onClick={() => { const note = prompt(`Note pour ${p.name} (optionnel) :`); addPlayer(p, note || ''); }}>+ Ajouter</button></div>)}</div>}
                    </div>

                    <div className="glass-card p-6 rounded-lg mb-6">
                        <h3 className="text-xl font-bold text-purple-300 mb-4">üìå Favoris ({watchlist.length}/100)</h3>
                        <div className="space-y-6">
                            {watchlist.map((item) => {
                                const variation = getVariation(item);
                                const player = players.find(p => p.id === item.playerId);
                                const { roi, profit } = player ? calculateTradePlans(player).flip : { roi: 0, profit: 0 };
                                return (
                                    <div key={item.playerId} className="bg-slate-800/70 border border-white/10 p-5 rounded-lg">
                                        <div className="flex justify-between items-start mb-3">
                                            <div><p className="font-bold text-xl cursor-pointer" onClick={()=>onPlayerClick(player)}>{item.playerName} ({item.playerRating})</p><span className={`card-type-badge ${getCardTypeClass(item.cardType)}`}>{item.cardType}</span></div>
                                            {!item.notFound && item.currentPrice ? <div className="text-right"><p className="text-2xl font-black text-yellow-300">{item.currentPrice.toLocaleString()}</p>{variation.amount!==0&&<p className={`text-sm font-semibold ${variation.amount>0?'text-green-400':'text-red-400'}`}>{variation.amount>0?'+':''}{variation.amount.toLocaleString()} ({variation.percent.toFixed(1)}%)</p>}</div> : <div className="text-orange-400">Non trouv√©</div>}
                                        </div>
                                        {item.note && <div className="bg-blue-900/20 p-3 rounded mb-3"><p className="text-sm text-blue-200">üìù "{item.note}"</p></div>}
                                        {player && <div className="bg-purple-900/20 p-3 rounded mb-3 grid grid-cols-2 gap-2 text-sm"><div><span className="text-gray-400">ROI Flip:</span><span className="ml-2 font-bold text-cyan-300">{roi.toFixed(1)}%</span></div><div><span className="text-gray-400">Profit Flip:</span><span className="ml-2 font-bold text-green-300">+{profit.toLocaleString()}</span></div></div>}
                                        <div className="flex gap-2 mt-4">
                                            <button className="text-xs px-3 py-2 bg-gray-700 rounded" onClick={()=>{const newNote=prompt('Modifier la note:',item.note); if(newNote!==null)updateNote(item.playerId,newNote);}}>Modifier note</button>
                                            <button className="text-xs px-3 py-2 bg-red-600 rounded ml-auto" onClick={()=>removePlayer(item.playerId)}>Supprimer</button>
                                        </div>
                                    </div>
                                );
                            })}
                            {watchlist.length === 0 && <p className="text-center text-gray-500 py-12">Aucun joueur en watchlist.</p>}
                        </div>
                    </div>

                    <div className="glass-card p-6 rounded-lg">
                        <h3 className="text-xl font-bold text-yellow-300 mb-4">üí° Id√©es d'Investissement</h3>
                        <div className="mb-4 flex gap-3"><input className="form-input flex-1" placeholder="Nouvelle id√©e..." value={newIdea} onChange={e=>setNewIdea(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addIdea()}/><button className="tab-button active" onClick={addIdea}>‚ûï</button></div>
                        <div className="space-y-2">{ideas.map((idea)=><div key={idea.id} className="flex items-center gap-3 p-3 bg-slate-800/60 rounded"><input type="checkbox" checked={idea.done} onChange={()=>toggleIdea(idea.id)} className="w-5 h-5"/><span className={idea.done?'line-through text-gray-500 flex-1':'flex-1'}>{idea.text}</span><button className="text-red-400" onClick={()=>removeIdea(idea.id)}>‚úï</button></div>)}</div>
                    </div>
                </div>
            );
        }

        /* ===== CALCULATOR ===== */
        function Calculator() {
            const [buyPrice, setBuyPrice] = useState('');
            const [sellPrice, setSellPrice] = useState('');
            const [quantity, setQuantity] = useState(1);

            const results = useMemo(() => {
                const buy = Number(buyPrice) || 0;
                const sell = Number(sellPrice) || 0;
                const qty = Number(quantity) || 1;

                const totalCost = buy * qty;
                const grossRevenue = sell * qty;
                const eaTax = grossRevenue * 0.05;
                const netRevenue = grossRevenue - eaTax;
                const netProfit = netRevenue - totalCost;
                const roi = totalCost > 0 ? (netProfit / totalCost) * 100 : 0;

                return { totalCost, grossRevenue, eaTax, netRevenue, netProfit, roi };
            }, [buyPrice, sellPrice, quantity]);

            const ResultRow = ({ label, value, color, isBold = false }) => (
                <div className={`flex justify-between items-center py-3 ${isBold ? 'border-y-2 border-purple-500/50' : 'border-b border-white/10'}`}>
                    <span className="text-gray-300">{label}:</span>
                    <span className={`font-bold text-xl ${color}`}>{value}</span>
                </div>
            );

            return (
                <div className="glass-card neon-border p-8 max-w-2xl mx-auto">
                    <div className="section-header mb-6">
                        <h2 className="text-3xl font-black gradient-text">üßÆ Calculateur de Profit</h2>
                        <p className="text-gray-400 mt-2">Calculez vos profits avec la taxe EA de 5%</p>
                    </div>

                    <div className="grid md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label className="text-sm text-gray-400 mb-2 block">Prix d'Achat</label>
                            <input type="number" className="form-input text-lg" placeholder="100,000" value={buyPrice} onChange={e => setBuyPrice(e.target.value)} />
                        </div>
                        <div>
                            <label className="text-sm text-gray-400 mb-2 block">Prix de Vente</label>
                            <input type="number" className="form-input text-lg" placeholder="115,000" value={sellPrice} onChange={e => setSellPrice(e.target.value)} />
                        </div>
                        <div>
                            <label className="text-sm text-gray-400 mb-2 block">Quantit√©</label>
                            <input type="number" className="form-input text-lg" placeholder="1" min="1" value={quantity} onChange={e => setQuantity(e.target.value)} />
                        </div>
                    </div>

                    <div className="glass-card border border-purple-500/30 p-6 rounded-lg">
                        <h3 className="text-xl font-bold text-purple-300 mb-4">üìä R√©sultats</h3>
                        <div className="space-y-2">
                            <ResultRow label="Co√ªt Total" value={results.totalCost.toLocaleString()} color="text-red-300"/>
                            <ResultRow label="Revenu Brut" value={results.grossRevenue.toLocaleString()} color="text-blue-300"/>
                            <ResultRow label="Taxe EA (5%)" value={`-${Math.floor(results.eaTax).toLocaleString()}`} color="text-orange-300"/>
                            <ResultRow label="Revenu Net" value={Math.floor(results.netRevenue).toLocaleString()} color="text-green-300" isBold={true}/>
                            
                            <div className="bg-gradient-to-r from-yellow-900/30 to-green-900/30 p-4 rounded-lg mt-4">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-lg font-bold">üí∞ PROFIT NET:</span>
                                    <span className={`text-3xl font-black ${results.netProfit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                        {results.netProfit >= 0 ? '+' : ''}{Math.floor(results.netProfit).toLocaleString()}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center">
                                    <span className="text-lg font-bold">üìä ROI:</span>
                                    <span className={`text-3xl font-black ${results.roi >= 0 ? 'text-cyan-400' : 'text-red-400'}`}>
                                        {results.roi >= 0 ? '+' : ''}{results.roi.toFixed(2)}%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        /* ===== BIBLE TRADING ===== */
        function BibleTrading() {
            const Term = ({ title, description, example }) => (
                <div className="glass-card border border-purple-500/30 p-6 rounded-lg">
                    <h4 className="text-xl font-bold text-yellow-300 mb-3">{title}</h4>
                    <p className="text-gray-300 text-sm mb-2">{description}</p>
                    {example && <p className="text-xs text-gray-400">Ex: {example}</p>}
                </div>
            );

            return (
                <div className="glass-card neon-border p-8">
                    <div className="section-header mb-8">
                        <h2 className="text-4xl font-black gradient-text">üìö BIBLE DU TRADING</h2>
                        <p className="text-gray-400 mt-2 text-lg">Terminologie, Strat√©gies & Timing</p>
                    </div>

                    <div className="mb-12">
                        <h3 className="text-3xl font-bold text-purple-300 mb-6">üìñ Dictionnaire du Trader</h3>
                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <Term title="üí∞ FLIP" description="Achat et revente rapide (< 24h) pour un profit imm√©diat." example="Acheter 50k, revendre 56k = +3.2k net."/>
                            <Term title="üíé INVEST" description="Achat moyen/long terme (3-30 jours) en anticipant une hausse." example="Stocker des 84 √† 2k, revendre 4k = +1.8k net/carte."/>
                            <Term title="üéØ SNIPE" description="Achat instantan√© d'une carte list√©e bien en dessous de son prix de march√©." example="Technique de rafra√Æchissement sur un filtre pr√©cis."/>
                            <Term title="üì¶ OOP" description="Out Of Pack. Une carte qui n'est plus dans les packs, donc son offre est limit√©e et son prix a tendance √† monter." example="Les cartes sp√©ciales sont OOP apr√®s 7 jours."/>
                            <Term title="üíµ TAXE EA" description="Commission de 5% pr√©lev√©e par EA sur chaque vente." example="Profit Net = (Prix Vente √ó 0.95) - Prix Achat"/>
                            <Term title="üìä ROI" description="Return On Investment. Le pourcentage de rentabilit√© de votre trade." example="(Profit Net / Prix Achat) √ó 100"/>
                            <Term title="üî• FODDER" description="Cartes √† haute note utilis√©es principalement pour compl√©ter les SBC." example="Les 85+ montent quand un SBC Ic√¥ne sort."/>
                            <Term title="‚ö° META" description="Most Effective Tactics Available. Les joueurs les plus efficaces et populaires en jeu." example="Les joueurs rapides avec 5‚òÖ GT/MP sont souvent m√©ta."/>
                            <Term title="üìâ PANIC SELL" description="Vente massive et rapide par de nombreux joueurs, provoquant une chute brutale des prix. Un excellent moment pour acheter." example="Souvent apr√®s les r√©compenses FUT Champions."/>
                        </div>
                    </div>

                    <div className="mb-12">
                        <h3 className="text-3xl font-bold text-orange-300 mb-6">‚è∞ Timing Optimal du March√©</h3>
                        <div className="grid md:grid-cols-2 gap-6">
                            <div className="glass-card border border-green-500/30 p-6 rounded-lg">
                                <h4 className="text-xl font-bold text-green-300 mb-4">üìâ MEILLEURS MOMENTS POUR ACHETER</h4>
                                <ul className="space-y-4 text-sm text-gray-300 list-disc list-inside">
                                    <li><strong className="text-green-300">Dimanche soir √† Lundi matin:</strong> Fin de FUT Champions, les joueurs vendent leurs √©quipes. Le point le plus bas du march√©.</li>
                                    <li><strong className="text-green-300">Jeudi (apr√®s les r√©compenses):</strong> "Panic sell" massif des cartes pack√©es. Id√©al pour le sniping et les bonnes affaires.</li>
                                    <li><strong className="text-green-300">Pendant les grosses promos avec packs √©clairs:</strong> L'offre augmente massivement, faisant chuter les prix temporairement.</li>
                                </ul>
                            </div>
                            <div className="glass-card border border-red-500/30 p-6 rounded-lg">
                                <h4 className="text-xl font-bold text-red-300 mb-4">üìà MEILLEURS MOMENTS POUR VENDRE</h4>
                                <ul className="space-y-4 text-sm text-gray-300 list-disc list-inside">
                                    <li><strong className="text-red-300">Jeudi (avant les r√©compenses) √† Vendredi soir:</strong> Les joueurs ach√®tent leurs √©quipes pour FUT Champions. C'est le pic de demande.</li>
                                    <li><strong className="text-red-300">Samedi matin:</strong> Forte activit√©, beaucoup de joueurs en ligne cherchent √† finaliser leurs √©quipes.</li>
                                    <li><strong className="text-red-300">Pendant la "hype" d'un SBC:</strong> Vendre les joueurs requis (fodder, liens sp√©cifiques) juste apr√®s la sortie du SBC, quand la demande est maximale.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        /* ===== GEMS - D√âTECTEUR DE P√âPITES ULTRA INTELLIGENT (VERSION COMPL√àTE) ===== */
function Gems({ players, onRowClick }) {
    const [minBudget, setMinBudget] = useState(2000);
    const [maxBudget, setMaxBudget] = useState(50000);
    const [minRating, setMinRating] = useState(75);
    const [sortBy, setSortBy] = useState('gemScore'); // gemScore, potential

    // Calcul du GEM SCORE ultra avanc√©
    const calculateGemScore = (player) => {
        let score = 0;
        const price = dayAvg(dayData(player));
        if (!price) return 0;

        // 1. RAPPORT QUALIT√â/PRIX (30 points max)
        const valueRatio = (player.rating * 1000) / price;
        const valueScore = Math.min(30, valueRatio * 10);
        score += valueScore;

        // 2. M√âTA SCORE (25 points max)
        let metaScore = 0;
        
        // Nations populaires
        const topNations = ['France', 'Brazil', 'England', 'Spain', 'Portugal', 'Argentina'];
        if (topNations.includes(player.info?.Nation)) metaScore += 8;
        
        // Ligues populaires
        const topLeagues = ['Premier League', 'LaLiga Santander', 'Ligue 1 Uber Eats', 'Bundesliga', 'Serie A TIM'];
        if (topLeagues.includes(player.info?.League)) metaScore += 7;
        
        // Gestes techniques
        const skillMoves = player.info?.['Skill Moves'] || 0;
        if (skillMoves >= 5) metaScore += 5;
        else if (skillMoves >= 4) metaScore += 3;
        
        // Mauvais pied
        const weakFoot = player.info?.['Weak Foot'] || 0;
        if (weakFoot >= 5) metaScore += 5;
        else if (weakFoot >= 4) metaScore += 3;
        
        score += metaScore;

        // 3. STATS CL√âS (20 points max)
        const pac = player.mainStats?.PAC || 0;
        const dri = player.mainStats?.DRI || 0;
        const sho = player.mainStats?.SHO || 0;
        
        if (pac >= 90) score += 7;
        else if (pac >= 85) score += 5;
        else if (pac >= 80) score += 3;
        
        if (dri >= 90) score += 7;
        else if (dri >= 85) score += 5;
        else if (dri >= 80) score += 3;
        
        if (sho >= 85) score += 6;
        else if (sho >= 80) score += 4;

        // 4. PLAYSTYLES+ (15 points max)
        let playstylePlusCount = 0;
        if (player.playstyles) {
            Object.values(player.playstyles).forEach(cat => {
                if (cat.plus) playstylePlusCount += cat.plus.length;
            });
        }
        score += Math.min(15, playstylePlusCount * 5);

        // 5. POTENTIEL DE HAUSSE (10 points max)
        const { status } = calculatePackStatus(player);
        if (status === 'VINTAGE') score += 10;
        else if (status === 'RARE') score += 8;
        else if (status === 'RECENTLY_OUT') score += 5;

        return Math.min(100, Math.round(score));
    };

    // D√©tection de pattern de prix
    const detectPricePattern = (player) => {
        if (!player.prices) return 'STABLE';
        
        const prices = Object.values(player.prices)
            .filter(p => p && p.avg > 0)
            .map(p => p.avg)
            .slice(0, 7);
        
        if (prices.length < 3) return 'STABLE';
        
        const recent = prices.slice(0, 3);
        const older = prices.slice(3, 6);
        
        const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
        const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
        
        if (recentAvg > olderAvg * 1.10) return 'HAUSSE';
        if (recentAvg < olderAvg * 0.90) return 'BAISSE';
        return 'STABLE';
    };

    // Pr√©diction de valeur future
    const predictFutureValue = (player) => {
        const currentPrice = dayAvg(dayData(player));
        const gemScore = calculateGemScore(player);
        const pattern = detectPricePattern(player);
        
        let multiplier = 1;
        
        if (gemScore > 90) multiplier += 0.25;
        else if (gemScore > 80) multiplier += 0.18;
        else if (gemScore > 70) multiplier += 0.12;
        
        if (pattern === 'BAISSE') multiplier += 0.15; // Opportunit√© d'achat
        else if (pattern === 'HAUSSE') multiplier += 0.05;
        
        const { status } = calculatePackStatus(player);
        if (status === 'VINTAGE') multiplier += 0.30;
        else if (status === 'RARE') multiplier += 0.20;
        
        return Math.floor(currentPrice * multiplier);
    };

    const gems = useMemo(() => {
        return players
            .filter(p => {
                const price = dayAvg(dayData(p));
                // Budget MIN et MAX
                if (!price || price < minBudget || price > maxBudget) return false;
                if ((p.rating || 0) < minRating) return false;
                return true;
            })
            .map(p => {
                const price = dayAvg(dayData(p));
                const gemScore = calculateGemScore(p);
                const pattern = detectPricePattern(p);
                const futureValue = predictFutureValue(p);
                const potentialProfit = futureValue - price;
                const potentialROI = price > 0 ? (potentialProfit / price) * 100 : 0;
                
                // Cat√©gorie de p√©pite
                let gemCategory = 'STANDARD';
                if (gemScore > 85 && potentialROI > 20) gemCategory = 'DIAMANT';
                else if (gemScore > 75 && potentialROI > 15) gemCategory = 'OR';
                else if (gemScore > 65 && potentialROI > 10) gemCategory = 'ARGENT';
                else if (gemScore > 55) gemCategory = 'BRONZE';
                
                // Recommandation IA
                let aiRecommendation = '';
                if (gemCategory === 'DIAMANT' && pattern === 'BAISSE') {
                    aiRecommendation = 'üî• ACHETER MASSIVEMENT ! P√©pite exceptionnelle en promo !';
                } else if (gemCategory === 'DIAMANT') {
                    aiRecommendation = 'üíé EXCELLENT INVESTISSEMENT ! Achetez avant la hausse !';
                } else if (gemCategory === 'OR' && pattern === 'BAISSE') {
                    aiRecommendation = '‚≠ê TR√àS BONNE OPPORTUNIT√â ! Prix attractif.';
                } else if (gemCategory === 'OR') {
                    aiRecommendation = '‚úÖ BON ACHAT. Potentiel solide.';
                } else if (gemCategory === 'ARGENT') {
                    aiRecommendation = 'üëç CORRECT. Bon rapport qualit√©/prix.';
                } else {
                    aiRecommendation = '‚ö†Ô∏è OPTION VIABLE mais il y a mieux.';
                }
                
                return {
                    ...p,
                    price,
                    gemScore,
                    pattern,
                    futureValue,
                    potentialProfit,
                    potentialROI,
                    gemCategory,
                    aiRecommendation
                };
            })
            .filter(p => p.gemScore > 40)
            .sort((a, b) => {
                if (sortBy === 'gemScore') return b.gemScore - a.gemScore;
                if (sortBy === 'potential') return b.potentialROI - a.potentialROI;
                return b.gemScore - a.gemScore;
            })
            .slice(0, 50);
    }, [players, minBudget, maxBudget, minRating, sortBy]);

    const GemCard = ({ gem, rank }) => {
        const categoryStyles = {
            'DIAMANT': { bg: 'from-cyan-600 to-blue-600', icon: 'üíé', label: 'DIAMANT' },
            'OR': { bg: 'from-yellow-600 to-orange-600', icon: 'ü•á', label: 'OR' },
            'ARGENT': { bg: 'from-gray-400 to-gray-600', icon: 'ü•à', label: 'ARGENT' },
            'BRONZE': { bg: 'from-amber-700 to-amber-900', icon: 'ü•â', label: 'BRONZE' },
            'STANDARD': { bg: 'from-gray-600 to-gray-800', icon: '‚ö™', label: 'STANDARD' }
        };

        const patternStyles = {
            'HAUSSE': { icon: 'üìà', color: 'text-green-400', label: 'En hausse' },
            'BAISSE': { icon: 'üìâ', color: 'text-red-400', label: 'En baisse' },
            'STABLE': { icon: '‚û°Ô∏è', color: 'text-blue-400', label: 'Stable' }
        };

        const style = categoryStyles[gem.gemCategory];
        const patternStyle = patternStyles[gem.pattern];

        return (
            <div className="glass-card neon-border p-6 hover:scale-105 transition-all cursor-pointer" onClick={() => onRowClick(gem)}>
                {/* Header */}
                <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center gap-3">
                        <div className={`text-4xl font-black bg-gradient-to-r ${style.bg} bg-clip-text text-transparent`}>
                            #{rank}
                        </div>
                        <div>
                            <h3 className="text-xl font-bold">{gem.name}</h3>
                            <div className="flex items-center gap-2 mt-1">
                                <span className="stat-badge">{gem.rating}</span>
                                <span className={`card-type-badge ${getCardTypeClass(gem.cardType)}`}>{gem.cardType}</span>
                                {getPackStatusBadge(gem)}
                            </div>
                        </div>
                    </div>
                    <div className="text-right">
                        <div className="text-3xl mb-1">{style.icon}</div>
                        <div className={`text-xs font-bold px-3 py-1 rounded bg-gradient-to-r ${style.bg}`}>
                            {style.label}
                        </div>
                    </div>
                </div>

                {/* Score et Pattern */}
                <div className="grid grid-cols-2 gap-4 mb-4">
                    <div className="bg-gradient-to-br from-purple-900/30 to-purple-700/30 p-4 rounded-lg border border-purple-500/30">
                        <div className="text-xs text-purple-300 mb-1">üéØ GEM SCORE</div>
                        <div className="text-3xl font-black text-purple-400">{gem.gemScore}</div>
                        <div className="text-xs text-gray-400 mt-1">/100</div>
                    </div>
                    <div className="bg-gradient-to-br from-blue-900/30 to-blue-700/30 p-4 rounded-lg border border-blue-500/30">
                        <div className="text-xs text-blue-300 mb-1">{patternStyle.icon} TENDANCE</div>
                        <div className={`text-xl font-bold ${patternStyle.color}`}>{patternStyle.label}</div>
                        <div className="text-xs text-gray-400 mt-1">7 derniers jours</div>
                    </div>
                </div>

                {/* Prix et Pr√©diction */}
                <div className="bg-gradient-to-r from-green-900/20 to-blue-900/20 p-4 rounded-lg border border-green-500/30 mb-4">
                    <div className="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div className="text-xs text-gray-400">Prix Actuel</div>
                            <div className="text-lg font-bold text-yellow-400">{gem.price.toLocaleString()}</div>
                        </div>
                        <div>
                            <div className="text-xs text-gray-400">Valeur Future</div>
                            <div className="text-lg font-bold text-green-400">{gem.futureValue.toLocaleString()}</div>
                        </div>
                        <div>
                            <div className="text-xs text-gray-400">Profit Estim√©</div>
                            <div className="text-lg font-bold text-cyan-400">+{gem.potentialProfit.toLocaleString()}</div>
                        </div>
                    </div>
                    <div className="text-center mt-2 pt-2 border-t border-white/10">
                        <div className="text-xs text-gray-400">ROI Potentiel</div>
                        <div className="text-2xl font-black text-purple-400">+{gem.potentialROI.toFixed(1)}%</div>
                    </div>
                </div>

                {/* Stats cl√©s */}
                <div className="grid grid-cols-3 gap-2 mb-4 text-xs">
                    {gem.mainStats?.PAC && (
                        <div className="p-2 rounded bg-red-900/30 border border-red-500/30 text-center">
                            <div className="text-red-300 font-bold">{gem.mainStats.PAC}</div>
                            <div className="text-gray-400">PAC</div>
                        </div>
                    )}
                    {gem.mainStats?.DRI && (
                        <div className="p-2 rounded bg-yellow-900/30 border border-yellow-500/30 text-center">
                            <div className="text-yellow-300 font-bold">{gem.mainStats.DRI}</div>
                            <div className="text-gray-400">DRI</div>
                        </div>
                    )}
                    {gem.mainStats?.SHO && (
                        <div className="p-2 rounded bg-green-900/30 border border-green-500/30 text-center">
                            <div className="text-green-300 font-bold">{gem.mainStats.SHO}</div>
                            <div className="text-gray-400">SHO</div>
                        </div>
                    )}
                </div>

                {/* Recommandation IA */}
                <div className={`p-4 rounded-lg border-2 ${
                    gem.gemCategory === 'DIAMANT' ? 'bg-cyan-900/20 border-cyan-500/50' :
                    gem.gemCategory === 'OR' ? 'bg-yellow-900/20 border-yellow-500/50' :
                    'bg-blue-900/20 border-blue-500/30'
                }`}>
                    <div className="text-xs text-gray-400 mb-2">ü§ñ RECOMMANDATION IA</div>
                    <div className="text-sm font-bold">{gem.aiRecommendation}</div>
                </div>
            </div>
        );
    };

    return (
        <div className="glass-card neon-border p-6">
            <div className="section-header mb-6">
                <h2 className="text-4xl font-black gradient-text">üíé D√âTECTEUR DE P√âPITES - IA ULTRA</h2>
                <p className="text-gray-400 mt-2">Analyse pr√©dictive avanc√©e pour d√©tecter les futures stars</p>
            </div>

            {/* Contr√¥les */}
            <div className="glass-card p-6 mb-6 bg-gradient-to-r from-purple-900/30 to-pink-900/30">
                <div className="grid md:grid-cols-2 gap-6 mb-6">
                    {/* Budget Minimum */}
                    <div>
                        <label className="text-sm text-gray-300 mb-2 block flex justify-between">
                            <span>üí∞ Budget MINIMUM</span>
                            <span className="text-lg font-bold text-green-300">{minBudget.toLocaleString()}</span>
                        </label>
                        <input 
                            type="range" 
                            min="1000" 
                            max="500000" 
                            step="1000"
                            value={minBudget} 
                            onChange={e => setMinBudget(Number(e.target.value))}
                            className="w-full"
                        />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1k</span>
                            <span>250k</span>
                            <span>500k</span>
                        </div>
                    </div>

                    {/* Budget Maximum */}
                    <div>
                        <label className="text-sm text-gray-300 mb-2 block flex justify-between">
                            <span>üíé Budget MAXIMUM</span>
                            <span className="text-lg font-bold text-yellow-300">{maxBudget.toLocaleString()}</span>
                        </label>
                        <input 
                            type="range" 
                            min="5000" 
                            max="1000000" 
                            step="5000"
                            value={maxBudget} 
                            onChange={e => setMaxBudget(Number(e.target.value))}
                            className="w-full"
                        />
                        <div className="flex justify-between text-xs text-gray-500 mt-1">
                            <span>5k</span>
                            <span>500k</span>
                            <span>1M</span>
                        </div>
                    </div>
                </div>

                <div className="grid md:grid-cols-3 gap-4">
                    {/* Note Minimum */}
                    <div>
                        <label className="text-sm text-gray-300 mb-2 block flex justify-between">
                            <span>‚≠ê Note Minimum</span>
                            <span className="text-lg font-bold text-yellow-300">{minRating}</span>
                        </label>
                        <input 
                            type="range" 
                            min="70" 
                            max="90" 
                            step="1"
                            value={minRating} 
                            onChange={e => setMinRating(Number(e.target.value))}
                            className="w-full"
                        />
                    </div>

                    {/* Tri */}
                    <div>
                        <label className="text-sm text-gray-300 mb-2 block">üìä Trier par</label>
                        <select 
                            className="form-input w-full"
                            value={sortBy}
                            onChange={e => setSortBy(e.target.value)}
                        >
                            <option value="gemScore">üéØ Score P√©pite</option>
                            <option value="potential">üìà Potentiel ROI</option>
                        </select>
                    </div>

                    {/* Stats */}
                    <div className="flex items-end">
                        <div className="w-full text-center p-3 bg-purple-900/30 rounded-lg border border-purple-500/30">
                            <div className="text-xs text-gray-400">P√©pites trouv√©es</div>
                            <div className="text-3xl font-black text-purple-400">{gems.length}</div>
                        </div>
                    </div>
                </div>

                {/* Indicateur de fourchette */}
                                    <div className="text-center text-sm text-gray-400 mt-4">
                        Recherche de p√©pites entre 
                        <span className="font-bold text-green-300 mx-1">{minBudget.toLocaleString()}</span> et 
                        <span className="font-bold text-yellow-300 mx-1">{maxBudget.toLocaleString()}</span>
                    </div>
                </div>

                {/* L√©gende */}
                <div className="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                    <div className="glass-card p-3 text-center bg-gradient-to-r from-cyan-600/20 to-blue-600/20 border border-cyan-500/30">
                        <div className="text-2xl mb-1">üíé</div>
                        <div className="text-xs font-bold">DIAMANT</div>
                        <div className="text-xs text-gray-400">Score 85+</div>
                    </div>
                    <div className="glass-card p-3 text-center bg-gradient-to-r from-yellow-600/20 to-orange-600/20 border border-yellow-500/30">
                        <div className="text-2xl mb-1">ü•á</div>
                        <div className="text-xs font-bold">OR</div>
                        <div className="text-xs text-gray-400">Score 75-84</div>
                    </div>
                    <div className="glass-card p-3 text-center bg-gradient-to-r from-gray-400/20 to-gray-600/20 border border-gray-400/30">
                        <div className="text-2xl mb-1">ü•à</div>
                        <div className="text-xs font-bold">ARGENT</div>
                        <div className="text-xs text-gray-400">Score 65-74</div>
                    </div>
                    <div className="glass-card p-3 text-center bg-gradient-to-r from-amber-700/20 to-amber-900/20 border border-amber-500/30">
                        <div className="text-2xl mb-1">ü•â</div>
                        <div className="text-xs font-bold">BRONZE</div>
                        <div className="text-xs text-gray-400">Score 55-64</div>
                    </div>
                    <div className="glass-card p-3 text-center bg-gradient-to-r from-gray-600/20 to-gray-800/20 border border-gray-500/30">
                        <div className="text-2xl mb-1">‚ö™</div>
                        <div className="text-xs font-bold">STANDARD</div>
                        <div className="text-xs text-gray-400">Score {'<'}55</div>
                    </div>
                </div>

                {/* Grille de p√©pites */}
                {gems.length > 0 ? (
                    <div className="grid md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {gems.map((gem, idx) => (
                            <GemCard key={gem.id} gem={gem} rank={idx + 1} />
                        ))}
                    </div>
                ) : (
                    <div className="text-center py-20">
                        <div className="text-6xl mb-4">üíé</div>
                        <p className="text-2xl text-gray-400">Aucune p√©pite trouv√©e avec ces crit√®res</p>
                        <p className="text-gray-500 mt-2">Essayez d'augmenter le budget ou de baisser la note minimum</p>
                    </div>
                )}
            </div>
        );
    }

        /* ===== MARKET CLOCK BADGE ===== */
        function MarketClockBadge({ players }) {
            const [currentTime, setCurrentTime] = useState(new Date());
            const [showDetails, setShowDetails] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const marketStatus = getMarketStatus();
            
            const opportunityCount = useMemo(() => {
                if (!marketStatus.opportunities || !players || players.length === 0) return 0;
                return players.filter(p => {
                    const oppScore = calculateOpportunityScore(p);
                    const vol = volDay(p);
                    return oppScore >= 60 && vol >= 10;
                }).length;
            }, [players, marketStatus.opportunities, currentTime]);

            return (
                <>
                    <div 
                        className={`fixed top-24 right-6 z-40 ${marketStatus.color} text-white px-4 py-3 rounded-lg shadow-2xl cursor-pointer transform transition-all hover:scale-105 ${marketStatus.pulse ? 'animate-pulse' : ''}`}
                        onClick={() => setShowDetails(!showDetails)}
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-3xl">{marketStatus.icon}</span>
                            <div>
                                <div className="font-black text-sm uppercase tracking-wide">{marketStatus.status}</div>
                                <div className="text-xs font-bold opacity-90">{marketStatus.action}</div>
                            </div>
                        </div>
                        {marketStatus.opportunities && opportunityCount > 0 && (
                            <div className="mt-2 text-xs font-black border-t border-white/30 pt-2 flex items-center gap-1">
                                <span className="text-lg">üíé</span>
                                <span>{opportunityCount} opportunit√©s</span>
                            </div>
                        )}
                    </div>

                    {showDetails && (
                        <div 
                            className="fixed top-48 right-6 z-50 glass-card p-6 w-96 shadow-2xl border-2 border-purple-500/50 animate-fadeIn"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="text-2xl font-black gradient-text">‚è∞ Horloge du March√©</h3>
                                <button 
                                    onClick={() => setShowDetails(false)} 
                                    className="text-3xl text-gray-400 hover:text-white transition-colors"
                                >
                                    √ó
                                </button>
                            </div>

                            <div className={`${marketStatus.color} text-white p-4 rounded-lg mb-4`}>
                                <div className="flex items-center gap-3 mb-3">
                                    <span className="text-4xl">{marketStatus.icon}</span>
                                    <div>
                                        <div className="font-black text-xl">{marketStatus.status}</div>
                                        <div className="text-sm font-bold">{marketStatus.action}</div>
                                    </div>
                                </div>
                                <div className="text-sm border-t border-white/30 pt-2">
                                    üìä {marketStatus.reason}
                                </div>
                                <div className="text-sm mt-2 italic opacity-90">
                                    üí¨ "{marketStatus.funPhrase}"
                                </div>
                            </div>

                            {marketStatus.opportunities && opportunityCount > 0 && (
                                <div className="bg-green-900/30 border-2 border-green-500/50 p-4 rounded-lg mb-4 animate-pulse">
                                    <div className="font-black text-green-300 mb-2 text-lg flex items-center gap-2">
                                        <span className="text-2xl">üíé</span>
                                        OPPORTUNIT√âS D√âTECT√âES
                                    </div>
                                    <div className="text-4xl font-black text-green-400 mb-1">{opportunityCount}</div>
                                    <div className="text-xs text-gray-300">Cartes avec volatilit√© ‚â•10% et score ‚â•60</div>
                                </div>
                            )}

                            <div className="space-y-3 text-sm">
                                <div className="glass-card p-3 flex justify-between items-center">
                                    <span className="text-gray-400">Intensit√©</span>
                                    <span className="font-black text-lg">
                                        {marketStatus.intensity === 'extreme' && 'üî•üî•üî• EXTR√äME'}
                                        {marketStatus.intensity === 'high' && 'üî•üî• HAUTE'}
                                        {marketStatus.intensity === 'medium' && 'üî• MOYENNE'}
                                        {marketStatus.intensity === 'low' && '‚ö™ FAIBLE'}
                                    </span>
                                </div>
                                <div className="glass-card p-3 flex justify-between items-center">
                                    <span className="text-gray-400">Heure actuelle</span>
                                    <span className="font-bold text-cyan-300 text-lg">
                                        {currentTime.toLocaleTimeString('fr-FR')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        }

        /* ===== ALERTS SYSTEM ===== */
        function AlertsSystem() {
            const [alerts, setAlerts] = useState([]);
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                    checkAlerts();
                }, 60000);

                checkAlerts();

                return () => clearInterval(timer);
            }, []);

            const checkAlerts = () => {
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const newAlerts = [];

                if (day === 5 && hour === 18 && minute >= 30) {
                    newAlerts.push({
                        id: 'promo-30min',
                        type: 'warning',
                        icon: 'üö®',
                        title: 'PROMO DANS 30 MINUTES',
                        message: 'Vendez vos cartes MAINTENANT avant le crash !',
                        action: 'Aller au Trading Desk',
                        priority: 'high'
                    });
                }

                if (day === 6 && hour >= 10 && hour <= 20 && minute < 5) {
                    newAlerts.push({
                        id: 'weekend-sell',
                        type: 'success',
                        icon: 'üí∞',
                        title: 'PRIME TIME VENTE ACTIF',
                        message: 'Weekend League en cours ‚Üí Vendez vos cartes !',
                        action: 'Voir mes stocks',
                        priority: 'medium'
                    });
                }

                if (day === 4 && hour === 7 && minute < 5) {
                    newAlerts.push({
                        id: 'rewards-2h',
                        type: 'info',
                        icon: '‚è∞',
                        title: 'REWARDS DANS 2H',
                        message: 'Pr√©parez votre budget pour le crash imminent !',
                        action: 'Dashboard',
                        priority: 'medium'
                    });
                }

                if (day === 4 && hour >= 9 && hour < 10 && minute < 5) {
                    newAlerts.push({
                        id: 'rewards-crash',
                        type: 'success',
                        icon: 'üö®',
                        title: 'CRASH REWARDS EN COURS',
                        message: 'C\'est LE moment d\'acheter massivement !',
                        action: 'Voir opportunit√©s',
                        priority: 'high'
                    });
                }

                if (day === 0 && hour >= 20 && hour < 23 && minute < 5) {
                    newAlerts.push({
                        id: 'futchamps-crash',
                        type: 'success',
                        icon: 'üèÜ',
                        title: 'FIN FUT CHAMPS - CRASH',
                        message: 'Les prix s\'effondrent ‚Üí Achetez tout !',
                        action: 'Dashboard',
                        priority: 'high'
                    });
                }

                if (hour >= 2 && hour < 4 && minute < 5) {
                    newAlerts.push({
                        id: 'night-snipe',
                        type: 'info',
                        icon: 'üåô',
                        title: 'HEURES CREUSES',
                        message: 'March√© endormi ‚Üí Prix tr√®s bas !',
                        action: 'Sniper Pro',
                        priority: 'low'
                    });
                }

                setAlerts(newAlerts);
            };

            const dismissAlert = (id) => {
                setAlerts(prev => prev.filter(a => a.id !== id));
            };

            if (alerts.length === 0) return null;

            return (
                <div className="fixed bottom-6 right-6 z-50 space-y-3 max-w-sm">
                    {alerts.map(alert => (
                        <div 
                            key={alert.id}
                            className={`glass-card p-4 border-2 animate-slideIn ${
                                alert.type === 'success' ? 'border-green-500/50 bg-green-900/20' :
                                alert.type === 'warning' ? 'border-orange-500/50 bg-orange-900/20' :
                                'border-blue-500/50 bg-blue-900/20'
                            }`}
                        >
                            <div className="flex items-start gap-3">
                                <span className="text-3xl">{alert.icon}</span>
                                <div className="flex-1">
                                    <h4 className="font-black text-sm mb-1">{alert.title}</h4>
                                    <p className="text-xs text-gray-300 mb-2">{alert.message}</p>
                                    <button className="text-xs font-bold text-purple-300 hover:text-purple-200">
                                        ‚Üí {alert.action}
                                    </button>
                                </div>
                                <button 
                                    onClick={() => dismissAlert(alert.id)}
                                    className="text-gray-400 hover:text-white text-xl"
                                >
                                    √ó
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
                /* ===== AUTH SCREEN - √âCRAN DE CONNEXION ===== */
        function AuthScreen({ onAuthenticated }) {
            const [pseudo, setPseudo] = useState('');
            const [premiumCode, setPremiumCode] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const VALID_PREMIUM_CODE = "premium";

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!pseudo.trim()) {
                    alert('Entre ton pseudo !');
                    return;
                }

                setIsLoading(true);

                setTimeout(() => {
                    const isPremiumUser = premiumCode.trim().toLowerCase() === VALID_PREMIUM_CODE;

                    const user = {
                        name: pseudo.trim(),
                        email: `${pseudo.toLowerCase().replace(/\s/g, '')}@futpro.com`,
                        isPremium: isPremiumUser,
                    };

                    onAuthenticated(user);
                }, 500);
            };

            return (
                <div className="auth-container">
                    <div className="glass-card neon-border p-8 max-w-md w-full">
                        <div className="text-center mb-8">
                            <h1 className="text-5xl font-black gradient-text mb-3">FUT TRADING</h1>
                            <h2 className="text-3xl font-bold text-purple-300 mb-2">ELITE PRO</h2>
                            <p className="text-gray-400">Ultimate Trading Platform</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="text-sm text-gray-400 mb-2 block">
                                    üë§ Pseudo
                                </label>
                                <input 
                                    type="text" 
                                    className="form-input text-center text-lg font-bold" 
                                    placeholder="Ton pseudo de trader"
                                    value={pseudo}
                                    onChange={e => setPseudo(e.target.value)}
                                    maxLength={20}
                                    required
                                    disabled={isLoading}
                                />
                            </div>

                            <div>
                                <label className="text-sm text-gray-400 mb-2 block">
                                    üîë Code Premium (optionnel)
                                </label>
                                <input 
                                    type="password" 
                                    className="form-input text-center" 
                                    placeholder="Entre ton code premium"
                                    value={premiumCode}
                                    onChange={e => setPremiumCode(e.target.value)}
                                    disabled={isLoading}
                                />
                            </div>

                            <button 
                                type="submit" 
                                className={`tab-button active w-full text-xl py-4 ${isLoading ? 'opacity-50' : ''}`}
                                disabled={isLoading}
                            >
                                {isLoading ? '‚è≥ Connexion...' : 'üöÄ ENTRER'}
                            </button>
                        </form>

                        <div className="mt-6 p-4 bg-gradient-to-r from-yellow-900/20 to-orange-900/20 border border-yellow-500/30 rounded-lg">
                            <p className="text-sm text-center text-yellow-300">
                                üëë <strong>PREMIUM</strong> = Acc√®s complet √† tous les outils
                            </p>
                            <p className="text-xs text-center text-gray-400 mt-2">
                                Pour obtenir un code premium, contacte un mod√©rateur
                            </p>
                        </div>

                        <div className="mt-4 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                            <p className="text-xs text-center text-blue-300">
                                üÜì <strong>VERSION GRATUITE</strong> : Trading Desk + Calculateur + Bible
                            </p>
                        </div>

                        <div className="mt-6 text-center">
                            <p className="text-xs text-gray-500">
                                üí¨ Contact mod√©rateur : 
                                <span className="text-purple-300 font-bold"> Discord/Telegram</span>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        /* ===== DYNAMIC HEADER - VERSION FUN AVEC 24 PHRASES ===== */
        function DynamicHeader({ user, platform, onPlatformSwitch, players }) {
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const getFunPhrase = () => {
                const pseudo = user.name;
                const hour = currentTime.getHours();
                
                const funPhrases = [
                    `üåô Minuit ${pseudo} ! T'es encore l√† ? Respect !`,
                    `ü¶â 1h du mat ${pseudo} ! Les hiboux font les meilleurs traders !`,
                    `üëª 2h ${pseudo} ! C'est l'heure des fant√¥mes... et des profits !`,
                    `‚≠ê 3h ${pseudo} ! Les √©toiles veillent sur tes trades !`,
                    `üåå 4h ${pseudo} ! Tu dors jamais ou quoi ?`,
                    `üåÖ 5h ${pseudo} ! Le monde appartient aux l√®ve-t√¥t !`,
                    `‚òï 6h ${pseudo} ! Caf√© first, profits after !`,
                    `üåû 7h ${pseudo} ! Belle journ√©e pour devenir riche !`,
                    `üí™ 8h ${pseudo} ! Let's gooo champion !`,
                    `üöÄ 9h ${pseudo} ! To the moon baby !`,
                    `üî• 10h ${pseudo} ! Tu chauffes fort ce matin !`,
                    `‚ö° 11h ${pseudo} ! Mi-journ√©e, mi-millionnaire !`,
                    `üçï Midi ${pseudo} ! Pizza ou profits ? Pourquoi pas les deux !`,
                    `üòé 13h ${pseudo} ! Sieste ou snipe ? Tu connais la r√©ponse !`,
                    `üíé 14h ${pseudo} ! L'apr√®s-midi des champions !`,
                    `üéØ 15h ${pseudo} ! Focus mode : ON !`,
                    `üèÜ 16h ${pseudo} ! Go√ªter time... mais d'abord un flip !`,
                    `üåá 17h ${pseudo} ! Golden hour = profit hour !`,
                    `üéÆ 18h ${pseudo} ! Ap√©ro trading, meilleur combo !`,
                    `üçî 19h ${pseudo} ! D√Æner peut attendre, pas les profits !`,
                    `üì∫ 20h ${pseudo} ! Netflix ou Trading ? Easy choice !`,
                    `üåÉ 21h ${pseudo} ! La nuit commence, les profits aussi !`,
                    `ü¶æ 22h ${pseudo} ! Encore en forme ? Machine !`,
                    `üò¥ 23h ${pseudo} ! Dernier trade avant dodo ?`
                ];

                return funPhrases[hour];
            };

            const getPremiumTimeLeft = () => {
                const premiumEndDate = new Date();
                premiumEndDate.setDate(premiumEndDate.getDate() + 30);
                const diffTime = premiumEndDate - currentTime;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor((diffTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                return { days: diffDays, hours: diffHours };
            };

            const formatTime = () => {
                return currentTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            };

            const formatDate = () => {
                return currentTime.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            };

            const premiumTime = getPremiumTimeLeft();

            return (
                <div className="dynamic-header mb-8">
                    <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                        <div>
                            <h1 className="text-4xl font-black gradient-text mb-2">
                                ‚ö° FUT TRADING ELITE PRO
                            </h1>
                            <p className="text-gray-400">
                                Connect√© en tant que <strong className="text-purple-300">{user.name}</strong>
                                {user.isPremium && <span className="ml-2 px-3 py-1 bg-gradient-to-r from-yellow-600 to-yellow-500 text-black text-xs font-black rounded-full">üëë PREMIUM</span>}
                            </p>
                        </div>

                        <div className="platform-switch flex gap-2">
                            <button 
                                className={`px-6 py-3 rounded-lg font-bold ${platform === 'console' ? 'active' : 'bg-gray-700'}`}
                                onClick={() => onPlatformSwitch('console')}
                            >
                                üéÆ CONSOLE
                            </button>
                            <button 
                                className={`px-6 py-3 rounded-lg font-bold ${platform === 'pc' ? 'active' : 'bg-gray-700'}`}
                                onClick={() => onPlatformSwitch('pc')}
                            >
                                üíª PC
                            </button>
                        </div>
                    </div>

                    <div className="glass-card p-6 border border-purple-500/30">
                        <div className="grid md:grid-cols-3 gap-4 items-center">
                            <div className="text-center">
                                <div className="text-3xl font-black text-cyan-300">{formatTime()}</div>
                                <div className="text-sm text-gray-400 capitalize mt-1">{formatDate()}</div>
                            </div>
                            
                            <div className="text-center">
                                <div className="text-xl font-bold text-yellow-300 italic px-4">
                                    {getFunPhrase()}
                                </div>
                            </div>
                            
                            {user.isPremium && (
                                <div className="text-center">
                                    <div className="text-2xl font-black text-yellow-400">
                                        üëë {premiumTime.days}j {premiumTime.hours}h
                                    </div>
                                    <div className="text-sm text-gray-400 mt-1">Premium restant</div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        /* ===== PREMIUM LOCK - √âCRAN DE VERROUILLAGE PREMIUM ===== */
function PremiumLock({ onBack }) {
    return (
        <div className="premium-lock-overlay">
            <div className="text-center max-w-4xl mx-auto">
                <div className="text-8xl mb-6">üîí</div>
                <h2 className="text-5xl font-black gradient-text mb-4">
                    Fonctionnalit√© Premium
                </h2>
                <p className="text-xl text-gray-300 mb-8">
                    D√©bloquez tout le potentiel de FUT Trading Elite Pro !
                </p>
                
                <div className="glass-card p-8 mb-8">
                    <h3 className="text-3xl font-bold text-yellow-300 mb-6">
                        üöÄ Pourquoi passer Premium ?
                    </h3>
                    <div className="grid md:grid-cols-2 gap-6 text-left">
                        <div className="p-4 bg-purple-900/20 rounded-lg border border-purple-500/30">
                            <h4 className="text-xl font-bold text-purple-300 mb-3">üí∞ Rentabilis√© en 1 jour</h4>
                            <p className="text-gray-300">
                                Les membres Premium font en moyenne +500k de profit d√®s le premier jour !
                            </p>
                        </div>
                        <div className="p-4 bg-green-900/20 rounded-lg border border-green-500/30">
                            <h4 className="text-xl font-bold text-green-300 mb-3">üìà ROI moyen : 2000%</h4>
                            <p className="text-gray-300">
                                Multiplie tes profits x20 gr√¢ce aux outils exclusifs
                            </p>
                        </div>
                        <div className="p-4 bg-blue-900/20 rounded-lg border border-blue-500/30">
                            <h4 className="text-xl font-bold text-blue-300 mb-3">‚ö° Gain de temps : 90%</h4>
                            <p className="text-gray-300">
                                Analyses automatiques = plus de temps pour trader
                            </p>
                        </div>
                        <div className="p-4 bg-yellow-900/20 rounded-lg border border-yellow-500/30">
                            <h4 className="text-xl font-bold text-yellow-300 mb-3">üéØ Pr√©cision maximale</h4>
                            <p className="text-gray-300">
                                Algorithmes IA pour ne jamais rater une opportunit√©
                            </p>
                        </div>
                    </div>
                </div>

                <div className="glass-card p-6 mb-8 bg-gradient-to-r from-yellow-900/30 to-orange-900/30">
                    <h3 className="text-2xl font-bold text-yellow-300 mb-4">
                        üíé Offre Premium - 1 MOIS
                    </h3>
                    <p className="text-3xl font-black text-white mb-4">
                        Acc√®s COMPLET √† tous les outils
                    </p>
                    <p className="text-lg text-gray-300 mb-4">
                        Dashboard + Sniper + Comparateur + √âvolutions + Leaks + P√©pites + Lab + Plans + Watchlist
                    </p>
                    <div className="mt-6 p-4 bg-black/30 rounded-lg">
                        <p className="text-xl text-yellow-300 font-bold">
                            üëë Pour obtenir ton code Premium
                        </p>
                        <p className="text-lg text-white mt-2">
                            Contacte un mod√©rateur sur Discord/Telegram
                        </p>
                    </div>
                </div>

                <button 
                    className="tab-button active text-xl px-8 py-4 mt-8"
                    onClick={onBack}
                >
                    ‚¨ÖÔ∏è Retour
                </button>
            </div>
        </div>
    );
}

        /* ===== MAIN APP - APPLICATION PRINCIPALE ===== */
function App() {
    const [user, setUser] = useState(null);
    const [currentPlatform, setCurrentPlatform] = useState('console');
    const [players, setPlayers] = useState([]);
    const [activeTab, setActiveTab] = useState('dashboard');
    const [notif, setNotif] = useState([]);
    const [modalPlayer, setModalPlayer] = useState(null);

    useEffect(() => {
        if (!user) return;
        const loadData = async () => {
            const dataFile = currentPlatform === 'console' ? 'data-console.json' : 'data-pc.json';
            addNotif(`Chargement des donn√©es ${currentPlatform}...`, 'info');
            try {
                const response = await fetch(`./${dataFile}`);
                if (!response.ok) throw new Error(`Fichier ${dataFile} introuvable`);
                const data = await response.json();
                if (Array.isArray(data)) {
                    setPlayers(data);
                    addNotif(`‚úÖ ${data.length} joueurs charg√©s`, 'success');
                    
                    // ‚ú® NOUVEAU : V√©rification automatique des pr√©dictions Kronos
                    setTimeout(() => {
                        KronosMemory.verifyPredictions(user, currentPlatform, data);
                        addNotif(`üß† Kronos v√©rifie ses pr√©dictions...`, 'info');
                    }, 2000);
                } else {
                    addNotif(`‚ùå Format JSON invalide`, 'error');
                }
            } catch (e) {
                addNotif(e.message, 'error');
            }
        };
        loadData();
    }, [user, currentPlatform]);

    const addNotif = (msg, type = 'info') => {
        const id = Date.now();
        setNotif(n => [...n.slice(-4), { id, msg, type }]);
        setTimeout(() => setNotif(n => n.filter(x => x.id !== id)), 4000);
    };

    const tabs = [
        { id: 'dashboard', label: 'üìä Dashboard', premium: true },
        { id: 'tradingdesk', label: 'üí∞ Trading Desk', premium: false },
        { id: 'sniper', label: 'üéØ Sniper Pro', premium: true },
        { id: 'comparator', label: '‚öñÔ∏è Comparateur', premium: true },
        { id: 'evolution', label: 'üß¨ √âvolutions', premium: true },
        { id: 'leak', label: 'üîç Leaks', premium: true },
        { id: 'gems', label: 'üíé P√©pites', premium: true },
        { id: 'tradinglab', label: 'üî¨ Trading Lab', premium: true },
        { id: 'tradeplans', label: 'üìã Trade Plans', premium: true },
        { id: 'watchlist', label: '‚≠ê Watchlist', premium: true },
        { id: 'calculator', label: 'üßÆ Calculateur', premium: false },
        { id: 'faq', label: 'üìö Bible', premium: false }
    ];

    const availableTabs = user?.isPremium ? tabs : tabs.filter(t => !t.premium);

    useEffect(() => {
        if (user && !availableTabs.some(t => t.id === activeTab)) {
            setActiveTab(user.isPremium ? 'dashboard' : 'tradingdesk');
        }
    }, [user, availableTabs, activeTab]);

    if (!user) {
        return <AuthScreen onAuthenticated={setUser} />;
    }

    const currentTab = tabs.find(t => t.id === activeTab);
    const isTabLocked = currentTab?.premium && !user.isPremium;

    const handlePlayerClick = (player) => {
        if (player) {
            setModalPlayer(player);
        }
    };

    return (
        <div className="p-6 max-w-[1900px] mx-auto">
            {notif.length > 0 && (
                <div className="fixed top-6 right-6 space-y-3 z-50">
                    {notif.map(n => (
                        <div 
                            key={n.id} 
                            className={`glass-card px-5 py-4 border-l-4 ${
                                n.type==='success'?'border-green-500 bg-green-900/20':
                                n.type==='error'?'border-red-500 bg-red-900/20':
                                'border-blue-500 bg-blue-900/20'
                            }`}
                        >
                            {n.msg}
                        </div>
                    ))}
                </div>
            )}

            <MarketClockBadge players={players} />
            <AlertsSystem />
            
            <DynamicHeader 
                user={user} 
                platform={currentPlatform} 
                onPlatformSwitch={setCurrentPlatform} 
                players={players} 
            />
            
            <nav className="flex flex-wrap justify-center gap-3 mb-10">
                {availableTabs.map(t => (
                    <button 
                        key={t.id} 
                        className={`tab-button ${activeTab === t.id ? 'active' : ''}`} 
                        onClick={() => setActiveTab(t.id)}
                    >
                        {t.label}
                    </button>
                ))}
                <button 
                    className="tab-button" 
                    style={{background: 'linear-gradient(135deg, #ef4444, #dc2626)'}} 
                    onClick={() => { 
                        if (confirm('Se d√©connecter ?')) { 
                            setUser(null); 
                            setPlayers([]); 
                        } 
                    }}
                >
                    üö™ D√©connexion
                </button>
            </nav>

            {isTabLocked ? (
                <PremiumLock onBack={() => setActiveTab(user.isPremium ? 'dashboard' : 'tradingdesk')} />
            ) : (
                <>
                    {/* ‚ú® MODIFI√â : Ajout de user et platform */}
                    {activeTab === 'dashboard' && <KronosConsciousnessDashboard players={players} onPlayerClick={handlePlayerClick} user={user} platform={currentPlatform} />} 
                    {activeTab === 'tradingdesk' && <TradingDesk players={players} onRowClick={handlePlayerClick} user={user} platform={currentPlatform} />}
                    {activeTab === 'sniper' && <SniperPro players={players} onRowClick={handlePlayerClick} />}
                    {activeTab === 'comparator' && <Comparator players={players} onPlayerClick={handlePlayerClick} />}
                    {activeTab === 'evolution' && <EvolutionAnalyzer players={players} onPlayerClick={handlePlayerClick} />}
                    {activeTab === 'leak' && <LeakAnalyzer players={players} />}
                    {activeTab === 'gems' && <Gems players={players} onRowClick={handlePlayerClick} />}
                    {activeTab === 'tradinglab' && <TradingLab players={players} user={user} platform={currentPlatform} />}
                    {activeTab === 'tradeplans' && <TradePlans players={players} user={user} platform={currentPlatform} />}
                    {activeTab === 'watchlist' && <Watchlist players={players} onPlayerClick={handlePlayerClick} user={user} platform={currentPlatform} />}
                    {activeTab === 'calculator' && <Calculator />}
                    {activeTab === 'faq' && <BibleTrading />}
                </>
            )}
            
                                               {modalPlayer && <PlayerModal player={modalPlayer} onClose={() => setModalPlayer(null)} />}
        </div>
    );
}

/* ===== RENDU FINAL DE L'APPLICATION ===== */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>